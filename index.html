<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Furniture Inventory Manager</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- Modern Typography -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Rich, warm color palette */
            --bg-primary: #0f0f0f;
            --bg-secondary: #1a1a1a;
            --bg-card: #242424;
            --bg-card-hover: #2d2d2d;
            --bg-elevated: #333333;
            
            /* Accent colors - Warm amber/gold */
            --accent-primary: #f59e0b;
            --accent-secondary: #d97706;
            --accent-glow: rgba(245, 158, 11, 0.3);
            
            /* Status colors */
            --success: #10b981;
            --success-bg: rgba(16, 185, 129, 0.15);
            --warning: #f59e0b;
            --warning-bg: rgba(245, 158, 11, 0.15);
            --danger: #ef4444;
            --danger-bg: rgba(239, 68, 68, 0.15);
            --info: #06b6d4;
            --info-bg: rgba(6, 182, 212, 0.15);
            
            /* Text colors */
            --text-primary: #fafafa;
            --text-secondary: #a3a3a3;
            --text-muted: #737373;
            
            /* Borders */
            --border-subtle: rgba(255, 255, 255, 0.08);
            --border-default: rgba(255, 255, 255, 0.12);
            
            /* Shadows */
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.3);
            --shadow-md: 0 8px 24px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 16px 48px rgba(0, 0, 0, 0.5);
            --shadow-glow: 0 0 40px var(--accent-glow);
            
            /* Transitions */
            --transition-fast: 0.15s ease;
            --transition-normal: 0.25s ease;
            --transition-slow: 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            
            /* Border radius */
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 24px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Plus Jakarta Sans', system-ui, -apple-system, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 16px;
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Animated background pattern */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(ellipse 80% 50% at 50% -20%, rgba(245, 158, 11, 0.15), transparent),
                radial-gradient(ellipse 60% 40% at 100% 100%, rgba(245, 158, 11, 0.08), transparent);
            pointer-events: none;
            z-index: 0;
        }

        @media (max-width: 768px) {
            body {
                padding: 8px;
            }
        }

        /* ==================== LOGIN SCREEN ==================== */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            position: relative;
            z-index: 1;
        }

        .login-card {
            background: var(--bg-card);
            border: 1px solid var(--border-default);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-lg);
            padding: 48px 40px;
            max-width: 420px;
            width: 100%;
            text-align: center;
            position: relative;
            overflow: hidden;
            animation: slideUp 0.6s var(--transition-slow);
        }

        .login-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @media (max-width: 768px) {
            .login-card {
                padding: 36px 24px;
                margin: 10px;
                border-radius: var(--radius-lg);
            }
        }

        .login-header {
            margin-bottom: 36px;
        }

        .login-header h1 {
            font-family: 'Outfit', sans-serif;
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
            letter-spacing: -0.02em;
        }

        .login-header p {
            color: var(--text-secondary);
            font-size: 0.95rem;
        }

        .user-selection {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 28px;
        }

        .user-option {
            padding: 20px;
            border: 2px solid var(--border-default);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all var(--transition-normal);
            background: var(--bg-secondary);
            text-align: left;
        }

        .user-option:hover {
            border-color: var(--accent-primary);
            background: var(--bg-elevated);
            transform: translateY(-2px);
        }

        .user-option.selected {
            border-color: var(--accent-primary);
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            box-shadow: var(--shadow-glow);
        }

        .user-option.selected h3,
        .user-option.selected p {
            color: var(--bg-primary);
        }

        .user-option h3 {
            font-family: 'Outfit', sans-serif;
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 4px;
            color: var(--text-primary);
        }

        .user-option p {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .login-actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        .btn-login {
            flex: 1;
            padding: 16px 24px;
            border: none;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-family: 'Plus Jakarta Sans', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            transition: all var(--transition-normal);
        }

        .btn-login-primary {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: var(--bg-primary);
        }

        .btn-login-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: var(--shadow-glow);
        }

        .btn-login-primary:disabled {
            background: var(--bg-elevated);
            color: var(--text-muted);
            cursor: not-allowed;
        }

        /* ==================== HEADER BUTTONS ==================== */
        .logout-btn-header {
            background: transparent;
            border: 1px solid var(--border-default);
            color: var(--text-primary);
            padding: 10px 20px;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-weight: 500;
            transition: all var(--transition-normal);
        }

        .logout-btn-header:hover {
            background: rgba(255, 255, 255, 0.1) !important;
            border-color: var(--text-secondary) !important;
        }

        .btn-delivery {
            background: linear-gradient(135deg, var(--success), #059669);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-family: 'Plus Jakarta Sans', sans-serif;
            font-weight: 600;
            transition: all var(--transition-normal);
            font-size: 0.95rem;
        }

        .btn-delivery:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(16, 185, 129, 0.3);
        }

        /* ==================== DELIVERY MODAL ==================== */
        .delivery-modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            overflow-y: auto;
        }

        .delivery-modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .delivery-modal-content {
            background: var(--bg-card);
            border: 1px solid var(--border-default);
            border-radius: var(--radius-lg);
            padding: 32px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
            animation: slideUp 0.4s var(--transition-slow);
        }

        .delivery-form-group {
            margin-bottom: 24px;
        }

        .delivery-form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .delivery-form-group input[type="text"],
        .delivery-form-group input[type="date"],
        .delivery-form-group textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border-default);
            border-radius: var(--radius-sm);
            font-size: 1rem;
            font-family: inherit;
            background: var(--bg-secondary);
            color: var(--text-primary);
            transition: border-color var(--transition-fast);
        }

        .delivery-form-group input:focus,
        .delivery-form-group textarea:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        .delivery-form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .delivery-checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 12px;
        }

        .delivery-checkbox-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .delivery-checkbox-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: var(--accent-primary);
        }

        .delivery-checkbox-item label {
            color: var(--text-secondary);
            cursor: pointer;
        }

        .delivery-radio-group {
            display: flex;
            gap: 24px;
            margin-top: 12px;
        }

        .delivery-radio-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .delivery-radio-item input[type="radio"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: var(--accent-primary);
        }

        .delivery-radio-item label {
            color: var(--text-secondary);
            cursor: pointer;
        }

        @media (max-width: 768px) {
            .delivery-modal-content {
                padding: 24px;
                width: 95%;
            }

            .delivery-radio-group {
                flex-direction: column;
                gap: 12px;
            }
        }

        /* Hidden div for generating delivery form image */
        #deliveryFormPreview {
            position: absolute;
            left: -9999px;
            top: 0;
            width: 800px;
            background: white;
            padding: 40px;
            font-family: 'Plus Jakarta Sans', sans-serif;
            color: #1a1a1a;
            box-sizing: border-box;
        }

        #deliveryFormPreview h1 {
            font-family: 'Outfit', sans-serif;
            font-size: 28px;
            font-weight: bold;
            text-align: center;
            margin-bottom: 10px;
            color: #1a1a1a;
        }

        #deliveryFormPreview hr {
            border: none;
            border-top: 2px solid #1a1a1a;
            margin-bottom: 30px;
        }

        #deliveryFormPreview .preview-field {
            margin-bottom: 20px;
            line-height: 1.6;
        }

        #deliveryFormPreview .preview-label {
            font-weight: bold;
            display: inline-block;
            min-width: 200px;
            margin-right: 10px;
            vertical-align: top;
        }

        #deliveryFormPreview .preview-value {
            display: inline-block;
            max-width: 500px;
            word-wrap: break-word;
        }

        #deliveryFormPreview .preview-footer {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #ddd;
            font-size: 12px;
            font-style: italic;
            color: #666;
        }

        .hidden {
            display: none !important;
        }

        /* ==================== SEARCH BAR ==================== */
        .search-container {
            margin-bottom: 20px;
        }

        .search-box {
            display: flex;
            align-items: center;
            background: var(--bg-card);
            border: 2px solid var(--border-default);
            border-radius: var(--radius-md);
            padding: 12px 16px;
            transition: all var(--transition-normal);
        }

        .search-box:focus-within {
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px var(--accent-glow);
        }

        .search-icon {
            font-size: 1.2em;
            margin-right: 12px;
            opacity: 0.6;
        }

        .search-input {
            flex: 1;
            background: transparent;
            border: none;
            outline: none;
            font-size: 1rem;
            color: var(--text-primary);
            font-family: inherit;
        }

        .search-input::placeholder {
            color: var(--text-muted);
        }

        .search-clear {
            background: var(--bg-elevated);
            border: none;
            color: var(--text-secondary);
            width: 28px;
            height: 28px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9em;
            transition: all var(--transition-fast);
            margin-left: 8px;
        }

        .search-clear:hover {
            background: var(--danger);
            color: white;
        }

        .search-results-info {
            color: var(--text-secondary);
            font-size: 0.9em;
            margin-top: 10px;
            padding-left: 4px;
        }

        @media (max-width: 480px) {
            .search-box {
                padding: 10px 14px;
            }

            .search-input {
                font-size: 0.95rem;
            }

            .search-input::placeholder {
                font-size: 0.85rem;
            }
        }

        /* ==================== INVENTORY GRID LAYOUT ==================== */
        .inventory-list {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
        }

        @media (max-width: 768px) {
            .inventory-list {
                grid-template-columns: repeat(3, 1fr);
                gap: 10px;
            }
        }

        @media (max-width: 480px) {
            .inventory-list {
                grid-template-columns: repeat(3, 1fr);
                gap: 8px;
            }
            
            .inventory-list-item {
                padding: 8px;
            }
            
            .inventory-list-item h3 {
                font-size: 0.75em;
                margin-bottom: 4px;
            }
            
            .inventory-list-item .status-badge {
                font-size: 0.6em;
                padding: 2px 6px;
            }
        }

        .inventory-list-item {
            display: flex;
            flex-direction: column;
            padding: 16px;
            background: var(--bg-card);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-sm);
            cursor: pointer;
            transition: all var(--transition-normal);
            border-left: 4px solid var(--warning);
            position: relative;
        }

        .inventory-list-item:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-md);
        }

        .inventory-list-item.status-ready-border {
            border-left-color: var(--success);
        }

        .inventory-list-item.status-sold-border {
            border-left-color: var(--text-muted);
        }

        .inventory-list-item.status-needs-work-border {
            border-left-color: var(--warning);
        }

        /* Item card elements */
        .item-photo-container {
            width: 100%;
            height: 160px;
            margin-bottom: 12px;
            border-radius: 8px;
            overflow: hidden;
        }

        .item-photo {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .item-no-photo {
            width: 100%;
            height: 100%;
            background: var(--bg-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            font-size: 2.5em;
        }

        .item-status {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: 600;
            text-transform: uppercase;
            align-self: flex-start;
            margin-bottom: 8px;
        }

        .item-name {
            margin: 0 0 8px 0;
            font-size: 1.1em;
            color: var(--text-primary);
            font-weight: 600;
            line-height: 1.3;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        .item-number {
            color: var(--text-secondary);
            font-size: 0.85em;
            margin-bottom: 6px;
        }

        .item-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: auto;
            padding-top: 8px;
            border-top: 1px solid var(--border-subtle);
        }

        .item-price {
            color: var(--accent-primary);
            font-size: 1em;
            font-weight: 600;
        }

        .item-date {
            color: var(--text-muted);
            font-size: 0.8em;
        }

        /* Tablet adjustments */
        @media (max-width: 768px) {
            .item-photo-container {
                height: 120px;
                margin-bottom: 8px;
            }

            .item-name {
                font-size: 0.95em;
            }

            .item-status {
                padding: 3px 8px;
                font-size: 0.65em;
                margin-bottom: 6px;
            }

            .item-number {
                font-size: 0.75em;
            }

            .item-price {
                font-size: 0.9em;
            }

            .item-date {
                font-size: 0.7em;
            }
        }

        /* Mobile-specific card adjustments for 3-column layout */
        @media (max-width: 480px) {
            .inventory-list-item {
                padding: 6px;
                border-left-width: 3px;
                border-radius: 6px;
            }

            .item-photo-container {
                height: 70px;
                margin-bottom: 6px;
                border-radius: 4px;
            }

            .item-no-photo {
                font-size: 1.5em;
            }

            .item-status {
                padding: 2px 5px;
                font-size: 0.5em;
                margin-bottom: 4px;
                border-radius: 8px;
            }

            .item-name {
                font-size: 0.7em;
                margin-bottom: 4px;
                -webkit-line-clamp: 2;
            }

            .item-number {
                font-size: 0.6em;
                margin-bottom: 4px;
            }

            .item-footer {
                padding-top: 4px;
                flex-direction: column;
                align-items: flex-start;
                gap: 2px;
            }

            .item-price {
                font-size: 0.75em;
            }

            .item-date {
                font-size: 0.55em;
            }
        }

        /* ==================== HISTORY ENTRIES ==================== */
        .history-entry {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-md);
            padding: 20px;
            margin-bottom: 12px;
            border-left: 4px solid var(--info);
            transition: all var(--transition-normal);
        }

        .history-entry:hover {
            transform: translateX(4px);
            background: var(--bg-card-hover);
        }

        .history-entry.add {
            border-left-color: var(--success);
        }

        .history-entry.edit {
            border-left-color: var(--warning);
        }

        .history-entry.delete {
            border-left-color: var(--danger);
        }

        .history-entry.status {
            border-left-color: var(--info);
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .history-action {
            font-family: 'Outfit', sans-serif;
            font-weight: 600;
            font-size: 1rem;
            color: var(--text-primary);
        }

        .history-timestamp {
            font-size: 0.8rem;
            color: var(--text-muted);
            font-weight: 500;
        }

        .history-user {
            font-size: 0.85rem;
            color: var(--accent-primary);
            font-weight: 600;
            margin-bottom: 6px;
        }

        .history-details {
            color: var(--text-secondary);
            font-size: 0.9rem;
            line-height: 1.5;
        }

        .history-item-name {
            font-weight: 600;
            color: var(--text-primary);
        }

        .history-changes {
            margin-top: 10px;
            padding: 12px;
            background: var(--bg-secondary);
            border-radius: var(--radius-sm);
            font-size: 0.85rem;
        }

        .change-item {
            margin: 4px 0;
        }

        .change-old {
            color: var(--danger);
            text-decoration: line-through;
        }

        .change-new {
            color: var(--success);
            font-weight: 600;
        }

        .empty-history {
            text-align: center;
            padding: 80px 20px;
            color: var(--text-muted);
        }

        .empty-history h3 {
            font-family: 'Outfit', sans-serif;
            font-size: 1.3rem;
            margin-bottom: 8px;
            color: var(--text-secondary);
        }

        /* ==================== MAIN CONTAINER ==================== */
        .container {
            max-width: 1440px;
            margin: 0 auto;
            background: var(--bg-secondary);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-lg);
            overflow: hidden;
            position: relative;
            z-index: 1;
        }

        @media (max-width: 768px) {
            .container {
                border-radius: var(--radius-lg);
                margin: 0;
            }
        }

        /* ==================== HEADER ==================== */
        .header {
            background: linear-gradient(135deg, var(--bg-card) 0%, var(--bg-elevated) 100%);
            color: var(--text-primary);
            padding: 28px 32px;
            position: relative;
            border-bottom: 1px solid var(--border-default);
        }

        .header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, var(--accent-primary), transparent 50%);
        }

        .header h1 {
            font-family: 'Outfit', sans-serif;
            font-size: 1.75rem;
            font-weight: 700;
            letter-spacing: -0.02em;
        }

        .header h1 span:first-child {
            color: var(--accent-primary);
            font-weight: 300;
        }

        .header p {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        @media (max-width: 768px) {
            .header {
                padding: 20px 16px;
            }
            
            .header h1 {
                font-size: 1.4rem;
            }
            
            .header p {
                font-size: 0.85rem;
            }
            
            .header > div {
                flex-direction: column;
                gap: 16px;
                align-items: flex-start !important;
            }
            
            .header > div > div:last-child {
                align-self: stretch;
                gap: 8px;
                flex-wrap: wrap;
            }
            
            .btn-delivery {
                padding: 10px 16px !important;
                font-size: 0.85rem !important;
                flex: 1;
            }
            
            .logout-btn-header {
                padding: 10px 16px !important;
                font-size: 0.85rem !important;
            }
        }

        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.25rem;
            }
            
            .header > div > div:last-child {
                flex-direction: column;
                width: 100%;
            }
            
            .btn-delivery {
                width: 100%;
            }
        }

        /* ==================== TABS NAVIGATION ==================== */
        .tabs {
            display: flex;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border-default);
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }

        .tabs::-webkit-scrollbar {
            display: none;
        }

        .tab {
            flex: 1;
            padding: 18px 16px;
            text-align: center;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all var(--transition-normal);
            border: none;
            background: transparent;
            white-space: nowrap;
            min-width: 120px;
            flex-shrink: 0;
            color: var(--text-secondary);
            position: relative;
        }

        @media (max-width: 768px) {
            .tab {
                padding: 14px 12px;
                font-size: 0.8rem;
                min-width: 100px;
            }
        }

        @media (max-width: 480px) {
            .tab {
                padding: 12px 8px;
                font-size: 0.75rem;
                min-width: 85px;
            }
        }

        .tab:hover {
            background: var(--bg-elevated);
            color: var(--text-primary);
        }

        .tab.active {
            background: var(--bg-secondary);
            color: var(--accent-primary);
            font-weight: 600;
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 40%;
            height: 3px;
            background: var(--accent-primary);
            border-radius: 3px 3px 0 0;
        }

        .tab-content {
            display: none;
            padding: 32px;
            animation: fadeIn 0.3s ease;
        }

        .tab-content.active {
            display: block;
        }

        @media (max-width: 768px) {
            .tab-content {
                padding: 20px 16px;
            }
        }

        @media (max-width: 480px) {
            .tab-content {
                padding: 16px 12px;
            }
        }

        /* ==================== BUTTONS ==================== */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-family: 'Plus Jakarta Sans', sans-serif;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all var(--transition-normal);
            text-transform: none;
            letter-spacing: 0;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: var(--bg-primary);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(245, 158, 11, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success), #059669);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(16, 185, 129, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger), #dc2626);
            color: white;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(239, 68, 68, 0.3);
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning), #d97706);
            color: var(--bg-primary);
        }

        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(245, 158, 11, 0.3);
        }

        /* ==================== ADD ITEM SECTION ==================== */
        .add-item-section {
            background: var(--bg-card);
            padding: 28px;
            border-radius: var(--radius-lg);
            margin-bottom: 32px;
            border: 1px solid var(--border-subtle);
            position: relative;
        }

        .add-item-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            width: 4px;
            background: var(--accent-primary);
            border-radius: var(--radius-lg) 0 0 var(--radius-lg);
        }

        .add-item-section h2 {
            font-family: 'Outfit', sans-serif;
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 24px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 24px;
            margin-bottom: 24px;
        }

        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .add-item-section {
                padding: 20px;
                margin-bottom: 24px;
            }
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 14px 16px;
            border: 2px solid var(--border-default);
            border-radius: var(--radius-sm);
            font-size: 0.95rem;
            font-family: inherit;
            background: var(--bg-secondary);
            color: var(--text-primary);
            transition: all var(--transition-fast);
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.1);
        }

        .form-group select {
            cursor: pointer;
        }

        .form-group select option {
            background: var(--bg-card);
            color: var(--text-primary);
        }

        /* ==================== INVENTORY GRID ==================== */
        .inventory-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 24px;
        }

        @media (max-width: 768px) {
            .inventory-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }
        }

        .inventory-card {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-lg);
            overflow: hidden;
            transition: all var(--transition-normal);
        }

        .inventory-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-md);
            border-color: var(--border-default);
        }

        .item-image {
            width: 100%;
            height: 220px;
            object-fit: cover;
            background: var(--bg-secondary);
        }

        .item-details {
            padding: 20px;
        }

        .item-name {
            font-family: 'Outfit', sans-serif;
            font-size: 1.15rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 12px;
        }

        .item-info {
            margin-bottom: 8px;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .item-info strong {
            color: var(--text-primary);
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            margin: 12px 0;
        }

        .status-ready {
            background: var(--success-bg);
            color: var(--success);
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .status-needs-work {
            background: var(--warning-bg);
            color: var(--warning);
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        .status-sold {
            background: var(--info-bg);
            color: var(--info);
            border: 1px solid rgba(6, 182, 212, 0.3);
        }

        .item-actions {
            display: flex;
            gap: 10px;
            margin-top: 16px;
        }

        .item-actions button {
            flex: 1;
            padding: 10px;
            font-size: 0.85rem;
        }

        /* ==================== STATISTICS GRID ==================== */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 16px;
                margin-bottom: 24px;
            }
        }

        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }
        }

        .stat-card {
            background: var(--bg-card);
            color: var(--text-primary);
            padding: 24px;
            border-radius: var(--radius-lg);
            text-align: center;
            border: 1px solid var(--border-subtle);
            transition: all var(--transition-normal);
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--info);
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-md);
        }

        .stat-card.blue {
            border-color: rgba(6, 182, 212, 0.3);
        }

        .stat-card.blue::before {
            background: var(--info);
        }

        .stat-card.green {
            border-color: rgba(16, 185, 129, 0.3);
        }

        .stat-card.green::before {
            background: var(--success);
        }

        .stat-card.red {
            border-color: rgba(239, 68, 68, 0.3);
        }

        .stat-card.red::before {
            background: var(--danger);
        }

        .stat-card.orange {
            border-color: rgba(245, 158, 11, 0.3);
        }

        .stat-card.orange::before {
            background: var(--accent-primary);
        }

        .stat-value {
            font-family: 'Outfit', sans-serif;
            font-size: 2.25rem;
            font-weight: 700;
            margin-bottom: 8px;
            letter-spacing: -0.02em;
        }

        .stat-card.blue .stat-value { color: var(--info); }
        .stat-card.green .stat-value { color: var(--success); }
        .stat-card.red .stat-value { color: var(--danger); }
        .stat-card.orange .stat-value { color: var(--accent-primary); }

        .stat-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        @media (max-width: 768px) {
            .stat-card {
                padding: 20px;
            }
            
            .stat-value {
                font-size: 1.75rem;
            }
            
            .stat-label {
                font-size: 0.8rem;
            }
        }

        /* ==================== TABLES ==================== */
        .details-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 24px;
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            overflow: hidden;
            border: 1px solid var(--border-subtle);
        }

        @media (max-width: 768px) {
            .details-table {
                font-size: 0.85rem;
            }
        }

        .details-table thead {
            background: var(--bg-elevated);
        }

        .details-table th {
            padding: 16px 20px;
            text-align: left;
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .details-table td {
            padding: 16px 20px;
            text-align: left;
            color: var(--text-primary);
            border-top: 1px solid var(--border-subtle);
        }

        .details-table tbody tr {
            transition: background var(--transition-fast);
        }

        .details-table tbody tr:hover {
            background: var(--bg-card-hover);
        }

        /* ==================== MODALS ==================== */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background: var(--bg-card);
            border: 1px solid var(--border-default);
            padding: 32px;
            border-radius: var(--radius-lg);
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
            animation: slideUp 0.4s var(--transition-slow);
        }

        @media (max-width: 768px) {
            .modal-content {
                padding: 24px;
                width: 95%;
                max-height: 85vh;
            }
        }

        .modal-header {
            font-family: 'Outfit', sans-serif;
            font-size: 1.35rem;
            font-weight: 600;
            margin-bottom: 24px;
            color: var(--text-primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* ==================== FULL VIEW MODAL MOBILE STYLES ==================== */
        .full-view-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        @media (max-width: 768px) {
            .full-view-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }
        }

        .full-view-photos-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
        }

        @media (max-width: 480px) {
            .full-view-photos-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .full-view-work-photos-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 8px;
        }

        @media (max-width: 480px) {
            .full-view-work-photos-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .full-view-info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        @media (max-width: 480px) {
            .full-view-info-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }
        }

        .full-view-section-title {
            margin-bottom: 15px;
            font-size: 1.1em;
            color: var(--text-primary);
        }

        .full-view-info-box {
            background: var(--bg-secondary);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        @media (max-width: 480px) {
            .full-view-info-box {
                padding: 15px;
            }
        }

        .full-view-info-item {
            margin-bottom: 8px;
        }

        .full-view-info-item strong {
            display: block;
            color: var(--text-secondary);
            font-size: 0.85em;
            margin-bottom: 4px;
        }

        .full-view-info-item span {
            color: var(--text-primary);
            font-weight: 600;
        }

        .full-view-sale-box {
            background: rgba(16, 185, 129, 0.1);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid rgba(16, 185, 129, 0.2);
        }

        @media (max-width: 480px) {
            .full-view-sale-box {
                padding: 15px;
            }
        }

        .full-view-profit-box {
            padding: 15px;
            border-radius: 6px;
            margin-top: 15px;
            text-align: center;
        }

        .full-view-profit-box.positive {
            background: rgba(16, 185, 129, 0.15);
            border-left: 4px solid var(--success);
        }

        .full-view-profit-box.negative {
            background: rgba(239, 68, 68, 0.15);
            border-left: 4px solid var(--danger);
        }

        .full-view-desc-box {
            background: var(--bg-secondary);
            padding: 15px;
            border-radius: 6px;
            border: 1px solid var(--border-subtle);
            color: var(--text-secondary);
            line-height: 1.6;
            word-wrap: break-word;
        }

        .full-view-work-notes {
            background: rgba(245, 158, 11, 0.1);
            padding: 15px;
            border-radius: 6px;
            border: 1px solid rgba(245, 158, 11, 0.2);
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .full-view-modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            justify-content: flex-end;
            flex-wrap: wrap;
        }

        @media (max-width: 480px) {
            .full-view-modal-buttons {
                flex-direction: column;
            }
            .full-view-modal-buttons .btn {
                width: 100%;
                justify-content: center;
            }
        }

        .no-photo-placeholder {
            text-align: center;
            padding: 40px 20px;
            background: var(--bg-secondary);
            border-radius: 8px;
            color: var(--text-muted);
        }

        .no-photo-placeholder .icon {
            font-size: 3em;
            margin-bottom: 10px;
        }

        .photo-thumbnail {
            position: relative;
            cursor: pointer;
            border-radius: 8px;
            overflow: hidden;
        }

        .photo-thumbnail img {
            width: 100%;
            height: 120px;
            object-fit: cover;
            display: block;
        }

        .photo-thumbnail .photo-number {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75em;
        }

        .work-photo-thumbnail img {
            height: 100px;
            border: 2px solid var(--warning);
        }

        .image-preview {
            width: 100%;
            max-height: 200px;
            object-fit: contain;
            margin-top: 12px;
            border-radius: var(--radius-sm);
            background: var(--bg-secondary);
        }

        /* ==================== EMPTY STATE ==================== */
        .empty-state {
            text-align: center;
            padding: 80px 20px;
            color: var(--text-muted);
        }

        .empty-state h3 {
            font-family: 'Outfit', sans-serif;
            font-size: 1.3rem;
            margin-bottom: 8px;
            color: var(--text-secondary);
        }

        /* ==================== MONTH CARDS ==================== */
        .month-card {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-md);
            padding: 20px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all var(--transition-normal);
        }

        .month-card:hover {
            border-color: var(--accent-primary);
            transform: translateX(4px);
        }

        .month-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .month-title {
            font-family: 'Outfit', sans-serif;
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .month-stats {
            display: flex;
            gap: 24px;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .month-details {
            display: none;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--border-subtle);
        }

        .month-details.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .month-items-list {
            display: grid;
            gap: 8px;
        }

        .month-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 16px;
            background: var(--bg-secondary);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
        }

        .expand-icon {
            transition: transform var(--transition-normal);
            color: var(--text-muted);
        }

        .expand-icon.rotated {
            transform: rotate(180deg);
        }

        /* ==================== PHOTO GALLERY ==================== */
        .photo-gallery {
            position: relative;
            width: 100%;
            height: 220px;
            overflow: hidden;
            background: var(--bg-secondary);
        }

        .photo-gallery img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            cursor: pointer;
            transition: transform var(--transition-slow);
        }

        .photo-gallery:hover img {
            transform: scale(1.05);
        }

        .photo-counter {
            position: absolute;
            bottom: 12px;
            right: 12px;
            background: rgba(0, 0, 0, 0.75);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            backdrop-filter: blur(4px);
        }

        /* ==================== WORK NOTES ==================== */
        .work-notes-box {
            background: var(--warning-bg);
            border-left: 4px solid var(--warning);
            padding: 16px;
            margin: 12px 0;
            border-radius: var(--radius-sm);
        }

        .work-notes-box strong {
            color: var(--warning);
            display: block;
            margin-bottom: 6px;
            font-size: 0.85rem;
        }

        .work-notes-box p {
            color: var(--text-secondary);
            margin: 0;
            white-space: pre-wrap;
            font-size: 0.9rem;
        }

        /* ==================== REORDER BUTTONS ==================== */
        .reorderable-item {
            position: relative;
        }
        
        .reorder-buttons {
            position: absolute;
            top: 12px;
            right: 12px;
            display: flex;
            flex-direction: column;
            gap: 4px;
            opacity: 0;
            transition: opacity var(--transition-normal);
        }
        
        .reorderable-item:hover .reorder-buttons {
            opacity: 1;
        }
        
        @media (max-width: 768px) {
            .reorder-buttons {
                opacity: 1;
            }
        }
        
        .reorder-btn {
            background: var(--accent-primary);
            color: var(--bg-primary);
            border: none;
            border-radius: var(--radius-sm);
            width: 28px;
            height: 24px;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-fast);
        }
        
        @media (max-width: 768px) {
            .reorder-btn {
                width: 32px;
                height: 28px;
                font-size: 14px;
            }
        }
        
        .reorder-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
        }
        
        .reorder-btn:active {
            transform: scale(0.95);
        }
        
        .priority-indicator {
            position: absolute;
            top: 12px;
            left: 12px;
            background: var(--accent-primary);
            color: var(--bg-primary);
            border-radius: 50%;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 700;
            box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);
        }

        /* ==================== PHOTO MODAL ==================== */
        .photo-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(12px);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .photo-modal.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }

        .photo-modal-content {
            max-width: 90%;
            max-height: 90%;
            position: relative;
        }

        .photo-modal-content img {
            max-width: 100%;
            max-height: 90vh;
            object-fit: contain;
            border-radius: var(--radius-sm);
        }

        .photo-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: var(--bg-card);
            border: 1px solid var(--border-default);
            font-size: 1.5rem;
            padding: 12px 20px;
            cursor: pointer;
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            transition: all var(--transition-normal);
        }

        .photo-nav:hover {
            background: var(--bg-elevated);
            border-color: var(--accent-primary);
        }

        .photo-nav.prev {
            left: 20px;
        }

        .photo-nav.next {
            right: 20px;
        }

        .photo-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: var(--bg-card);
            border: 1px solid var(--border-default);
            font-size: 1.5rem;
            padding: 12px 20px;
            cursor: pointer;
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            transition: all var(--transition-normal);
        }

        .photo-close:hover {
            background: var(--danger);
            border-color: var(--danger);
            color: white;
        }

        /* ==================== SCROLLBAR STYLING ==================== */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--bg-elevated);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }

        /* ==================== BALANCE BREAKDOWN SECTION ==================== */
        .balance-breakdown {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-lg);
            padding: 24px;
            margin-top: 24px;
        }

        .balance-breakdown h3 {
            font-family: 'Outfit', sans-serif;
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 20px;
        }

        .breakdown-row {
            display: flex;
            justify-content: space-between;
            padding: 14px 0;
            border-bottom: 1px solid var(--border-subtle);
            font-size: 0.95rem;
        }

        .breakdown-row:last-child {
            border-bottom: none;
            font-weight: 600;
            padding-top: 16px;
            margin-top: 8px;
            border-top: 2px solid var(--border-default);
        }

        .breakdown-label {
            color: var(--text-secondary);
        }

        .breakdown-value {
            color: var(--text-primary);
            font-weight: 500;
        }

        .breakdown-value.positive {
            color: var(--success);
        }

        .breakdown-value.negative {
            color: var(--danger);
        }

        /* ==================== SECTION HEADERS ==================== */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .section-header h2 {
            font-family: 'Outfit', sans-serif;
            font-size: 1.35rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        /* ==================== MOBILE RESPONSIVENESS ==================== */
        @media (max-width: 768px) {
            .stat-card {
                padding: 20px;
            }
            
            .stat-value {
                font-size: 1.75rem;
            }
            
            .stat-label {
                font-size: 0.8rem;
            }
            
            .add-item-section {
                padding: 20px;
                margin-bottom: 24px;
            }
            
            .btn {
                padding: 10px 18px;
                font-size: 0.85rem;
            }
            
            .item-actions {
                flex-direction: column;
                gap: 8px;
            }
            
            .item-actions button {
                width: 100%;
            }
        }

        /* ==================== ANIMATIONS ==================== */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        .loading {
            animation: pulse 1.5s ease-in-out infinite;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-container">
        <div class="login-card">
            <div class="login-header">
                <h1> Furniture Inventory</h1>
                <p>Select your account to continue</p>
        </div>

            <div class="user-selection">
                <div class="user-option" onclick="selectUser('mike')" id="mike-option" role="button" tabindex="0">
                    <h3> Mike</h3>
                    <p>Administrator Access</p>
        </div>
                <div class="user-option" onclick="selectUser('dee')" id="dee-option" role="button" tabindex="0">
                    <h3> Dee</h3>
                    <p>Administrator Access</p>
        </div>
        </div>

            <div class="pin-section" style="margin-top: 24px;">
                <label for="pinInput" style="display: block; margin-bottom: 10px; font-weight: 600; color: var(--text-secondary); font-size: 0.9rem;">Enter PIN Code</label>
                <input type="password" id="pinInput" placeholder="" maxlength="4" style="
                    width: 100%;
                    padding: 16px;
                    border: 2px solid var(--border-default);
                    border-radius: var(--radius-md);
                    font-size: 24px;
                    text-align: center;
                    background: var(--bg-secondary);
                    color: var(--text-primary);
                    letter-spacing: 8px;
                    font-weight: 700;
                    transition: all 0.3s ease;
                " oninput="checkPinAndEnableLogin()">
        </div>

            <div class="login-actions">
                <button class="btn-login btn-login-primary" id="loginBtn" onclick="login()" disabled>
                    Access Inventory
                </button>
        </div>
                    </div>
                    </div>

    <!-- Main Application -->
    <div id="mainApp" class="hidden">
        
        <div class="container">
        <div class="header">
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px;">
                <div>
                    <h1><span onclick="showHiddenHistory()" style="cursor: pointer; user-select: none;"></span> Furniture Inventory</h1>
                    <p>Professional Inventory & Sales Management</p>
                </div>
                <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
                    <button onclick="switchToDeliveryForm()" class="btn-delivery">
                         Create Delivery Form
                    </button>
                    <div style="background: rgba(245, 158, 11, 0.15); border: 1px solid rgba(245, 158, 11, 0.3); padding: 10px 16px; border-radius: 8px; font-weight: 600; color: #f59e0b; font-size: 0.9rem;">
                         <span id="currentUserHeader"></span>
                    </div>
                    <button onclick="logout()" class="logout-btn-header">
                        Logout
                    </button>
                </div>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('statistics')">Statistics</button>
            <button class="tab" onclick="switchTab('additem')">New Items</button>
            <button class="tab" onclick="switchTab('inventory')">Inventory (<span id="inventoryCount">0</span>)</button>
            <button class="tab" onclick="switchTab('needswork')">Not Ready (<span id="needsworkCount">0</span>)</button>
            <button class="tab" onclick="switchTab('sold')">Sold (<span id="soldCount">0</span>)</button>
            <button class="tab" onclick="switchTab('deliveryform')">Delivery Form</button>
        </div>

        <!-- Statistics Tab -->
        <div id="statistics" class="tab-content active">
            <div class="section-header">
                <h2> Overall Statistics</h2>
                <button onclick="exportToExcel()" class="btn btn-success">
                     Export to Excel
                </button>
            </div>
            <div class="stats-grid">
                <div class="stat-card blue">
                    <div class="stat-value" id="totalBalance">0.00</div>
                    <div class="stat-label">Current Balance</div>
                    <button onclick="openBalanceModal()" style="margin-top: 15px; padding: 8px 16px; background: white; color: #667eea; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                        Edit Balance
                    </button>
                </div>
                <div class="stat-card green">
                    <div class="stat-value" id="moneyIn">0.00</div>
                    <div class="stat-label">Money In (Sales)</div>
                </div>
                <div class="stat-card red">
                    <div class="stat-value" id="moneyOut">0.00</div>
                    <div class="stat-label">Money Out (Purchases)</div>
                </div>
                <div class="stat-card orange">
                    <div class="stat-value" id="totalProfit">0.00</div>
                    <div class="stat-label">Total Profit</div>
                </div>
            </div>

            <div class="balance-breakdown">
                <h3> Balance Breakdown</h3>
                <div style="display: grid; gap: 0;">
                    <div class="breakdown-row">
                        <span class="breakdown-label">Sales Revenue:</span>
                        <span class="breakdown-value positive" id="balanceMoneyIn">0.00</span>
                        </div>
                    <div class="breakdown-row">
                        <span class="breakdown-label">Inventory Purchases:</span>
                        <span class="breakdown-value negative" id="balanceMoneyOut">-0.00</span>
                        </div>
                    <div class="breakdown-row">
                        <span class="breakdown-label">Additional Income:</span>
                        <span class="breakdown-value positive" id="balanceAdditionalIncome">0.00</span>
                        </div>
                    <div class="breakdown-row">
                        <span class="breakdown-label">Additional Expenses:</span>
                        <span class="breakdown-value negative" id="balanceAdditionalExpenses">-0.00</span>
                        </div>
                    <div class="breakdown-row" style="border-top: 2px solid var(--accent-primary); padding-top: 16px; margin-top: 8px;">
                        <span class="breakdown-label" style="color: var(--text-primary); font-weight: 600;">Total Balance:</span>
                        <span class="breakdown-value" style="color: var(--accent-primary); font-size: 1.1rem;" id="balanceTotal">0.00</span>
                    </div>
                </div>
            </div>

            <div class="balance-breakdown" style="margin-top: 24px;">
                <h3> This Month's Sales</h3>
                <div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); margin-top: 16px; margin-bottom: 0;">
                    <div class="stat-card green" style="padding: 20px;">
                        <div class="stat-value" id="monthSoldItems">0</div>
                        <div class="stat-label">Items Sold</div>
                    </div>
                    <div class="stat-card blue" style="padding: 20px;">
                        <div class="stat-value" id="monthRevenue">0.00</div>
                        <div class="stat-label">Revenue</div>
                    </div>
                    <div style="background: white; padding: 20px; border-radius: 8px;">
                        <div style="font-size: 2em; font-weight: 700; color: #ffc107;" id="monthProfit">0.00</div>
                        <div style="color: #666;">Profit</div>
                    </div>
                </div>
            </div>

            <div style="background: white; padding: 25px; border-radius: 12px; margin-top: 30px; border: 2px solid #e0e0e0;">
                <h3 style="margin-bottom: 20px;">Monthly Sales Chart</h3>
                <canvas id="salesChart" style="max-height: 400px;"></canvas>
            </div>

            <div style="background: #f8f9fa; padding: 25px; border-radius: 12px; margin-top: 30px;">
                <h3 style="margin-bottom: 15px;">Month by Month Breakdown</h3>
                <div id="monthlyBreakdown"></div>
            </div>

            <div style="background: #f8f9fa; padding: 25px; border-radius: 12px; margin-bottom: 20px;">
                <h3 style="margin-bottom: 15px;">Inventory Summary</h3>
                <div class="stats-grid">
                    <div style="background: white; padding: 20px; border-radius: 8px;">
                        <div style="font-size: 2em; font-weight: 700; color: #667eea;" id="totalItems">0</div>
                        <div style="color: #666;">Total Items</div>
                    </div>
                    <div style="background: white; padding: 20px; border-radius: 8px;">
                        <div style="font-size: 2em; font-weight: 700; color: #28a745;" id="readyItems">0</div>
                        <div style="color: #666;">Ready to Sell</div>
                    </div>
                    <div style="background: white; padding: 20px; border-radius: 8px;">
                        <div style="font-size: 2em; font-weight: 700; color: #ffc107;" id="needsWorkItems">0</div>
                        <div style="color: #666;">Needs Work</div>
                    </div>
                    <div style="background: white; padding: 20px; border-radius: 8px;">
                        <div style="font-size: 2em; font-weight: 700; color: #17a2b8;" id="soldItems">0</div>
                        <div style="color: #666;">Sold</div>
                    </div>
                    <div style="background: white; padding: 20px; border-radius: 8px;">
                        <div style="font-size: 2em; font-weight: 700; color: #764ba2;" id="avgDaysInStock">0</div>
                        <div style="color: #666;">Avg Days in Stock</div>
                    </div>
                    <div style="background: white; padding: 20px; border-radius: 8px;">
                        <div style="font-size: 2em; font-weight: 700; color: #e83e8c;" id="avgDaysToSell">0</div>
                        <div style="color: #666;">Avg Days to Sell</div>
                    </div>
                </div>
            </div>

            <h3 style="margin-bottom: 15px;">Transaction Details</h3>
            <table class="details-table">
                <thead>
                    <tr>
                        <th>Item Number</th>
                        <th>Item</th>
                        <th>Purchase Date</th>
                        <th>Days in Stock</th>
                        <th>Purchase Price</th>
                        <th>Sold Date</th>
                        <th>Sold Price</th>
                        <th>Profit</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="detailsTableBody"></tbody>
            </table>
        </div>

        <!-- Inventory Tab -->
        <div id="inventory" class="tab-content">
            <div class="search-container">
                <div class="search-box">
                    <span class="search-icon"></span>
                    <input type="text" id="inventorySearch" class="search-input" placeholder="Search by name, item number, or description..." oninput="filterInventory()">
                    <button class="search-clear" onclick="clearSearch('inventorySearch')" style="display: none;"></button>
                </div>
            </div>
            <div id="inventoryList" style="padding: 20px 0;"></div>
        </div>

        <!-- Add New Item Tab -->
        <div id="additem" class="tab-content">
            <div class="add-item-section">
                <h2 style="margin-bottom: 20px;">Add New Item to Inventory</h2>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Item Name</label>
                        <input type="text" id="itemName" placeholder="e.g., Oak Dining Table">
                    </div>
                    <div class="form-group">
                        <label>Purchase Date</label>
                        <input type="date" id="purchaseDate">
                    </div>
                    <div class="form-group">
                        <label>Purchase Price ()</label>
                        <input type="number" id="purchasePrice" step="0.01" placeholder="0.00">
                    </div>
                    <div class="form-group">
                        <label>Affect Balance</label>
                        <select id="affectBalance">
                            <option value="yes">Yes - Deduct from balance</option>
                            <option value="no">No - Don't affect balance</option>
                        </select>
                        <small style="color: #666; font-size: 0.85em;">Choose "No" for donated/found/free items</small>
                    </div>
                    <div class="form-group">
                        <label>Status</label>
                        <select id="itemStatus">
                            <option value="ready">Ready to Sell</option>
                            <option value="needs-work">Needs Work</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Item Photos</label>
                        <input type="file" id="itemPhoto" accept="image/*" multiple>
                        <small style="color: #666; font-size: 0.85em;">You can select multiple photos</small>
                    </div>
                    <div class="form-group">
                        <label>Work Required Photos</label>
                        <input type="file" id="workPhotos" accept="image/*" multiple>
                        <small style="color: #666; font-size: 0.85em;">Photos of damage/work needed</small>
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="itemDescription" rows="1" placeholder="Optional details"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Work Notes (Optional)</label>
                        <textarea id="itemWorkNotes" rows="1" placeholder="Optional text notes"></textarea>
                    </div>
                </div>
                <div style="margin-top: 20px;">
                    <button class="btn btn-primary" onclick="addItem()">Add Item to Inventory</button>
                </div>
            </div>
        </div>

        <!-- Needs Work Tab -->
        <div id="needswork" class="tab-content">
            <div class="search-container">
                <div class="search-box">
                    <span class="search-icon"></span>
                    <input type="text" id="needsWorkSearch" class="search-input" placeholder="Search by name, item number, or description..." oninput="filterInventory()">
                    <button class="search-clear" onclick="clearSearch('needsWorkSearch')" style="display: none;"></button>
                </div>
            </div>
            <div id="needsWorkList" style="padding: 20px 0;"></div>
        </div>

        <!-- Sold Tab -->
        <div id="sold" class="tab-content">
            <div class="search-container">
                <div class="search-box">
                    <span class="search-icon"></span>
                    <input type="text" id="soldSearch" class="search-input" placeholder="Search by name, item number, or description..." oninput="filterInventory()">
                    <button class="search-clear" onclick="clearSearch('soldSearch')" style="display: none;"></button>
                </div>
            </div>
            <div id="soldList" style="padding: 20px 0;"></div>
        </div>

        <!-- Delivery Form Tab -->
        <div id="deliveryform" class="tab-content">
            <div style="max-width: 800px; margin: 0 auto;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; flex-wrap: wrap; gap: 15px;">
                    <h2 style="margin: 0; color: var(--text-primary);">Delivery Form</h2>
                    <button type="button" class="btn btn-warning" onclick="openReceiptGenerator()" style="display: flex; align-items: center; gap: 8px;">
                         Generate Receipt
                    </button>
                </div>
                
                <form id="deliveryForm" onsubmit="showCompletedForm(event)">
                    <div class="delivery-form-group">
                        <label for="deliveryJobCode">Job Number *</label>
                        <input type="text" id="deliveryJobCode" placeholder="e.g., 1-1, 1-2, 2-1" required style="max-width: 200px;">
                    </div>

                    <div class="delivery-form-group">
                        <label for="deliveryItemName">Item Name *</label>
                        <input type="text" id="deliveryItemName" placeholder="Enter item name..." required>
                    </div>

                    <div class="delivery-form-group">
                        <label for="deliveryDate">Delivery Date *</label>
                        <input type="date" id="deliveryDate" required onchange="updateDeliveryDateDisplay()">
                        <div id="deliveryDateDisplay" style="margin-top: 5px; font-weight: 600; color: #3498db;"></div>
                    </div>

                    <div class="delivery-form-group">
                        <label>Sold On *</label>
                        <div class="delivery-checkbox-group">
                            <div class="delivery-checkbox-item">
                                <input type="checkbox" id="soldFacebook" name="soldOn" value="Facebook">
                                <label for="soldFacebook" style="margin: 0; font-weight: normal;">Facebook</label>
                            </div>
                            <div class="delivery-checkbox-item">
                                <input type="checkbox" id="soldEbay" name="soldOn" value="eBay">
                                <label for="soldEbay" style="margin: 0; font-weight: normal;">eBay</label>
                            </div>
                            <div class="delivery-checkbox-item">
                                <input type="checkbox" id="soldOther" name="soldOn" value="Other">
                                <label for="soldOther" style="margin: 0; font-weight: normal;">Other</label>
                            </div>
                        </div>
                    </div>

                    <div class="delivery-form-group">
                        <label>Driver to get collect code</label>
                        <div class="delivery-checkbox-item">
                            <input type="checkbox" id="driverCollectCode" checked>
                            <label for="driverCollectCode" style="margin: 0; font-weight: normal;">Driver should get collect code</label>
                        </div>
                    </div>

                    <div class="delivery-form-group">
                        <label>Driver should take payment for item *</label>
                        <div class="delivery-radio-group">
                            <div class="delivery-radio-item">
                                <input type="radio" id="paymentYes" name="driverPaymentItem" value="Yes">
                                <label for="paymentYes" style="margin: 0; font-weight: normal;">Yes</label>
                            </div>
                            <div class="delivery-radio-item">
                                <input type="radio" id="paymentNo" name="driverPaymentItem" value="No" checked>
                                <label for="paymentNo" style="margin: 0; font-weight: normal;">No</label>
                            </div>
                        </div>
                    </div>

                    <div class="delivery-form-group">
                        <label>Driver should take payment for delivery *</label>
                        <div class="delivery-radio-group">
                            <div class="delivery-radio-item">
                                <input type="radio" id="deliveryPaymentYes" name="driverPaymentDelivery" value="Yes">
                                <label for="deliveryPaymentYes" style="margin: 0; font-weight: normal;">Yes</label>
                            </div>
                            <div class="delivery-radio-item">
                                <input type="radio" id="deliveryPaymentNo" name="driverPaymentDelivery" value="No" checked>
                                <label for="deliveryPaymentNo" style="margin: 0; font-weight: normal;">No</label>
                            </div>
                        </div>
                    </div>

                    <div class="delivery-form-group">
                        <label for="deliverySpecialComments">Special Comments</label>
                        <textarea id="deliverySpecialComments" rows="4" placeholder="Any special instructions or comments..."></textarea>
                    </div>

                    <div class="delivery-form-group">
                        <label for="deliveryAddress">Address *</label>
                        <textarea id="deliveryAddress" rows="3" placeholder="Enter full address (street, county, postcode)..." required></textarea>
                    </div>

                    <div style="display: flex; gap: 10px; margin-top: 25px;">
                        <button type="button" class="btn btn-danger" onclick="resetDeliveryForm()" style="flex: 1;">Reset Form</button>
                        <button type="submit" class="btn btn-success" style="flex: 1;">Done</button>
                    </div>
                </form>

                <!-- Completed Form View -->
                <div id="completedFormView" style="display: none; max-width: 800px; margin: 0 auto;">
                    <div id="completedFormContent" style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); max-width: 100%; box-sizing: border-box;">
                        <!-- Content will be populated by JavaScript -->
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 25px;">
                        <button type="button" class="btn btn-primary" onclick="editDeliveryForm()" style="flex: 1;">Edit</button>
                        <button type="button" class="btn btn-success" onclick="downloadCompletedFormPDF()" style="flex: 1;">Download PDF</button>
                        <button type="button" class="btn btn-warning" onclick="openReceiptGenerator()" style="flex: 1;"> Generate Receipt</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Receipt Generator Modal -->
        <div id="receiptModal" class="modal">
            <div class="modal-content" style="max-width: 900px; background: var(--bg-card); padding: 0; overflow: hidden;">
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 20px 24px; border-bottom: 1px solid var(--border-default);">
                    <h2 style="font-family: 'Outfit', sans-serif; font-size: 1.25rem; font-weight: 600; color: var(--text-primary); margin: 0;"> Receipt Generator</h2>
                    <button onclick="closeReceiptModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-secondary);"></button>
                </div>
                <div style="padding: 24px;">
                    <div class="no-print-receipt" style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                        <button onclick="printReceipt()" class="btn btn-primary"> Print / Save PDF</button>
                        <button onclick="addReceiptRow()" class="btn btn-success">+ Add Item</button>
                        <button onclick="prefillFromDelivery()" class="btn btn-warning"> Fill from Delivery Form</button>
                    </div>
                    
                    <div id="receiptContent" style="background: #fff; color: #333; padding: 30px; border-radius: var(--radius-md);">
                        <!-- Receipt Header -->
                        <div style="text-align: center; margin-bottom: 20px; border-bottom: 2px solid #333; padding-bottom: 20px;">
                            <h1 style="margin: 0; text-transform: uppercase; letter-spacing: 3px; font-size: 24px; color: #2c3e50;">Windlesora Modern</h1>
                            <div style="font-size: 14px; color: #555; margin-top: 8px; line-height: 1.6;">
                                Unit 4 & 5, 65 Straight Road<br>
                                Old Windsor, SL4 2SA<br>
                                <strong>Tel: 07469 203722</strong>
                            </div>
                        </div>

                        <h2 style="text-align: center; font-weight: normal; border: 2px solid #333; display: inline-block; padding: 8px 30px; margin: 0 auto 20px; width: auto; font-size: 1.1rem;">RECEIPT</h2>

                        <!-- Info Section -->
                        <div style="display: flex; justify-content: space-between; margin-bottom: 25px; flex-wrap: wrap; gap: 20px;">
                            <div style="flex: 1; min-width: 200px;">
                                <strong>Received From:</strong><br>
                                <div contenteditable="true" id="receiptCustomerName" style="border: 1px dashed #ddd; padding: 8px; background: #fffdf0; margin-top: 5px; min-height: 60px;">
                                    [Customer Name]<br>
                                    [Address Line 1]<br>
                                    [Postcode]
                                </div>
                            </div>
                            <div style="flex: 1; min-width: 200px; text-align: right;">
                                <strong>Date:</strong> <span id="receiptDate" contenteditable="true" style="border: 1px dashed #ddd; padding: 2px 8px; background: #fffdf0;"></span><br>
                                <strong>Receipt #:</strong> <span id="receiptNumber" contenteditable="true" style="border: 1px dashed #ddd; padding: 2px 8px; background: #fffdf0;">001</span><br>
                                <strong>Payment:</strong> <span id="receiptPayment" contenteditable="true" style="border: 1px dashed #ddd; padding: 2px 8px; background: #fffdf0;">Card / BACS</span>
                            </div>
                        </div>

                        <!-- Items Table -->
                        <table id="receiptItemsTable" style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
                            <thead>
                                <tr>
                                    <th style="background: #f8f8f8; padding: 12px; text-align: left; border-bottom: 2px solid #333; font-weight: bold;">Description</th>
                                    <th style="background: #f8f8f8; padding: 12px; text-align: right; border-bottom: 2px solid #333; font-weight: bold; width: 80px;">Qty</th>
                                    <th style="background: #f8f8f8; padding: 12px; text-align: right; border-bottom: 2px solid #333; font-weight: bold; width: 100px;">Price ()</th>
                                    <th style="background: #f8f8f8; padding: 12px; text-align: right; border-bottom: 2px solid #333; font-weight: bold; width: 100px;">Total ()</th>
                                </tr>
                            </thead>
                            <tbody id="receiptTableBody">
                                <tr>
                                    <td style="padding: 12px; border-bottom: 1px solid #eee;" contenteditable="true">Furniture Item</td>
                                    <td style="padding: 12px; border-bottom: 1px solid #eee;"><input type="number" class="receipt-qty" value="1" oninput="calculateReceiptTotal()" style="width: 100%; padding: 6px; border: 1px dashed #ddd; background: #fffdf0; text-align: right;"></td>
                                    <td style="padding: 12px; border-bottom: 1px solid #eee;"><input type="number" class="receipt-price" value="0.00" step="0.01" oninput="calculateReceiptTotal()" style="width: 100%; padding: 6px; border: 1px dashed #ddd; background: #fffdf0; text-align: right;"></td>
                                    <td style="padding: 12px; border-bottom: 1px solid #eee; text-align: right; font-weight: bold;" class="receipt-row-total">0.00</td>
                                </tr>
                                <tr>
                                    <td style="padding: 12px; border-bottom: 1px solid #eee;" contenteditable="true">Delivery</td>
                                    <td style="padding: 12px; border-bottom: 1px solid #eee;"><input type="number" class="receipt-qty" value="1" oninput="calculateReceiptTotal()" style="width: 100%; padding: 6px; border: 1px dashed #ddd; background: #fffdf0; text-align: right;"></td>
                                    <td style="padding: 12px; border-bottom: 1px solid #eee;"><input type="number" class="receipt-price" value="0.00" step="0.01" oninput="calculateReceiptTotal()" style="width: 100%; padding: 6px; border: 1px dashed #ddd; background: #fffdf0; text-align: right;"></td>
                                    <td style="padding: 12px; border-bottom: 1px solid #eee; text-align: right; font-weight: bold;" class="receipt-row-total">0.00</td>
                                </tr>
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td colspan="3" style="padding: 15px; font-weight: bold; font-size: 1.1em; background: #fafafa; border-top: 2px solid #333; text-align: right;">TOTAL PAID</td>
                                    <td id="receiptGrandTotal" style="padding: 15px; font-weight: bold; font-size: 1.1em; background: #fafafa; border-top: 2px solid #333; text-align: right;">0.00</td>
                                </tr>
                            </tfoot>
                        </table>

                        <div style="margin-top: 30px; text-align: center;">
                            <p><strong>Payment Status:</strong> <span id="receiptPaymentStatus" contenteditable="true" style="border: 1px dashed #ddd; padding: 2px 8px; background: #fffdf0;">PAID IN FULL</span></p>
                            <p style="font-style: italic; color: #666;">Thank you for your business!</p>
                        </div>

                        <div style="text-align: center; margin-top: 30px; font-size: 12px; color: #777; border-top: 1px solid #eee; padding-top: 15px;">
                            Windlesora Modern | Unit 4 & 5 Old Windsor, 65 Straight Road, SL4 2SA | Tel: 07469 203722
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- History Tab -->
        <div id="history" class="tab-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3>Edit History</h3>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <select id="historyFilter" onchange="filterHistory()" style="padding: 8px 12px; border: 2px solid #e0e0e0; border-radius: 6px;">
                        <option value="all">All Changes</option>
                        <option value="add">Items Added</option>
                        <option value="edit">Items Edited</option>
                        <option value="delete">Items Deleted</option>
                        <option value="status">Status Changes</option>
                        <option value="balance_transaction">Balance Transactions</option>
                        <option value="balance_transaction_delete">Balance Deletions</option>
                    </select>
                    <button class="btn btn-danger" onclick="clearHistory()" style="padding: 8px 16px; font-size: 0.9em;">
                        Clear History
                    </button>
                </div>
            </div>
            
            <div id="historyList" style="max-height: 600px; overflow-y: auto;">
                <!-- History entries will be displayed here -->
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">Edit Item</div>
            <div class="form-group" style="margin-bottom: 15px;">
                <label>Item Number</label>
                <input type="text" id="editItemNumber" readonly style="background: #f0f0f0; cursor: not-allowed; font-weight: 600; color: #667eea;">
            </div>
            <div class="form-grid">
                <div class="form-group">
                    <label>Item Name</label>
                    <input type="text" id="editItemName">
                </div>
                <div class="form-group">
                    <label>Purchase Date</label>
                    <input type="date" id="editPurchaseDate">
                </div>
                    <div class="form-group">
                        <label>Purchase Price ()</label>
                        <input type="number" id="editPurchasePrice" step="0.01">
                    </div>
                    <div class="form-group">
                        <label>Affect Balance</label>
                        <select id="editAffectBalance">
                            <option value="yes">Yes - Deduct from balance</option>
                            <option value="no">No - Don't affect balance</option>
                        </select>
                        <small style="color: #666; font-size: 0.85em;">Choose "No" for donated/found/free items</small>
                    </div>
                <div class="form-group">
                    <label>Sold Date</label>
                    <input type="date" id="editSoldDate">
                </div>
                <div class="form-group">
                    <label>Sold Price ()</label>
                    <input type="number" id="editSoldPrice" step="0.01">
                </div>
                <div class="form-group">
                    <label>Add to Balance</label>
                    <select id="editAddToBalance">
                        <option value="yes">Yes - Add to balance</option>
                        <option value="no">No - Don't add to balance</option>
                    </select>
                    <small style="color: #666; font-size: 0.85em;">Choose "No" if you want to manually add the money later</small>
                </div>
                <div class="form-group">
                    <label>Status</label>
                    <select id="editItemStatus">
                        <option value="ready">Ready to Sell</option>
                        <option value="needs-work">Needs Work</option>
                        <option value="sold">Sold</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="editItemDescription" rows="2"></textarea>
                </div>
                <div class="form-group" style="grid-column: 1 / -1;">
                    <label>Main Item Photos</label>
                    <div id="editMainPhotosPreview" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; margin-bottom: 10px;"></div>
                    <input type="file" id="editMainPhotos" accept="image/*" multiple>
                    <small style="color: #666; font-size: 0.85em;">Add or replace main photos of the item</small>
                </div>
                <div class="form-group" style="grid-column: 1 / -1;">
                    <label>Work Required Photos</label>
                    <div id="editWorkPhotosPreview" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; margin-bottom: 10px;"></div>
                    <input type="file" id="editWorkPhotos" accept="image/*" multiple>
                    <small style="color: #666; font-size: 0.85em;">Add photos showing areas that need work</small>
                </div>
                <div class="form-group" style="grid-column: 1 / -1;">
                    <label>Work Notes (Optional)</label>
                    <textarea id="editItemWorkNotes" rows="2" placeholder="Optional: Add text notes about the work needed"></textarea>
                </div>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn btn-success" onclick="saveEdit()">Save Changes</button>
                <button class="btn btn-danger" onclick="closeEditModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Photo Modal -->
    <div id="photoModal" class="photo-modal">
        <button class="photo-close" onclick="closePhotoModal()"></button>
        <div class="photo-modal-content">
            <button class="photo-nav prev" onclick="prevPhoto()"></button>
            <img id="photoModalImage" src="" alt="">
            <button class="photo-nav next" onclick="nextPhoto()"></button>
            <div style="text-align: center; margin-top: 15px; color: white;">
                <span id="photoCounter"></span>
            </div>
        </div>
    </div>

    <!-- Full View Modal -->
    <div id="fullViewModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <span id="fullViewItemName">Item Details</span>
                <button onclick="closeFullViewModal()" style="background: none; border: none; font-size: 1.5em; cursor: pointer; color: #666;"></button>
            </div>
            
            <div id="fullViewContent" style="padding: 20px;">
                <!-- Content will be populated by JavaScript -->
            </div>
            
            <div class="full-view-modal-buttons">
                <button class="btn btn-danger" onclick="deleteFromFullView()">Delete Item</button>
                <button class="btn btn-primary" onclick="editFromFullView()">Edit Item</button>
                <button class="btn btn-secondary" onclick="closeFullViewModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Balance Modal -->
    <div id="balanceModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">Manage Balance & Transactions</div>
            
            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                <h4 style="margin-bottom: 15px;">Add Transaction</h4>
                <div class="form-grid" style="grid-template-columns: 2fr 1fr 1fr 1fr;">
                    <div class="form-group">
                        <label>Description</label>
                        <input type="text" id="transactionDesc" placeholder="e.g., Rent, Tools, Cash deposit">
                    </div>
                    <div class="form-group">
                        <label>Amount ()</label>
                        <input type="number" id="transactionAmount" step="0.01" placeholder="0.00">
                    </div>
                    <div class="form-group">
                        <label>Type</label>
                        <select id="transactionType">
                            <option value="expense">Expense (-)</option>
                            <option value="income">Income (+)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Date</label>
                        <input type="date" id="transactionDate">
                    </div>
                </div>
                <button class="btn btn-primary" onclick="addTransaction()" style="margin-top: 10px;">Add Transaction</button>
            </div>

            <div style="background: #e8f5e8; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                <h4 style="margin-bottom: 15px;">Sold Items - Add to Balance</h4>
                <p style="color: #666; margin-bottom: 15px;">These sold items haven't been added to your balance yet. Click to add them as income transactions.</p>
                <div id="soldItemsList" style="max-height: 200px; overflow-y: auto;">
                    <!-- Sold items will be listed here -->
                </div>
            </div>

            <div>
                <h4 style="margin-bottom: 15px;">Transaction History</h4>
                <div id="transactionList" style="max-height: 300px; overflow-y: auto;">
                    <!-- Transactions will be listed here -->
                </div>
            </div>

            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn btn-success" onclick="closeBalanceModal()">Done</button>
            </div>
        </div>
    </div>

    <!-- Hidden div for delivery form preview (used for image generation) -->
    <div id="deliveryFormPreview"></div>

    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script>
        // ==================== JSONBin.io CONFIGURATION ====================
        // This is your cloud storage - data syncs across all devices!
        const JSONBIN_API_KEY = '$2a$10$wKD6wmdekKhY5AbAtKUeu.d9hVdOrNHxBRCFBHuk995OFxmRUtqd.';
        const JSONBIN_BIN_ID = null; // Will be auto-created on first save
        const JSONBIN_BASE_URL = 'https://api.jsonbin.io/v3';
        
        // ==================== ImgBB IMAGE HOSTING ====================
        const IMGBB_API_KEY = '7b7e0bffd8117c5b4d3acda729d328b2';
        
        // Upload image to ImgBB and return URL
        async function uploadToImgBB(base64Data) {
            try {
                // Remove data URL prefix if present
                const base64Image = base64Data.replace(/^data:image\/[a-z]+;base64,/, '');
                
                const formData = new FormData();
                formData.append('key', IMGBB_API_KEY);
                formData.append('image', base64Image);
                
                console.log(' Uploading image to ImgBB...');
                const response = await fetch('https://api.imgbb.com/1/upload', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    console.log('  Image uploaded to ImgBB:', result.data.url);
                    return result.data.url;
                } else {
                    console.error('  ImgBB upload failed:', result);
                    return base64Data; // Fallback to base64 if upload fails
                }
            } catch (error) {
                console.error('  ImgBB error:', error);
                return base64Data; // Fallback to base64 if upload fails
            }
        }
        
        // Upload multiple images to ImgBB
        async function uploadMultipleToImgBB(base64Array) {
            const uploadedUrls = [];
            for (const base64Data of base64Array) {
                // Skip if already a URL (not base64)
                if (base64Data.startsWith('http')) {
                    uploadedUrls.push(base64Data);
                } else {
                    const url = await uploadToImgBB(base64Data);
                    uploadedUrls.push(url);
                }
            }
            return uploadedUrls;
        }
        // ==============================================================
        
        //  SHARED BIN ID - All devices sync to this same bin!
        const SHARED_BIN_ID = '697cadacd0ea881f40930514';
        let jsonBinId = SHARED_BIN_ID;
        
        // JSONBin.io API functions
        async function jsonBinSave(data) {
            try {
                const headers = {
                    'Content-Type': 'application/json',
                    'X-Master-Key': JSONBIN_API_KEY
                };
                
                if (jsonBinId) {
                    // Update existing bin
                    const response = await fetch(`${JSONBIN_BASE_URL}/b/${jsonBinId}`, {
                        method: 'PUT',
                        headers: headers,
                        body: JSON.stringify(data)
                    });
                    const result = await response.json();
                    if (result.metadata) {
                        console.log('  Data saved to JSONBin.io');
                        return true;
                    } else {
                        console.error('  JSONBin save error:', result);
                        return false;
                    }
                } else {
                    // Create new bin
                    const response = await fetch(`${JSONBIN_BASE_URL}/b`, {
                        method: 'POST',
                        headers: {
                            ...headers,
                            'X-Bin-Name': 'furniture-inventory',
                            'X-Bin-Private': 'true'
                        },
                        body: JSON.stringify(data)
                    });
                    const result = await response.json();
                    if (result.metadata && result.metadata.id) {
                        jsonBinId = result.metadata.id;
                        localStorage.setItem('furniture_jsonbin_id', jsonBinId);
                        console.log('  Created new JSONBin:', jsonBinId);
                        return true;
                    } else {
                        console.error('  JSONBin create error:', result);
                        return false;
                    }
                }
            } catch (error) {
                console.error('  JSONBin error:', error);
                return false;
            }
        }
        
        async function jsonBinLoad() {
            try {
                if (!jsonBinId) {
                    console.log(' No JSONBin ID found - will create on first save');
                    return null;
                }
                
                const response = await fetch(`${JSONBIN_BASE_URL}/b/${jsonBinId}/latest`, {
                    method: 'GET',
                    headers: {
                        'X-Master-Key': JSONBIN_API_KEY
                    }
                });
                const result = await response.json();
                if (result.record) {
                    console.log('  Data loaded from JSONBin.io');
                    return result.record;
                } else {
                    console.error('  JSONBin load error:', result);
                    return null;
                }
            } catch (error) {
                console.error('  JSONBin load error:', error);
                return null;
            }
        }
        // ==================================================================
        
        // Supabase configuration (kept as backup)
        const supabaseUrl = 'https://ipygreexokruwqjqvuuk.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlweWdyZWV4b2tydXdxanF2dXVrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3Mjg0NjcsImV4cCI6MjA3NjMwNDQ2N30.1itsG_KGK4_wqA7y1La9neJ9AkH4hDe0ouEwM1xvYwA';
        const supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey);

        // Test Supabase connection
        console.log('Supabase client initialized:', supabaseClient);
        console.log('Supabase URL:', supabaseUrl);
        console.log('Supabase Key (first 20 chars):', supabaseKey.substring(0, 20) + '...');

        // Test Supabase connection
        async function testSupabaseConnection() {
            try {
                console.log('Testing Supabase connection...');
                const { data, error } = await supabaseClient
                    .from('inventory')
                    .select('count')
                    .limit(1);
                
                if (error) {
                    console.error('Supabase connection test failed:', error);
                } else {
                    console.log('Supabase connection test successful:', data);
                }
                
                // Test inventory table specifically
                console.log('Testing inventory table access...');
                const { data: testData, error: testError } = await supabaseClient
                    .from('inventory')
                    .select('*')
                    .limit(1);
                
                if (testError) {
                    console.error(' Inventory table access failed:', testError);
                    console.error(' Error details:', {
                        message: testError.message,
                        details: testError.details,
                        hint: testError.hint,
                        code: testError.code
                    });
                } else {
                    console.log(' Inventory table access successful:', testData);
                }
                
                // Test specific columns
                console.log('Testing inventory table columns...');
                const { data: colData, error: colError } = await supabaseClient
                    .from('inventory')
                    .select('id, item_number, name, purchase_date, purchase_price, status')
                    .limit(1);
                
                if (colError) {
                    console.error(' Inventory column test failed:', colError);
                } else {
                    console.log(' Inventory column test successful:', colData);
                }
                
                // Test transactions table for comparison
                console.log('Testing transactions table access...');
                const { data: transData, error: transError } = await supabaseClient
                    .from('transactions')
                    .select('*')
                    .limit(1);
                
                if (transError) {
                    console.error(' Transactions table access failed:', transError);
                } else {
                    console.log(' Transactions table access successful:', transData);
                }
                
            } catch (err) {
                console.error('Supabase connection test error:', err);
            }
        }

        // Test inserting a simple item
        async function testInventoryInsert() {
            try {
                console.log(' Testing inventory insert...');
                const testItem = {
                    item_number: 'TEST-001',
                    name: 'Test Item',
                    purchase_date: '2024-01-01',
                    purchase_price: 10.00,
                    sold_date: null,
                    sold_price: null,
                    status: 'ready',
                    description: 'Test item for debugging',
                    work_notes: '',
                    affect_balance: true,
                    add_to_balance: true,
                    photos: [],
                    work_photos: []
                };
                
                const { data, error } = await supabaseClient
                    .from('inventory')
                    .insert([testItem])
                    .select();
                
                if (error) {
                    console.error(' Test insert failed:', error);
                    console.error(' Insert error details:', {
                        message: error.message,
                        details: error.details,
                        hint: error.hint,
                        code: error.code
                    });
                } else {
                    console.log(' Test insert successful:', data);
                    
                    // Clean up test item
                    if (data && data.length > 0) {
                        const { error: deleteError } = await supabaseClient
                            .from('inventory')
                            .delete()
                            .eq('id', data[0].id);
                        
                        if (deleteError) {
                            console.error(' Test cleanup failed:', deleteError);
                        } else {
                            console.log(' Test cleanup successful');
                        }
                    }
                }
            } catch (err) {
                console.error(' Test insert error:', err);
            }
        }

        // Run connection test after page loads
        window.addEventListener('load', () => {
            setTimeout(async () => {
                await testSupabaseConnection();
                await testInventoryInsert();
            }, 1000); // Wait 1 second for everything to load
        });

        // Authentication variables
        let currentUser = null;
        let selectedUser = null;

        // Check if user is already logged in
        function checkAuth() {
            const savedUser = localStorage.getItem('furnitureUser');
            if (savedUser) {
                currentUser = savedUser;
                showMainApp();
            } else {
                showLoginScreen();
            }
        }

        // Show login screen
        function showLoginScreen() {
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
        }

        // Show main application
        async function showMainApp() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            document.getElementById('currentUserHeader').textContent = currentUser.charAt(0).toUpperCase() + currentUser.slice(1);
            
            // Load inventory data
            await loadInventory();
        }

        // Select user for login
        function selectUser(user) {
            selectedUser = user;
            
            // Update UI
            document.querySelectorAll('.user-option').forEach(option => {
                option.classList.remove('selected');
            });
            document.getElementById(user + '-option').classList.add('selected');
            
            // Check if PIN is correct to enable login button
            checkPinAndEnableLogin();
        }

        // Check PIN and enable login button if correct
        function checkPinAndEnableLogin() {
            const pinInput = document.getElementById('pinInput');
            const loginBtn = document.getElementById('loginBtn');
            const correctPin = '1990';
            
            if (selectedUser && pinInput.value === correctPin) {
                loginBtn.disabled = false;
                pinInput.style.borderColor = '#10b981';
                pinInput.style.boxShadow = '0 0 0 3px rgba(16, 185, 129, 0.2)';
            } else {
                loginBtn.disabled = true;
                pinInput.style.borderColor = pinInput.value.length > 0 ? '#ef4444' : 'rgba(255, 255, 255, 0.12)';
                pinInput.style.boxShadow = pinInput.value.length > 0 ? '0 0 0 3px rgba(239, 68, 68, 0.2)' : 'none';
            }
        }

        // Login function
        async function login() {
            if (!selectedUser) return;
            
            const pinInput = document.getElementById('pinInput');
            const correctPin = '1990';
            
            if (pinInput.value !== correctPin) {
                alert('Invalid PIN code. Please enter the correct PIN.');
                pinInput.focus();
                return;
            }
            
            currentUser = selectedUser;
            localStorage.setItem('furnitureUser', currentUser);
            await showMainApp();
        }

        // Logout function
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                currentUser = null;
                selectedUser = null;
                localStorage.removeItem('furnitureUser');
                showLoginScreen();
                
                // Clear any selections and PIN
                document.querySelectorAll('.user-option').forEach(option => {
                    option.classList.remove('selected');
                });
                document.getElementById('loginBtn').disabled = true;
                document.getElementById('pinInput').value = '';
                document.getElementById('pinInput').style.borderColor = '#ddd';
            }
        }

        // ==================== RECEIPT GENERATOR FUNCTIONS ====================
        
        // Open receipt modal
        function openReceiptGenerator() {
            document.getElementById('receiptModal').classList.add('active');
            // Set today's date
            document.getElementById('receiptDate').innerText = new Date().toLocaleDateString('en-GB');
            calculateReceiptTotal();
        }
        
        // Close receipt modal
        function closeReceiptModal() {
            document.getElementById('receiptModal').classList.remove('active');
        }
        
        // Calculate receipt totals
        function calculateReceiptTotal() {
            const tbody = document.getElementById('receiptTableBody');
            const rows = tbody.getElementsByTagName('tr');
            let grandTotal = 0;
            
            for (let i = 0; i < rows.length; i++) {
                const qtyInput = rows[i].querySelector('.receipt-qty');
                const priceInput = rows[i].querySelector('.receipt-price');
                const totalCell = rows[i].querySelector('.receipt-row-total');
                
                if (qtyInput && priceInput && totalCell) {
                    const qty = parseFloat(qtyInput.value) || 0;
                    const price = parseFloat(priceInput.value) || 0;
                    const rowTotal = qty * price;
                    totalCell.innerText = rowTotal.toFixed(2);
                    grandTotal += rowTotal;
                }
            }
            
            document.getElementById('receiptGrandTotal').innerText = '' + grandTotal.toFixed(2);
        }
        
        // Add new row to receipt
        function addReceiptRow() {
            const tbody = document.getElementById('receiptTableBody');
            const newRow = document.createElement('tr');
            newRow.innerHTML = `
                <td style="padding: 12px; border-bottom: 1px solid #eee;" contenteditable="true">New Item</td>
                <td style="padding: 12px; border-bottom: 1px solid #eee;"><input type="number" class="receipt-qty" value="1" oninput="calculateReceiptTotal()" style="width: 100%; padding: 6px; border: 1px dashed #ddd; background: #fffdf0; text-align: right;"></td>
                <td style="padding: 12px; border-bottom: 1px solid #eee;"><input type="number" class="receipt-price" value="0.00" step="0.01" oninput="calculateReceiptTotal()" style="width: 100%; padding: 6px; border: 1px dashed #ddd; background: #fffdf0; text-align: right;"></td>
                <td style="padding: 12px; border-bottom: 1px solid #eee; text-align: right; font-weight: bold;" class="receipt-row-total">0.00</td>
            `;
            tbody.appendChild(newRow);
        }
        
        // Prefill receipt from delivery form
        function prefillFromDelivery() {
            const itemName = document.getElementById('deliveryItemName').value;
            const address = document.getElementById('deliveryAddress').value;
            
            if (itemName) {
                // Update first row description
                const tbody = document.getElementById('receiptTableBody');
                const firstRow = tbody.querySelector('tr td[contenteditable]');
                if (firstRow) {
                    firstRow.innerText = itemName;
                }
            }
            
            if (address) {
                document.getElementById('receiptCustomerName').innerHTML = address.replace(/\n/g, '<br>');
            }
            
            calculateReceiptTotal();
        }
        
        // Print receipt
        function printReceipt() {
            const receiptContent = document.getElementById('receiptContent').innerHTML;
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Receipt - Windlesora Modern</title>
                    <style>
                        body {
                            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
                            color: #333;
                            padding: 20px;
                            max-width: 800px;
                            margin: 0 auto;
                        }
                        table { width: 100%; border-collapse: collapse; }
                        th, td { padding: 10px; }
                        [contenteditable], input {
                            border: none !important;
                            background: none !important;
                            padding: 0 !important;
                        }
                        input { text-align: right; font-size: inherit; font-family: inherit; }
                        @media print {
                            body { padding: 0; }
                        }
                    </style>
                </head>
                <body>
                    ${receiptContent}
                    <script>
                        window.onload = function() {
                            window.print();
                        }
                    <\/script>
                </body>
                </html>
            `);
            printWindow.document.close();
        }

        // Show history in a modal overlay
        function showHiddenHistory() {
            // Create modal if it doesn't exist
            let modal = document.getElementById('historyModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'historyModal';
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.8);
                    z-index: 3000;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    padding: 20px;
                `;
                
                modal.innerHTML = `
                    <div style="
                        background: white;
                        border-radius: 12px;
                        max-width: 900px;
                        width: 100%;
                        max-height: 80vh;
                        overflow: hidden;
                        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
                    ">
                        <div style="
                            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
                            color: white;
                            padding: 20px;
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                        ">
                            <h2 style="margin: 0; font-size: 1.5em;">Edit History</h2>
                            <button onclick="closeHiddenHistory()" style="
                                background: rgba(255, 255, 255, 0.2);
                                border: none;
                                color: white;
                                font-size: 1.5em;
                                padding: 8px 12px;
                                border-radius: 6px;
                                cursor: pointer;
                                font-weight: bold;
                            "></button>
                        </div>
                        <div style="padding: 20px;">
                            <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 20px;">
                                <select id="modalHistoryFilter" onchange="filterModalHistory()" style="padding: 8px 12px; border: 2px solid #e0e0e0; border-radius: 6px;">
                                    <option value="all">All Changes</option>
                                    <option value="add">Items Added</option>
                                    <option value="edit">Items Edited</option>
                                    <option value="delete">Items Deleted</option>
                                    <option value="status">Status Changes</option>
                                    <option value="balance_transaction">Balance Transactions</option>
                                    <option value="balance_transaction_delete">Balance Deletions</option>
                                </select>
                                <button onclick="clearHistory()" style="padding: 8px 16px; background: #dc3545; color: white; border: none; border-radius: 6px; cursor: pointer;">
                                    Clear History
                                </button>
                            </div>
                            <div id="modalHistoryList" style="max-height: 400px; overflow-y: auto;">
                                <!-- History entries will be displayed here -->
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
            }
            
            // Show modal and render history
            modal.style.display = 'flex';
            renderModalHistory();
        }

        // Close hidden history modal
        function closeHiddenHistory() {
            const modal = document.getElementById('historyModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // Render history in modal
        function renderModalHistory(filter = 'all') {
            const historyList = document.getElementById('modalHistoryList');
            
            if (editHistory.length === 0) {
                historyList.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #999;">
                        <h3>No edit history yet</h3>
                        <p>Changes to inventory items will be tracked here</p>
                    </div>
                `;
                return;
            }

            let filteredHistory = editHistory;
            if (filter !== 'all') {
                filteredHistory = editHistory.filter(entry => entry.action === filter);
            }

            historyList.innerHTML = filteredHistory.map(entry => {
                const date = new Date(entry.timestamp);
                const timeString = date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
                
                let actionText = '';
                let actionIcon = '';
                
                switch (entry.action) {
                    case 'add':
                        actionText = 'Item Added';
                        actionIcon = '[+]';
                        break;
                    case 'edit':
                        actionText = 'Item Edited';
                        actionIcon = '[Edit]';
                        break;
                    case 'delete':
                        actionText = 'Item Deleted';
                        actionIcon = '[Delete]';
                        break;
                    case 'status':
                        actionText = 'Status Changed';
                        actionIcon = '[Status]';
                        break;
                    case 'balance_transaction':
                        actionText = 'Balance Transaction Added';
                        actionIcon = '[Balance+]';
                        break;
                    case 'balance_transaction_delete':
                        actionText = 'Balance Transaction Deleted';
                        actionIcon = '[Balance-]';
                        break;
                }

                let changesHtml = '';
                if (entry.changes && entry.changes.length > 0) {
                    changesHtml = `
                        <div style="margin-top: 8px; padding: 8px; background: #f8f9fa; border-radius: 4px; font-size: 0.9em;">
                            <strong>Changes made:</strong>
                            ${entry.changes.map(change => `
                                <div style="margin: 3px 0;">
                                    <strong>${change.field}:</strong>
                                    ${change.oldValue ? `<span style="color: #dc3545; text-decoration: line-through;">${change.oldValue}</span>` : ''}
                                    ${change.oldValue && change.newValue ? '  ' : ''}
                                    ${change.newValue ? `<span style="color: #28a745; font-weight: 600;">${change.newValue}</span>` : ''}
                                </div>
                            `).join('')}
                        </div>
                    `;
                }

                return `
                    <div style="background: white; border-radius: 8px; padding: 15px; margin-bottom: 10px; border-left: 4px solid #667eea; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <div style="font-weight: 700; font-size: 1.1em; color: #333;">${actionIcon} ${actionText}</div>
                            <div style="font-size: 0.85em; color: #666; font-weight: 600;">${timeString}</div>
                        </div>
                        <div style="font-size: 0.9em; color: #3498db; font-weight: 600; margin-bottom: 5px;">User: ${entry.user ? entry.user.charAt(0).toUpperCase() + entry.user.slice(1) : 'Unknown'}</div>
                        <div style="color: #555; font-size: 0.95em; line-height: 1.4;">
                            <span style="font-weight: 600; color: #333;">${entry.itemName}</span>
                            ${entry.itemNumber ? `<span style="color: #3498db; margin-left: 10px;">(${entry.itemNumber})</span>` : ''}
                        </div>
                        ${changesHtml}
                    </div>
                `;
            }).join('');
        }

        // Filter modal history
        function filterModalHistory() {
            const filter = document.getElementById('modalHistoryFilter').value;
            renderModalHistory(filter);
        }

        // Export to Excel function
        function exportToExcel() {
            try {
                // Create a new workbook
                const workbook = XLSX.utils.book_new();
                
                // Prepare inventory data
                const inventoryData = inventory.map((item, index) => {
                    const purchaseDate = new Date(item.purchaseDate);
                    const soldDate = item.soldDate ? new Date(item.soldDate) : '';
                    const daysInStock = Math.floor((soldDate ? soldDate : new Date() - purchaseDate) / (1000 * 60 * 60 * 24));
                    const profit = item.soldPrice - item.purchasePrice;
                    
                    return {
                        'Item Number': item.itemNumber || 'N/A',
                        'Item Name': item.name,
                        'Purchase Date': purchaseDate.toLocaleDateString(),
                        'Purchase Price': `${(item.purchasePrice || 0).toFixed(2)}`,
                        'Status': item.status === 'ready' ? 'Ready to Sell' : 
                                item.status === 'needs-work' ? 'Needs Work' : 'Sold',
                        'Sold Date': soldDate ? soldDate.toLocaleDateString() : 'Not Sold',
                        'Sold Price': (item.soldPrice || 0) > 0 ? `${(item.soldPrice || 0).toFixed(2)}` : 'Not Sold',
                        'Profit': (item.soldPrice || 0) > 0 ? `${((item.soldPrice || 0) - (item.purchasePrice || 0)).toFixed(2)}` : 'N/A',
                        'Days in Stock': daysInStock,
                        'Description': item.description || '',
                        'Work Notes': item.workNotes || '',
                        'Photos Count': (item.photos ? item.photos.length : 0),
                        'Work Photos Count': (item.workPhotos ? item.workPhotos.length : 0)
                    };
                });
                
                // Create inventory worksheet
                const inventorySheet = XLSX.utils.json_to_sheet(inventoryData);
                XLSX.utils.book_append_sheet(workbook, inventorySheet, 'Inventory');
                
                // Prepare transaction data
                const transactionData = transactions.map(t => ({
                    'Date': new Date(t.date).toLocaleDateString(),
                    'Description': t.description,
                    'Type': t.type === 'income' ? 'Income' : 'Expense',
                    'Amount': `${(t.amount || 0).toFixed(2)}`,
                    'Added By': currentUser ? currentUser.charAt(0).toUpperCase() + currentUser.slice(1) : 'Unknown'
                }));
                
                // Create transactions worksheet
                if (transactionData.length > 0) {
                    const transactionSheet = XLSX.utils.json_to_sheet(transactionData);
                    XLSX.utils.book_append_sheet(workbook, transactionSheet, 'Transactions');
                }
                
                // Prepare edit history data
                const historyData = editHistory.map(entry => ({
                    'Date': new Date(entry.timestamp).toLocaleDateString(),
                    'Time': new Date(entry.timestamp).toLocaleTimeString(),
                    'User': entry.user ? entry.user.charAt(0).toUpperCase() + entry.user.slice(1) : 'Unknown',
                    'Action': entry.action === 'add' ? 'Item Added' :
                             entry.action === 'edit' ? 'Item Edited' :
                             entry.action === 'delete' ? 'Item Deleted' :
                             entry.action === 'status' ? 'Status Changed' : entry.action,
                    'Item Name': entry.itemName,
                    'Item Number': entry.itemNumber || 'N/A',
                    'Changes': entry.changes ? entry.changes.map(c => `${c.field}: ${c.oldValue || 'N/A'}  ${c.newValue || 'N/A'}`).join('; ') : 'N/A'
                }));
                
                // Create history worksheet
                if (historyData.length > 0) {
                    const historySheet = XLSX.utils.json_to_sheet(historyData);
                    XLSX.utils.book_append_sheet(workbook, historySheet, 'Edit History');
                }
                
                // Prepare summary statistics
                let moneyIn = 0, moneyOut = 0, totalItems = inventory.length;
                let readyItems = 0, needsWorkItems = 0, soldItems = 0;
                
                inventory.forEach(item => {
                    // Include purchase price in balance if affectBalance is true or undefined (existing items default to true)
                    if (item.affectBalance === true || item.affectBalance === undefined) {
                        moneyOut += item.purchasePrice;
                    }
                    // Sold items are NOT automatically added to balance - they must be manually added through transactions
                    
                    if (item.status === 'sold') soldItems++;
                    else if (item.status === 'ready') readyItems++;
                    else if (item.status === 'needs-work') needsWorkItems++;
                });
                
                let additionalIncome = 0, additionalExpenses = 0;
                transactions.forEach(t => {
                    if (t.type === 'income') additionalIncome += t.amount;
                    else additionalExpenses += t.amount;
                });
                
                // Calculate profit only from sold items
                let soldItemsCost = 0;
                let soldItemsRevenue = 0;
                inventory.forEach(item => {
                    if (item.status === 'sold' && item.soldPrice > 0) {
                        // Always include revenue and cost for sold items in profit calculation
                            soldItemsRevenue += item.soldPrice;
                            soldItemsCost += item.purchasePrice;
                    }
                });
                const totalProfit = soldItemsRevenue - soldItemsCost;
                const totalBalance = moneyIn - moneyOut + additionalIncome - additionalExpenses;
                
                const summaryData = [
                    { 'Metric': 'Total Items', 'Value': totalItems },
                    { 'Metric': 'Ready to Sell', 'Value': readyItems },
                    { 'Metric': 'Needs Work', 'Value': needsWorkItems },
                    { 'Metric': 'Sold Items', 'Value': soldItems },
                    { 'Metric': 'Total Money In (Sales)', 'Value': `${(moneyIn || 0).toFixed(2)}` },
                    { 'Metric': 'Total Money Out (Purchases)', 'Value': `${(moneyOut || 0).toFixed(2)}` },
                    { 'Metric': 'Additional Income', 'Value': `${(additionalIncome || 0).toFixed(2)}` },
                    { 'Metric': 'Additional Expenses', 'Value': `${(additionalExpenses || 0).toFixed(2)}` },
                    { 'Metric': 'Total Profit', 'Value': `${(totalProfit || 0).toFixed(2)}` },
                    { 'Metric': 'Current Balance', 'Value': `${(totalBalance || 0).toFixed(2)}` },
                    { 'Metric': 'Export Date', 'Value': new Date().toLocaleString() },
                    { 'Metric': 'Exported By', 'Value': currentUser ? currentUser.charAt(0).toUpperCase() + currentUser.slice(1) : 'Unknown' }
                ];
                
                // Create summary worksheet
                const summarySheet = XLSX.utils.json_to_sheet(summaryData);
                XLSX.utils.book_append_sheet(workbook, summarySheet, 'Summary');
                
                // Generate filename with current date
                const currentDate = new Date().toISOString().split('T')[0];
                const filename = `Furniture_Inventory_${currentDate}.xlsx`;
                
                // Save the file
                XLSX.writeFile(workbook, filename);
                
                // Show success message
                alert(`Excel file "${filename}" has been downloaded successfully!`);
                
            } catch (error) {
                console.error('Error exporting to Excel:', error);
                alert('Error exporting to Excel. Please try again.');
            }
        }

        // Initialize variables first
        let inventory = [];
        let editingIndex = -1;
        let currentFullViewItemNumber = null;
        let transactions = [];
        let currentPhotoIndex = 0;
        let currentItemPhotos = [];
        let editHistory = [];

        // Initialize authentication on page load
        checkAuth();

        // Generate random item number
        function generateItemNumber() {
            const prefix = 'FUR';
            const randomNum = Math.floor(100000 + Math.random() * 900000);
            return `${prefix}-${randomNum}`;
        }

        // History management functions
        function addHistoryEntry(action, itemName, itemNumber, changes = null, oldItem = null) {
            // Ensure we have valid values
            const safeItemName = itemName || 'Unknown Item';
            const safeItemNumber = itemNumber || 'N/A';
            const safeUser = currentUser || 'Unknown User';
            
            const historyEntry = {
                id: Date.now(),
                timestamp: new Date().toISOString(),
                user: safeUser,
                action: action,
                itemName: safeItemName,
                itemNumber: safeItemNumber,
                changes: changes,
                oldItem: oldItem
            };
            
            editHistory.unshift(historyEntry); // Add to beginning
            saveHistory(); // Keep as non-async for now to avoid breaking other calls
            
            // Update history display if we're on the history tab
            if (document.getElementById('history').classList.contains('active')) {
                renderHistory();
            }
        }

        // Save history to Supabase
        async function saveHistory() {
            try {
                // Convert history to database format with validation
                const historyToSave = editHistory.map(entry => ({
                    action: entry.action || 'unknown',
                    item_name: entry.itemName || 'Unknown Item',
                    item_number: entry.itemNumber || 'N/A',
                    changes: entry.changes ? JSON.stringify(entry.changes) : null,
                    old_values: entry.oldValues ? JSON.stringify(entry.oldValues) : null,
                    user_name: entry.user || currentUser || 'Unknown User'
                })).filter(entry => entry.item_name !== 'Unknown Item' || entry.action !== 'unknown');

                // Clear existing data and insert new data
                const { error: deleteError } = await supabaseClient
                    .from('edit_history')
                    .delete()
                    .neq('id', 0); // Delete all records

                if (deleteError) {
                    console.error('Error clearing history:', deleteError);
                }

                if (historyToSave.length > 0) {
                    const { error: insertError } = await supabaseClient
                        .from('edit_history')
                        .insert(historyToSave);

                    if (insertError) {
                        console.error('Error saving history:', insertError);
                        console.error('History data that failed:', historyToSave);
                        console.error('Error details:', {
                            message: insertError.message,
                            details: insertError.details,
                            hint: insertError.hint,
                            code: insertError.code
                        });
                    } else {
                        console.log(' History saved successfully');
                    }
                }
            } catch (error) {
                console.error('Error saving history:', error);
            }
        }

        // Load history from Supabase
        async function loadHistory() {
            try {
                const { data: historyData, error: historyError } = await supabaseClient
                    .from('edit_history')
                    .select('*')
                    .order('timestamp', { ascending: false });

                if (historyError) {
                    console.error('Error loading history:', historyError);
                    editHistory = [];
                } else {
                    editHistory = historyData || [];
                }
            } catch (error) {
                console.error('Error loading history:', error);
                editHistory = [];
            }
        }

        function clearHistory() {
            if (confirm('Are you sure you want to clear all edit history? This cannot be undone.')) {
                editHistory = [];
                saveHistory(); // Keep as non-async for now
                renderHistory();
            }
        }

        function filterHistory() {
            const filter = document.getElementById('historyFilter').value;
            renderHistory(filter);
        }

        function renderHistory(filter = 'all') {
            const historyList = document.getElementById('historyList');
            
            if (editHistory.length === 0) {
                historyList.innerHTML = `
                    <div class="empty-history">
                        <h3>No edit history yet</h3>
                        <p>Changes to inventory items will be tracked here</p>
                    </div>
                `;
                return;
            }

            let filteredHistory = editHistory;
            if (filter !== 'all') {
                filteredHistory = editHistory.filter(entry => entry.action === filter);
            }

            historyList.innerHTML = filteredHistory.map(entry => {
                const date = new Date(entry.timestamp);
                const timeString = date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
                
                let actionText = '';
                let actionIcon = '';
                
                switch (entry.action) {
                    case 'add':
                        actionText = 'Item Added';
                        actionIcon = '[+]';
                        break;
                    case 'edit':
                        actionText = 'Item Edited';
                        actionIcon = '[Edit]';
                        break;
                    case 'delete':
                        actionText = 'Item Deleted';
                        actionIcon = '[Delete]';
                        break;
                    case 'status':
                        actionText = 'Status Changed';
                        actionIcon = '[Status]';
                        break;
                    case 'balance_transaction':
                        actionText = 'Balance Transaction Added';
                        actionIcon = '[Balance+]';
                        break;
                    case 'balance_transaction_delete':
                        actionText = 'Balance Transaction Deleted';
                        actionIcon = '[Balance-]';
                        break;
                }

                let changesHtml = '';
                if (entry.changes && entry.changes.length > 0) {
                    changesHtml = `
                        <div class="history-changes">
                            <strong>Changes made:</strong>
                            ${entry.changes.map(change => `
                                <div class="change-item">
                                    <strong>${change.field}:</strong>
                                    ${change.oldValue ? `<span class="change-old">${change.oldValue}</span>` : ''}
                                    ${change.oldValue && change.newValue ? '  ' : ''}
                                    ${change.newValue ? `<span class="change-new">${change.newValue}</span>` : ''}
                                </div>
                            `).join('')}
                        </div>
                    `;
                }

                return `
                    <div class="history-entry ${entry.action}">
                        <div class="history-header">
                            <div class="history-action">${actionIcon} ${actionText}</div>
                            <div class="history-timestamp">${timeString}</div>
                        </div>
                        <div class="history-user"> ${entry.user ? entry.user.charAt(0).toUpperCase() + entry.user.slice(1) : 'Unknown'}</div>
                        <div class="history-details">
                            <span class="history-item-name">${entry.itemName}</span>
                            ${entry.itemNumber ? `<span style="color: #3498db; margin-left: 10px;">(${entry.itemNumber})</span>` : ''}
                        </div>
                        ${changesHtml}
                    </div>
                `;
            }).join('');
        }

        function detectChanges(oldItem, newItem) {
            const changes = [];
            
            const fields = ['name', 'purchaseDate', 'purchasePrice', 'soldDate', 'soldPrice', 'status', 'description', 'workNotes'];
            
            fields.forEach(field => {
                const oldValue = oldItem[field];
                const newValue = newItem[field];
                
                if (oldValue !== newValue) {
                    let displayOldValue = oldValue;
                    let displayNewValue = newValue;
                    
                    // Format values for display
                    if (field === 'purchaseDate' || field === 'soldDate') {
                        displayOldValue = oldValue ? new Date(oldValue).toLocaleDateString() : 'Not set';
                        displayNewValue = newValue ? new Date(newValue).toLocaleDateString() : 'Not set';
                    } else if (field === 'purchasePrice' || field === 'soldPrice') {
                        displayOldValue = oldValue ? `${parseFloat(oldValue).toFixed(2)}` : 'Not set';
                        displayNewValue = newValue ? `${parseFloat(newValue).toFixed(2)}` : 'Not set';
                    } else if (field === 'status') {
                        const statusMap = {
                            'ready': 'Ready to Sell',
                            'needs-work': 'Needs Work',
                            'sold': 'Sold'
                        };
                        displayOldValue = statusMap[oldValue] || oldValue;
                        displayNewValue = statusMap[newValue] || newValue;
                    }
                    
                    changes.push({
                        field: field.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase()),
                        oldValue: displayOldValue,
                        newValue: displayNewValue
                    });
                }
            });
            
            return changes;
        }

        // Load inventory from JSONBin.io with localStorage fallback
        async function loadInventory() {
            try {
                console.log(' Loading data...');
                
                // First, try to load from localStorage (instant)
                let localData = null;
                try {
                    const backupStr = localStorage.getItem('furniture_inventory_backup');
                    const transBackupStr = localStorage.getItem('furniture_transactions_backup');
                    const backupTimestamp = localStorage.getItem('furniture_backup_timestamp');
                    
                    if (backupStr) {
                        localData = {
                            inventory: JSON.parse(backupStr),
                            transactions: transBackupStr ? JSON.parse(transBackupStr) : []
                        };
                        console.log(' Found localStorage backup:', localData.inventory.length, 'items, saved at:', backupTimestamp);
                    }
                } catch (localError) {
                    console.error(' Error reading localStorage:', localError);
                }
                
                // Try to load from JSONBin.io (cloud)
                console.log(' Loading from cloud...');
                const cloudData = await jsonBinLoad();
                
                if (cloudData && cloudData.inventory) {
                    // Cloud data found
                    inventory = cloudData.inventory || [];
                    transactions = cloudData.transactions || [];
                    console.log('  Loaded from cloud:', inventory.length, 'items,', transactions.length, 'transactions');
                    
                    // Update localStorage with cloud data
                    try {
                        localStorage.setItem('furniture_inventory_backup', JSON.stringify(inventory));
                        localStorage.setItem('furniture_transactions_backup', JSON.stringify(transactions));
                        localStorage.setItem('furniture_backup_timestamp', new Date().toISOString());
                    } catch (e) {}
                    
                } else if (localData) {
                    // No cloud data, use local backup
                    inventory = localData.inventory || [];
                    transactions = localData.transactions || [];
                    console.log(' Using localStorage backup:', inventory.length, 'items');
                    
                    // Sync local data to cloud
                    if (inventory.length > 0 || transactions.length > 0) {
                        console.log(' Syncing local data to cloud...');
                        setTimeout(() => saveInventory(), 1000);
                    }
                    } else {
                    // No data anywhere, start fresh
                        inventory = [];
                    transactions = [];
                    console.log(' No data found - starting fresh');
                }
                
                // Assign item numbers to items that don't have one
                    let needsSave = false;
                    inventory.forEach(item => {
                        if (!item.itemNumber) {
                            item.itemNumber = generateItemNumber();
                            needsSave = true;
                        }
                    });
                    if (needsSave) {
                        await saveInventory();
                }
                
                // Update UI
                renderInventory();
                updateStatistics();
                console.log(' UI updated with loaded data');
                
            } catch (error) {
                console.error(' Error loading data:', error);
                
                // Final fallback to localStorage
                try {
                    const backupStr = localStorage.getItem('furniture_inventory_backup');
                    const transBackupStr = localStorage.getItem('furniture_transactions_backup');
                    inventory = backupStr ? JSON.parse(backupStr) : [];
                    transactions = transBackupStr ? JSON.parse(transBackupStr) : [];
                    console.log(' Recovered from localStorage:', inventory.length, 'items');
                } catch (localError) {
                inventory = [];
                transactions = [];
                }
                
                renderInventory();
                updateStatistics();
            }
        }

        // Save inventory to JSONBin.io + localStorage backup
        async function saveInventory() {
            try {
                console.log(' Saving inventory...', inventory.length, 'items');
                
                // Check for any invalid items
                inventory.forEach((item, index) => {
                    if (!item || !item.name || !item.purchaseDate || isNaN(item.purchasePrice)) {
                        console.error(` Invalid item at index ${index}:`, item);
                    }
                });
                
                // Filter out any undefined/null items before saving
                const validInventory = inventory.filter(item => 
                    item && item.name && item.purchaseDate && !isNaN(item.purchasePrice)
                );
                
                if (validInventory.length !== inventory.length) {
                    console.log(` Filtered out ${inventory.length - validInventory.length} invalid items`);
                    inventory = validInventory;
                }
                
                // ========== LOCALSTORAGE BACKUP ==========
                try {
                    localStorage.setItem('furniture_inventory_backup', JSON.stringify(inventory));
                    localStorage.setItem('furniture_transactions_backup', JSON.stringify(transactions));
                    localStorage.setItem('furniture_backup_timestamp', new Date().toISOString());
                    console.log('  Saved backup to localStorage');
                } catch (localError) {
                    console.error(' Failed to save localStorage backup:', localError);
                }
                
                // ========== JSONBIN.IO CLOUD SAVE ==========
                const cloudData = {
                    inventory: inventory,
                    transactions: transactions,
                    lastUpdated: new Date().toISOString()
                };
                
                const cloudSaved = await jsonBinSave(cloudData);
                if (cloudSaved) {
                    console.log('  Data synced to cloud - accessible from all devices!');
                    } else {
                    console.log('  Cloud save failed - data safe in localStorage');
                    }
                
            } catch (error) {
                console.error(' Error saving inventory:', error);
                console.log(' Data is still safe in localStorage backup');
            }
        }

        // Save transactions (uses the unified saveInventory function)
        async function saveTransactions() {
            // Save everything together to JSONBin.io
            await saveInventory();
        }

        // Switch between tabs
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
            
            if (tabName === 'statistics') {
                updateStatistics();
            } else if (tabName === 'history') {
                renderHistory();
            }
        }

        // Add new item
        function addItem() {
            const name = document.getElementById('itemName').value;
            const purchaseDate = document.getElementById('purchaseDate').value;
            const purchasePrice = parseFloat(document.getElementById('purchasePrice').value);
            const affectBalance = document.getElementById('affectBalance').value;
            const status = document.getElementById('itemStatus').value;
            const description = document.getElementById('itemDescription').value;
            const workNotes = document.getElementById('itemWorkNotes').value;
            const photoInput = document.getElementById('itemPhoto');
            const workPhotoInput = document.getElementById('workPhotos');

            if (!name || !purchaseDate || isNaN(purchasePrice)) {
                alert('Please fill in all required fields (Name, Purchase Date, Purchase Price)');
                return;
            }

            const item = {
                id: Date.now(),
                itemNumber: generateItemNumber(),
                name,
                purchaseDate,
                purchasePrice,
                affectBalance: affectBalance === 'yes',
                status,
                description,
                workNotes: workNotes || '',
                soldDate: '',
                soldPrice: 0,
                photos: [],
                workPhotos: []
            };

            let photosLoaded = false;
            let workPhotosLoaded = false;

            // Function to check if all photos are loaded, then upload to ImgBB
            const checkAllLoaded = async () => {
                if (photosLoaded && workPhotosLoaded) {
                    // Upload photos to ImgBB before saving
                    if (item.photos.length > 0) {
                        console.log(' Uploading', item.photos.length, 'main photos to ImgBB...');
                        item.photos = await uploadMultipleToImgBB(item.photos);
                    }
                    if (item.workPhotos.length > 0) {
                        console.log(' Uploading', item.workPhotos.length, 'work photos to ImgBB...');
                        item.workPhotos = await uploadMultipleToImgBB(item.workPhotos);
                    }
                    
                    inventory.push(item);
                    await saveInventory();
                    
                    // Add to history
                    addHistoryEntry('add', item.name, item.itemNumber);
                    
                    renderInventory();
                    clearForm();
                    console.log(' Item added with cloud-hosted images!');
                }
            };

            // Handle main image uploads
            if (photoInput.files && photoInput.files.length > 0) {
                let loadedCount = 0;
                const totalFiles = photoInput.files.length;
                
                for (let i = 0; i < totalFiles; i++) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        item.photos.push(e.target.result);
                        loadedCount++;
                        
                        if (loadedCount === totalFiles) {
                            photosLoaded = true;
                            checkAllLoaded();
                        }
                    };
                    reader.readAsDataURL(photoInput.files[i]);
                }
            } else {
                photosLoaded = true;
            }

            // Handle work photo uploads
            if (workPhotoInput.files && workPhotoInput.files.length > 0) {
                let loadedCount = 0;
                const totalFiles = workPhotoInput.files.length;
                
                for (let i = 0; i < totalFiles; i++) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        item.workPhotos.push(e.target.result);
                        loadedCount++;
                        
                        if (loadedCount === totalFiles) {
                            workPhotosLoaded = true;
                            checkAllLoaded();
                        }
                    };
                    reader.readAsDataURL(workPhotoInput.files[i]);
                }
            } else {
                workPhotosLoaded = true;
            }

            // Check if we can proceed immediately
            checkAllLoaded();
        }

        // Clear form
        function clearForm() {
            document.getElementById('itemName').value = '';
            document.getElementById('purchaseDate').value = '';
            document.getElementById('purchasePrice').value = '';
            document.getElementById('affectBalance').value = 'yes';
            document.getElementById('itemStatus').value = 'ready';
            document.getElementById('itemDescription').value = '';
            document.getElementById('itemWorkNotes').value = '';
            document.getElementById('itemPhoto').value = '';
            document.getElementById('workPhotos').value = '';
            
            // Switch to inventory tab to show the new item
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.querySelector('.tab[onclick*="inventory"]').classList.add('active');
            document.getElementById('inventory').classList.add('active');
        }

        // Render inventory
        // Search/filter helper function
        function matchesSearch(item, searchTerm) {
            if (!searchTerm) return true;
            const term = searchTerm.toLowerCase();
            return (
                (item.name && item.name.toLowerCase().includes(term)) ||
                (item.itemNumber && item.itemNumber.toLowerCase().includes(term)) ||
                (item.description && item.description.toLowerCase().includes(term)) ||
                (item.workNotes && item.workNotes.toLowerCase().includes(term))
            );
        }

        // Filter inventory based on search
        function filterInventory() {
            renderInventory();
            
            // Update clear button visibility for each search field
            ['inventorySearch', 'needsWorkSearch', 'soldSearch'].forEach(id => {
                const input = document.getElementById(id);
                const clearBtn = input?.nextElementSibling;
                if (input && clearBtn) {
                    clearBtn.style.display = input.value ? 'flex' : 'none';
                }
            });
        }

        // Clear search input
        function clearSearch(inputId) {
            const input = document.getElementById(inputId);
            if (input) {
                input.value = '';
                filterInventory();
                input.focus();
            }
        }

        function renderInventory() {
            const inventoryList = document.getElementById('inventoryList');
            const needsWorkList = document.getElementById('needsWorkList');
            const soldList = document.getElementById('soldList');
            
            // Get search terms
            const inventorySearchTerm = document.getElementById('inventorySearch')?.value || '';
            const needsWorkSearchTerm = document.getElementById('needsWorkSearch')?.value || '';
            const soldSearchTerm = document.getElementById('soldSearch')?.value || '';
            
            // Separate items by status and apply search filter
            const readyItems = inventory.filter(item => item.status === 'ready' && matchesSearch(item, inventorySearchTerm));
            const needsWorkItems = inventory.filter(item => item.status === 'needs-work' && matchesSearch(item, needsWorkSearchTerm));
            const soldItems = inventory.filter(item => item.status === 'sold' && matchesSearch(item, soldSearchTerm));
            
            // Get total counts (without search filter) for showing search results info
            const totalReady = inventory.filter(item => item.status === 'ready').length;
            const totalNeedsWork = inventory.filter(item => item.status === 'needs-work').length;
            const totalSold = inventory.filter(item => item.status === 'sold').length;
            
            // Render ready to sell inventory
            if (totalReady === 0) {
                inventoryList.innerHTML = `
                    <div class="empty-state">
                        <h3>No items ready to sell</h3>
                        <p>Items marked as "Ready to Sell" will appear here!</p>
                    </div>
                `;
            } else if (readyItems.length === 0 && inventorySearchTerm) {
                inventoryList.innerHTML = `
                    <div class="search-results-info">No items found matching "${inventorySearchTerm}"</div>
                    <div class="empty-state">
                        <h3> No matching items</h3>
                        <p>Try a different search term</p>
                    </div>
                `;
            } else {
                const searchInfo = inventorySearchTerm ? `<div class="search-results-info">Showing ${readyItems.length} of ${totalReady} items</div>` : '';
                inventoryList.innerHTML = searchInfo + '<div class="inventory-list">' +
                    readyItems.map((item, idx) => {
                        const index = inventory.indexOf(item);
                        return renderItemList(item, index);
                    }).join('') +
                    '</div>';
            }
            
            // Render needs work items
            if (totalNeedsWork === 0) {
                needsWorkList.innerHTML = `
                    <div class="empty-state">
                        <h3>No items need work</h3>
                        <p>Items marked as "Needs Work" will appear here!</p>
                    </div>
                `;
            } else if (needsWorkItems.length === 0 && needsWorkSearchTerm) {
                needsWorkList.innerHTML = `
                    <div class="search-results-info">No items found matching "${needsWorkSearchTerm}"</div>
                    <div class="empty-state">
                        <h3> No matching items</h3>
                        <p>Try a different search term</p>
                    </div>
                `;
            } else {
                const searchInfo = needsWorkSearchTerm ? `<div class="search-results-info">Showing ${needsWorkItems.length} of ${totalNeedsWork} items</div>` : '';
                needsWorkList.innerHTML = `
                    ${searchInfo}
                    <div style="background: #e8f4fd; border: 1px solid #b3d9ff; border-radius: 8px; padding: 15px; margin-bottom: 20px; text-align: center;">
                        <div style="color: #0066cc; font-weight: 600; margin-bottom: 5px;"> Job Queue</div>
                        <div style="color: #666; font-size: 0.9em;">Hover over items to see  buttons for reordering (1 = highest priority)</div>
                    </div>
                    <div class="inventory-list">` +
                    needsWorkItems.map((item, idx) => {
                        const index = inventory.indexOf(item);
                        return renderItemList(item, index, true); // Make reorderable
                    }).join('') +
                    '</div>';
            }
            
            // Render sold items
            if (totalSold === 0) {
                soldList.innerHTML = `
                    <div class="empty-state">
                        <h3>No sold items yet</h3>
                        <p>Items marked as sold will appear here!</p>
                    </div>
                `;
            } else if (soldItems.length === 0 && soldSearchTerm) {
                soldList.innerHTML = `
                    <div class="search-results-info">No items found matching "${soldSearchTerm}"</div>
                    <div class="empty-state">
                        <h3> No matching items</h3>
                        <p>Try a different search term</p>
                    </div>
                `;
            } else {
                const searchInfo = soldSearchTerm ? `<div class="search-results-info">Showing ${soldItems.length} of ${totalSold} items</div>` : '';
                soldList.innerHTML = searchInfo + '<div class="inventory-list">' +
                    soldItems.map((item, idx) => {
                        const index = inventory.indexOf(item);
                        return renderItemList(item, index);
                    }).join('') +
                    '</div>';
            }
        }

        // Render individual item card
        // Render item in list view (card style for 3-column grid)
        function renderItemList(item, index, isDraggable = false) {
            const photos = item.photos && item.photos.length > 0 ? item.photos : 
                          (item.photo ? [item.photo] : []);
            
            const statusClass = item.status === 'sold' ? 'status-sold' : 
                               item.status === 'ready' ? 'status-ready' : 'status-needs-work';
            const statusText = item.status === 'sold' ? 'Sold' : 
                              item.status === 'ready' ? 'Ready' : 'Needs Work';
            
            const currentPrice = item.soldPrice > 0 ? item.soldPrice : item.purchasePrice;
            const priceLabel = item.soldPrice > 0 ? 'Sold for' : 'Purchase Price';
            
            // Add reorder buttons for "Not Ready" items
            const reorderButtons = isDraggable ? `
                <div class="reorder-buttons">
                    <button onclick="moveItemUp(${index}); event.stopPropagation();" class="reorder-btn up-btn" title="Move Up"></button>
                    <button onclick="moveItemDown(${index}); event.stopPropagation();" class="reorder-btn down-btn" title="Move Down"></button>
                </div>
            ` : '';
            
            const itemClass = isDraggable ? 'inventory-list-item reorderable-item' : 'inventory-list-item';
            const borderColor = item.status === 'ready' ? 'var(--success)' : item.status === 'sold' ? 'var(--text-muted)' : 'var(--warning)';
            
            return `
                <div class="${itemClass}" onclick="openFullViewModal(${index})" style="border-left-color: ${borderColor};">
                    
                    <!-- Priority Indicator (for reorderable items) -->
                    ${isDraggable ? `<div class="priority-indicator">${index + 1}</div>` : ''}
                    
                    <!-- Reorder Buttons (for reorderable items) -->
                    ${reorderButtons}
                    
                    <!-- Photo -->
                    <div class="item-photo-container">
                        ${photos.length > 0 ? `
                            <img src="${photos[0]}" alt="${item.name}" class="item-photo">
                        ` : `
                            <div class="item-no-photo"></div>
                        `}
                    </div>
                    
                    <!-- Status Badge -->
                    <span class="status-badge item-status ${statusClass}">${statusText}</span>
                    
                    <!-- Item Name -->
                    <h3 class="item-name">${item.name}</h3>
                    
                    <!-- Item Number -->
                    <div class="item-number">
                        #${item.itemNumber || 'N/A'}
                    </div>
                    
                    <!-- Price & Date -->
                    <div class="item-footer">
                        <div class="item-price">
                            ${(currentPrice || 0).toFixed(2)}
                        </div>
                        <div class="item-date">
                            ${new Date(item.purchaseDate).toLocaleDateString()}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderItemCard(item, index) {
            const statusClass = item.status === 'sold' ? 'status-sold' : 
                               item.status === 'ready' ? 'status-ready' : 'status-needs-work';
            const statusText = item.status === 'sold' ? 'Sold' : 
                              item.status === 'ready' ? 'Ready to Sell' : 'Needs Work';
            
            const profit = item.soldPrice - item.purchasePrice;
            
            // Calculate days in stock
            const purchaseDate = new Date(item.purchaseDate);
            const endDate = item.soldDate ? new Date(item.soldDate) : new Date();
            const daysInStock = Math.floor((endDate - purchaseDate) / (1000 * 60 * 60 * 24));
            
            // Handle both old single photo format and new photos array
            const photos = item.photos && item.photos.length > 0 ? item.photos : 
                          (item.photo ? [item.photo] : []);
            
            return `
                <div class="inventory-card">
                            ${photos.length > 0 ? `
                                <div class="photo-gallery" onclick="openPhotoModal(${index}, 0)">
                                    <img src="${photos[0]}" alt="${item.name}">
                                    ${photos.length > 1 ? `<div class="photo-counter">${photos.length} Photos</div>` : ''}
                                </div>
                            ` : `<div class="item-image" style="display: flex; align-items: center; justify-content: center; font-size: 3em; color: #bdc3c7;">No Image</div>`}
                            <div class="item-details">
                                <div class="item-name">${item.name}</div>
                                <div class="item-info" style="color: #3498db; font-weight: 600; margin-bottom: 10px;">Item: ${item.itemNumber || 'N/A'}</div>
                                <div class="item-info"><strong>Purchased:</strong> ${new Date(item.purchaseDate).toLocaleDateString()} - ${(item.purchasePrice || 0).toFixed(2)}</div>
                                <div class="item-info" style="background: ${item.soldDate ? '#f0f0f0' : '#fff3cd'}; padding: 8px; border-radius: 6px; margin: 8px 0;">
                                    <strong>Days in Stock:</strong> <span style="font-weight: 700; color: ${daysInStock > 90 ? '#e74c3c' : daysInStock > 30 ? '#f39c12' : '#27ae60'};">${daysInStock} days</span>
                                </div>
                                ${item.soldDate ? `
                                    <div class="item-info"><strong>Sold:</strong> ${new Date(item.soldDate).toLocaleDateString()} - ${(item.soldPrice || 0).toFixed(2)}</div>
                                    <div style="background: ${profit >= 0 ? '#d4edda' : '#f8d7da'}; padding: 12px; border-radius: 8px; margin: 10px 0; border-left: 4px solid ${profit >= 0 ? '#28a745' : '#dc3545'};">
                                        <div style="font-size: 0.9em; color: #666; margin-bottom: 4px;">Total Profit</div>
                                        <div style="font-size: 1.5em; font-weight: 700; color: ${profit >= 0 ? '#28a745' : '#dc3545'};">${(profit || 0).toFixed(2)}</div>
                                    </div>
                                ` : ''}
                                ${item.description ? `<div class="item-info" style="margin-top: 10px;">${item.description}</div>` : ''}
                                ${(item.workPhotos && item.workPhotos.length > 0) || item.workNotes ? `
                                    <div class="work-notes-box">
                                        <strong>Work Required:</strong>
                                        ${item.workPhotos && item.workPhotos.length > 0 ? `
                                            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 8px; margin-top: 10px;">
                                                ${item.workPhotos.map((photo, photoIdx) => `
                                                    <div style="position: relative; cursor: pointer;" onclick="openWorkPhotoModal(${index}, ${photoIdx})">
                                                        <img src="${photo}" style="width: 100%; height: 80px; object-fit: cover; border-radius: 6px; border: 2px solid #ffc107;">
                                                    </div>
                                                `).join('')}
                                            </div>
                                            <div style="font-size: 0.85em; color: #856404; margin-top: 8px;">
                                                ${item.workPhotos.length} photo${item.workPhotos.length > 1 ? 's' : ''} showing work needed
                                            </div>
                                        ` : ''}
                                        ${item.workNotes ? `<p style="margin-top: 8px;">${item.workNotes}</p>` : ''}
                                    </div>
                                ` : ''}
                                <div class="status-badge ${statusClass}">${statusText}</div>
                                <div class="item-actions">
                                    <button class="btn btn-warning" onclick="editItem(${index})">Edit</button>
                                    <button class="btn btn-danger" onclick="deleteItem(${index})">Delete</button>
                                </div>
                            </div>
                        </div>
            `;
        }

        // Edit item
        function editItem(index) {
            console.log('editItem called with index:', index);
            editingIndex = index;
            const item = inventory[index];
            
            console.log('Editing item:', item.name);
            
            document.getElementById('editItemNumber').value = item.itemNumber || 'N/A';
            document.getElementById('editItemName').value = item.name;
            document.getElementById('editPurchaseDate').value = item.purchaseDate;
            document.getElementById('editPurchasePrice').value = item.purchasePrice;
            document.getElementById('editAffectBalance').value = (item.affectBalance === true || item.affectBalance === undefined) ? 'yes' : 'no';
            document.getElementById('editSoldDate').value = item.soldDate || '';
            document.getElementById('editSoldPrice').value = item.soldPrice || '';
            document.getElementById('editAddToBalance').value = (item.addToBalance === true || item.addToBalance === undefined) ? 'yes' : 'no';
            document.getElementById('editItemStatus').value = item.status;
            document.getElementById('editItemDescription').value = item.description || '';
            document.getElementById('editItemWorkNotes').value = item.workNotes || '';
            
            // Display existing main photos
            displayEditMainPhotos();
            
            // Display existing work photos
            displayEditWorkPhotos();
            
            document.getElementById('editModal').classList.add('active');
        }

        // Display main photos in edit modal
        function displayEditMainPhotos() {
            if (editingIndex === -1) return;
            
            const item = inventory[editingIndex];
            const previewDiv = document.getElementById('editMainPhotosPreview');
            
            if (!item.photos || item.photos.length === 0) {
                previewDiv.innerHTML = '';
                return;
            }
            
            previewDiv.innerHTML = item.photos.map((photo, index) => `
                <div style="position: relative;">
                    <img src="${photo}" style="width: 100%; height: 100px; object-fit: cover; border-radius: 6px; border: 2px solid #667eea;">
                    <button onclick="removeEditMainPhoto(${index})" style="position: absolute; top: 5px; right: 5px; background: #dc3545; color: white; border: none; border-radius: 50%; width: 20px; height: 20px; font-size: 12px; cursor: pointer;"></button>
                </div>
            `).join('');
        }

        // Remove main photo from edit
        function removeEditMainPhoto(index) {
            if (editingIndex === -1) return;
            
            const item = inventory[editingIndex];
            item.photos.splice(index, 1);
            displayEditMainPhotos();
        }

        // Display work photos in edit modal
        function displayEditWorkPhotos() {
            const item = inventory[editingIndex];
            const previewDiv = document.getElementById('editWorkPhotosPreview');
            
            if (!item.workPhotos || item.workPhotos.length === 0) {
                previewDiv.innerHTML = '';
                return;
            }
            
            previewDiv.innerHTML = item.workPhotos.map((photo, idx) => `
                <div style="position: relative;">
                    <img src="${photo}" style="width: 100%; height: 100px; object-fit: cover; border-radius: 6px; border: 2px solid #ffc107;">
                    <button onclick="deleteWorkPhoto(${idx}); event.stopPropagation();" 
                            style="position: absolute; top: 5px; right: 5px; background: #dc3545; color: white; border: none; border-radius: 50%; width: 25px; height: 25px; cursor: pointer; font-size: 14px; line-height: 1;">
                        
                    </button>
                </div>
            `).join('');
        }

        // Delete work photo
        function deleteWorkPhoto(photoIndex) {
            if (confirm('Delete this work photo?')) {
                const item = inventory[editingIndex];
                item.workPhotos.splice(photoIndex, 1);
                displayEditWorkPhotos();
                saveInventory(); // Keep as non-async for now
            }
        }

        // Save edit
        function saveEdit() {
            console.log(' saveEdit called, editingIndex:', editingIndex);
            alert(' saveEdit called, editingIndex: ' + editingIndex); // Mobile debug
            if (editingIndex === -1) {
                console.log(' No item being edited');
                alert(' No item being edited'); // Mobile debug
                return;
            }
            
            const oldItem = {...inventory[editingIndex]}; // Create a copy of the old item
            const item = inventory[editingIndex];
            
            console.log(' Original item:', oldItem);
            console.log(' Inventory before edit:', inventory.length, 'items');
            alert(' Inventory before edit: ' + inventory.length + ' items'); // Mobile debug
            
            // Get form values with mobile-safe parsing
            const nameEl = document.getElementById('editItemName');
            const purchaseDateEl = document.getElementById('editPurchaseDate');
            const purchasePriceEl = document.getElementById('editPurchasePrice');
            const affectBalanceEl = document.getElementById('editAffectBalance');
            const soldDateEl = document.getElementById('editSoldDate');
            const soldPriceEl = document.getElementById('editSoldPrice');
            const addToBalanceEl = document.getElementById('editAddToBalance');
            const statusEl = document.getElementById('editItemStatus');
            const descriptionEl = document.getElementById('editItemDescription');
            const workNotesEl = document.getElementById('editItemWorkNotes');
            
            console.log(' Form elements found:', {
                name: !!nameEl,
                purchaseDate: !!purchaseDateEl,
                purchasePrice: !!purchasePriceEl,
                affectBalance: !!affectBalanceEl,
                soldDate: !!soldDateEl,
                soldPrice: !!soldPriceEl,
                addToBalance: !!addToBalanceEl,
                status: !!statusEl,
                description: !!descriptionEl,
                workNotes: !!workNotesEl
            });
            
            const formData = {
                name: nameEl?.value || '',
                purchaseDate: purchaseDateEl?.value || '',
                purchasePrice: parseFloat(purchasePriceEl?.value || '0'),
                affectBalance: affectBalanceEl?.value === 'yes',
                soldDate: soldDateEl?.value || '',
                soldPrice: parseFloat(soldPriceEl?.value || '0') || 0,
                addToBalance: addToBalanceEl?.value === 'yes',
                status: statusEl?.value || 'ready',
                description: descriptionEl?.value || '',
                workNotes: workNotesEl?.value || ''
            };
            
            console.log(' Form data:', formData);
            
            // Update item with form data
            item.name = formData.name;
            item.purchaseDate = formData.purchaseDate;
            item.purchasePrice = formData.purchasePrice;
            item.affectBalance = formData.affectBalance;
            item.soldDate = formData.soldDate;
            item.soldPrice = formData.soldPrice;
            item.addToBalance = formData.addToBalance;
            item.status = formData.status;
            item.description = formData.description;
            item.workNotes = formData.workNotes;
            
            // Auto-set status to sold if sold date and price are provided
            if (item.soldDate && item.soldPrice > 0) {
                item.status = 'sold';
                console.log(' Auto-set status to sold');
            }
            
            console.log(' Updated item:', item);
            
            // Detect changes and add to history
            const changes = detectChanges(oldItem, item);
            if (changes.length > 0) {
                console.log(' Changes detected:', changes);
                const action = changes.some(c => c.field === 'Status') ? 'status' : 'edit';
                addHistoryEntry(action, item.name, item.itemNumber, changes, oldItem);
            } else {
                console.log(' No changes detected');
            }
            
            // Handle new main photos
            const mainPhotoInput = document.getElementById('editMainPhotos');
            console.log(' Main photos input:', mainPhotoInput.files?.length || 0, 'files');
            
            let mainPhotosLoaded = false;
            let workPhotosLoaded = false;
            
            // Function to check if all photos are loaded, then upload to ImgBB
            const checkAllPhotosLoaded = async () => {
                if (mainPhotosLoaded && workPhotosLoaded) {
                    console.log(' All photos loaded, uploading to ImgBB...');
                    
                    // Upload any new base64 photos to ImgBB
                    if (item.photos && item.photos.length > 0) {
                        console.log(' Uploading main photos to ImgBB...');
                        item.photos = await uploadMultipleToImgBB(item.photos);
                    }
                    if (item.workPhotos && item.workPhotos.length > 0) {
                        console.log(' Uploading work photos to ImgBB...');
                        item.workPhotos = await uploadMultipleToImgBB(item.workPhotos);
                    }
                    
                    console.log(' Saving inventory with', inventory.length, 'items');
                    await saveInventory();
                    renderInventory();
                    closeEditModal();
                    console.log(' Item updated with cloud-hosted images!');
                }
            };
            
            // Handle main photos
            if (mainPhotoInput.files && mainPhotoInput.files.length > 0) {
                console.log(' Processing main photos...');
                let loadedCount = 0;
                const totalFiles = mainPhotoInput.files.length;
                
                // Initialize photos array if it doesn't exist
                if (!item.photos) {
                    item.photos = [];
                }
                
                for (let i = 0; i < totalFiles; i++) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        item.photos.push(e.target.result);
                        loadedCount++;
                        
                        console.log(` Main photo ${loadedCount}/${totalFiles} loaded`);
                        
                        if (loadedCount === totalFiles) {
                            mainPhotosLoaded = true;
                            checkAllPhotosLoaded();
                        }
                    };
                    reader.readAsDataURL(mainPhotoInput.files[i]);
                }
            } else {
                mainPhotosLoaded = true;
                checkAllPhotosLoaded();
            }
            
            // Handle new work photos
            const workPhotoInput = document.getElementById('editWorkPhotos');
            console.log(' Work photos input:', workPhotoInput.files?.length || 0, 'files');
            
            if (workPhotoInput.files && workPhotoInput.files.length > 0) {
                console.log(' Processing work photos...');
                let loadedCount = 0;
                const totalFiles = workPhotoInput.files.length;
                
                // Initialize workPhotos array if it doesn't exist
                if (!item.workPhotos) {
                    item.workPhotos = [];
                }
                
                for (let i = 0; i < totalFiles; i++) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        item.workPhotos.push(e.target.result);
                        loadedCount++;
                        
                        console.log(` Photo ${loadedCount}/${totalFiles} loaded`);
                        
                        if (loadedCount === totalFiles) {
                            workPhotosLoaded = true;
                            checkAllPhotosLoaded();
                        }
                    };
                    reader.readAsDataURL(workPhotoInput.files[i]);
                }
            } else {
                workPhotosLoaded = true;
                checkAllPhotosLoaded();
            }
        }

        // Reorder Functions
        function moveItemUp(index) {
            console.log(' Moving item up:', index);
            console.log(' Current inventory length:', inventory.length);
            console.log(' Item at index:', inventory[index]);
            
            // Validate the item exists and is needs-work
            if (!inventory[index] || inventory[index].status !== 'needs-work') {
                console.log(' Invalid item for move up:', inventory[index]);
                return;
            }
            
            // Get all needs-work items and their indices
            const needsWorkIndices = [];
            inventory.forEach((item, idx) => {
                if (item && item.status === 'needs-work') {
                    needsWorkIndices.push(idx);
                }
            });
            
            console.log(' Needs-work indices:', needsWorkIndices);
            
            // Find current position in needs-work array
            const currentPosition = needsWorkIndices.indexOf(index);
            console.log(' Current position:', currentPosition);
            
            if (currentPosition > 0) {
                // Swap with item above
                const targetIndex = needsWorkIndices[currentPosition - 1];
                console.log(' Swapping with target index:', targetIndex);
                console.log(' Target item:', inventory[targetIndex]);
                
                // Perform the swap
                const temp = inventory[index];
                inventory[index] = inventory[targetIndex];
                inventory[targetIndex] = temp;
                
                console.log(' Swap completed. New items:');
                console.log(' Item at', index, ':', inventory[index]);
                console.log(' Item at', targetIndex, ':', inventory[targetIndex]);
                
                // Update UI immediately for better user experience
                renderInventory();
                
                // Save to database in background (non-blocking)
                setTimeout(() => {
                    saveInventory();
                }, 100);
                
                console.log(' Item moved up successfully');
            } else {
                console.log(' Item is already at the top');
            }
        }
        
        function moveItemDown(index) {
            console.log(' Moving item down:', index);
            console.log(' Current inventory length:', inventory.length);
            console.log(' Item at index:', inventory[index]);
            
            // Validate the item exists and is needs-work
            if (!inventory[index] || inventory[index].status !== 'needs-work') {
                console.log(' Invalid item for move down:', inventory[index]);
                return;
            }
            
            // Get all needs-work items and their indices
            const needsWorkIndices = [];
            inventory.forEach((item, idx) => {
                if (item && item.status === 'needs-work') {
                    needsWorkIndices.push(idx);
                }
            });
            
            console.log(' Needs-work indices:', needsWorkIndices);
            
            // Find current position in needs-work array
            const currentPosition = needsWorkIndices.indexOf(index);
            console.log(' Current position:', currentPosition);
            
            if (currentPosition < needsWorkIndices.length - 1) {
                // Swap with item below
                const targetIndex = needsWorkIndices[currentPosition + 1];
                console.log(' Swapping with target index:', targetIndex);
                console.log(' Target item:', inventory[targetIndex]);
                
                // Perform the swap
                const temp = inventory[index];
                inventory[index] = inventory[targetIndex];
                inventory[targetIndex] = temp;
                
                console.log(' Swap completed. New items:');
                console.log(' Item at', index, ':', inventory[index]);
                console.log(' Item at', targetIndex, ':', inventory[targetIndex]);
                
                // Update UI immediately for better user experience
                renderInventory();
                
                // Save to database in background (non-blocking)
                setTimeout(() => {
                    saveInventory();
                }, 100);
                
                console.log(' Item moved down successfully');
            } else {
                console.log(' Item is already at the bottom');
            }
        }

        // Open full view modal
        function openFullViewModal(index) {
            console.log('openFullViewModal called with index:', index);
            const item = inventory[index];
            currentFullViewItemNumber = item.itemNumber;
            
            console.log('Setting currentFullViewItemNumber to:', item.itemNumber);
            console.log('Item details:', { name: item.name, itemNumber: item.itemNumber, status: item.status });
            
            // Update modal header
            document.getElementById('fullViewItemName').textContent = item.name;
            
            // Calculate days in stock
            const purchaseDate = new Date(item.purchaseDate);
            const endDate = item.soldDate ? new Date(item.soldDate) : new Date();
            const daysInStock = Math.floor((endDate - purchaseDate) / (1000 * 60 * 60 * 24));
            
            // Handle photos
            const photos = item.photos && item.photos.length > 0 ? item.photos : 
                          (item.photo ? [item.photo] : []);
            
            const statusClass = item.status === 'sold' ? 'status-sold' : 
                               item.status === 'ready' ? 'status-ready' : 'status-needs-work';
            const statusText = item.status === 'sold' ? 'Sold' : 
                              item.status === 'ready' ? 'Ready to Sell' : 'Needs Work';
            
            const profit = item.soldPrice - item.purchasePrice;
            
            // Create full view content with responsive classes
            const content = `
                <div class="full-view-grid">
                    <!-- Left Column - Photos -->
                    <div>
                        <h3 class="full-view-section-title">Photos</h3>
                        ${photos.length > 0 ? `
                            <div class="full-view-photos-grid">
                                ${photos.map((photo, photoIdx) => `
                                    <div class="photo-thumbnail" onclick="openPhotoModal(${index}, ${photoIdx})">
                                        <img src="${photo}" alt="Photo ${photoIdx + 1}">
                                        ${photos.length > 1 ? `<span class="photo-number">${photoIdx + 1}</span>` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        ` : `
                            <div class="no-photo-placeholder">
                                <div class="icon"></div>
                                <div>No photos available</div>
                            </div>
                        `}
                        
                        ${item.workPhotos && item.workPhotos.length > 0 ? `
                            <h4 style="margin: 20px 0 10px 0; color: var(--text-primary);">Work Photos</h4>
                            <div class="full-view-work-photos-grid">
                                ${item.workPhotos.map((photo, photoIdx) => `
                                    <div class="photo-thumbnail work-photo-thumbnail" onclick="openWorkPhotoModal(${index}, ${photoIdx})">
                                        <img src="${photo}" alt="Work Photo ${photoIdx + 1}">
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                    
                    <!-- Right Column - Details -->
                    <div>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
                            <h3 style="margin: 0; color: var(--text-primary);">Item Information</h3>
                            <span class="status-badge ${statusClass}" style="
                                padding: 6px 12px;
                                border-radius: 15px;
                                font-size: 0.85em;
                                font-weight: 600;
                                text-transform: uppercase;
                            ">${statusText}</span>
                        </div>
                        
                        <div class="full-view-info-box">
                            <div class="full-view-info-grid">
                                <div class="full-view-info-item">
                                    <strong>Item Number</strong>
                                    <span style="color: var(--info);">${item.itemNumber || 'N/A'}</span>
                                </div>
                                <div class="full-view-info-item">
                                    <strong>Purchase Date</strong>
                                    <span>${new Date(item.purchaseDate).toLocaleDateString()}</span>
                                </div>
                                <div class="full-view-info-item">
                                    <strong>Purchase Price</strong>
                                    <span style="color: var(--accent-primary);">${(item.purchasePrice || 0).toFixed(2)}</span>
                                </div>
                                <div class="full-view-info-item">
                                    <strong>Days in Stock</strong>
                                    <span style="color: ${daysInStock > 90 ? 'var(--danger)' : daysInStock > 30 ? 'var(--warning)' : 'var(--success)'};">${daysInStock} days</span>
                                </div>
                            </div>
                        </div>
                        
                        ${item.soldDate ? `
                            <div class="full-view-sale-box">
                                <h4 style="margin-top: 0; margin-bottom: 15px; color: var(--success);">Sale Information</h4>
                                <div class="full-view-info-grid">
                                    <div class="full-view-info-item">
                                        <strong>Sold Date</strong>
                                        <span>${new Date(item.soldDate).toLocaleDateString()}</span>
                                    </div>
                                    <div class="full-view-info-item">
                                        <strong>Sold Price</strong>
                                        <span style="color: var(--success);">${(item.soldPrice || 0).toFixed(2)}</span>
                                    </div>
                                </div>
                                <div class="full-view-profit-box ${profit >= 0 ? 'positive' : 'negative'}">
                                    <div style="font-size: 0.85em; color: var(--text-muted); margin-bottom: 5px;">Total Profit</div>
                                    <div style="font-size: 1.6em; font-weight: 700; color: ${profit >= 0 ? 'var(--success)' : 'var(--danger)'};">${(profit || 0).toFixed(2)}</div>
                                </div>
                            </div>
                        ` : ''}
                        
                        ${item.description ? `
                            <div style="margin-bottom: 20px;">
                                <h4 style="margin-bottom: 10px; color: var(--text-primary);">Description</h4>
                                <div class="full-view-desc-box">${item.description}</div>
                            </div>
                        ` : ''}
                        
                        ${item.workNotes ? `
                            <div style="margin-bottom: 20px;">
                                <h4 style="margin-bottom: 10px; color: var(--text-primary);">Work Notes</h4>
                                <div class="full-view-work-notes">${item.workNotes}</div>
                            </div>
                        ` : ''}
                        
                        <div class="full-view-info-box" style="font-size: 0.9em;">
                            <div style="margin-bottom: 5px;"><strong style="color: var(--text-secondary);">Affects Balance:</strong> <span style="color: var(--text-primary);">${item.affectBalance !== false ? 'Yes' : 'No'}</span></div>
                            <div><strong style="color: var(--text-secondary);">Add to Balance:</strong> <span style="color: var(--text-primary);">${item.addToBalance !== false ? 'Yes' : 'No'}</span></div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('fullViewContent').innerHTML = content;
            document.getElementById('fullViewModal').classList.add('active');
        }

        // Close full view modal
        function closeEditModal() {
            document.getElementById('editModal').classList.remove('active');
            document.getElementById('editMainPhotos').value = '';
            document.getElementById('editWorkPhotos').value = '';
            editingIndex = -1;
        }

        function closeFullViewModal() {
            document.getElementById('fullViewModal').classList.remove('active');
            currentFullViewItemNumber = null; // Reset the itemNumber reference
        }

        // Edit item from full view
        function editFromFullView() {
            console.log('editFromFullView called, currentFullViewItemNumber:', currentFullViewItemNumber);
            if (currentFullViewItemNumber) {
                console.log('Finding index for itemNumber:', currentFullViewItemNumber);
                
                // Store the itemNumber before closing modal
                const itemNumberToFind = currentFullViewItemNumber;
                
                // Close modal but don't reset the itemNumber yet
                document.getElementById('fullViewModal').classList.remove('active');
                
                // Find the actual index in the inventory array using itemNumber
                const actualIndex = inventory.findIndex(item => item.itemNumber === itemNumberToFind);
                console.log('Actual inventory index:', actualIndex);
                
                if (actualIndex !== -1) {
                    editItem(actualIndex);
                } else {
                    console.error('Could not find item in inventory array');
                    console.log('Available items:', inventory.map(item => ({ name: item.name, itemNumber: item.itemNumber })));
                    console.log('Looking for itemNumber:', itemNumberToFind);
                    console.log('Full inventory:', inventory);
                    console.log('First item details:', inventory[0]);
                    console.log('First item itemNumber:', inventory[0]?.itemNumber);
                    console.log('First item item_number:', inventory[0]?.item_number);
                    
                    // Try alternative search methods
                    const altIndex1 = inventory.findIndex(item => item.itemNumber === itemNumberToFind);
                    const altIndex2 = inventory.findIndex(item => item.itemNumber == itemNumberToFind);
                    const altIndex3 = inventory.findIndex(item => String(item.itemNumber) === String(itemNumberToFind));
                    
                    console.log('Alternative searches:', { altIndex1, altIndex2, altIndex3 });
                    
                    if (altIndex1 !== -1) {
                        editItem(altIndex1);
                    } else if (altIndex2 !== -1) {
                        editItem(altIndex2);
                    } else if (altIndex3 !== -1) {
                        editItem(altIndex3);
                    } else {
                        alert('Error: Could not find item to edit');
                    }
                }
                
                // Reset after we're done
                currentFullViewItemNumber = null;
            } else {
                console.log('No item selected for editing');
            }
        }

        // Delete item from full view
        function deleteFromFullView() {
            console.log('deleteFromFullView called, currentFullViewItemNumber:', currentFullViewItemNumber);
            if (currentFullViewItemNumber) {
                // Store the itemNumber before closing modal
                const itemNumberToFind = currentFullViewItemNumber;
                
                // Close modal but don't reset the itemNumber yet
                document.getElementById('fullViewModal').classList.remove('active');
                
                // Find the actual index in the inventory array using itemNumber
                const actualIndex = inventory.findIndex(item => item.itemNumber === itemNumberToFind);
                console.log('Actual inventory index for deletion:', actualIndex);
                
                if (actualIndex !== -1) {
                    // Use the existing deleteItem function
                    deleteItem(actualIndex);
                } else {
                    console.error('Could not find item in inventory array for deletion');
                    console.log('Looking for itemNumber:', itemNumberToFind);
                    console.log('Available items:', inventory.map(item => ({ name: item.name, itemNumber: item.itemNumber })));
                    
                    // Try alternative search methods
                    const altIndex1 = inventory.findIndex(item => item.itemNumber === itemNumberToFind);
                    const altIndex2 = inventory.findIndex(item => item.itemNumber == itemNumberToFind);
                    const altIndex3 = inventory.findIndex(item => String(item.itemNumber) === String(itemNumberToFind));
                    
                    console.log('Alternative searches for deletion:', { altIndex1, altIndex2, altIndex3 });
                    
                    if (altIndex1 !== -1) {
                        deleteItem(altIndex1);
                    } else if (altIndex2 !== -1) {
                        deleteItem(altIndex2);
                    } else if (altIndex3 !== -1) {
                        deleteItem(altIndex3);
                    } else {
                        alert('Error: Could not find item to delete');
                    }
                }
                
                // Reset after we're done
                currentFullViewItemNumber = null;
            } else {
                console.log('No item selected for deletion');
            }
        }

        // Delete item
        function deleteItem(index) {
            if (confirm('Are you sure you want to delete this item?')) {
                const deletedItem = inventory[index];
                
                // Add to history before deleting
                addHistoryEntry('delete', deletedItem.name, deletedItem.itemNumber, null, deletedItem);
                
                inventory.splice(index, 1);
                console.log('Calling saveInventory after deletion...');
                saveInventory(); // Keep as non-async for now
                renderInventory();
                updateStatistics();
            }
        }

        // Update statistics
        function updateStatistics() {
            let moneyIn = 0;
            let moneyOut = 0;
            let totalItems = inventory.length;
            let readyItems = 0;
            let needsWorkItems = 0;
            let soldItems = 0;

            inventory.forEach(item => {
                if (item.affectBalance !== false) { // Default to true for existing items
                    moneyOut += (item.purchasePrice || 0);
                }
                // Sold items are NOT automatically added to balance - they must be manually added through transactions
                
                if (item.status === 'sold') soldItems++;
                else if (item.status === 'ready') readyItems++;
                else if (item.status === 'needs-work') needsWorkItems++;
            });

            // Calculate profit only from sold items
            let soldItemsCost = 0;
            let soldItemsRevenue = 0;
            inventory.forEach(item => {
                if (item.status === 'sold' && (item.soldPrice || 0) > 0) {
                    // Always include revenue and cost for sold items in profit calculation
                    soldItemsRevenue += (item.soldPrice || 0);
                    soldItemsCost += (item.purchasePrice || 0);
                }
            });
            const totalProfit = soldItemsRevenue - soldItemsCost;
            
            // Calculate balance including additional transactions
            let additionalIncome = 0;
            let additionalExpenses = 0;
            transactions.forEach(t => {
                if (t.type === 'income') {
                    additionalIncome += (t.amount || 0);
                } else {
                    additionalExpenses += (t.amount || 0);
                }
            });
            
            const totalBalance = moneyIn - moneyOut + additionalIncome - additionalExpenses;

            document.getElementById('totalBalance').textContent = '' + totalBalance.toFixed(2);
            document.getElementById('moneyIn').textContent = '' + moneyIn.toFixed(2);
            document.getElementById('moneyOut').textContent = '' + moneyOut.toFixed(2);
            document.getElementById('totalProfit').textContent = '' + totalProfit.toFixed(2);
            
            // Update balance breakdown
            document.getElementById('balanceMoneyIn').textContent = '' + moneyIn.toFixed(2);
            document.getElementById('balanceMoneyOut').textContent = '-' + moneyOut.toFixed(2);
            document.getElementById('balanceAdditionalIncome').textContent = '' + additionalIncome.toFixed(2);
            document.getElementById('balanceAdditionalExpenses').textContent = '-' + additionalExpenses.toFixed(2);
            document.getElementById('balanceTotal').textContent = '' + totalBalance.toFixed(2);
            
            document.getElementById('totalItems').textContent = totalItems;
            document.getElementById('readyItems').textContent = readyItems;
            document.getElementById('needsWorkItems').textContent = needsWorkItems;
            document.getElementById('soldItems').textContent = soldItems;

            // Update tab counts
            document.getElementById('inventoryCount').textContent = readyItems;
            document.getElementById('needsworkCount').textContent = needsWorkItems;
            document.getElementById('soldCount').textContent = soldItems;

            // Calculate average days in stock and days to sell
            let totalDaysInStock = 0;
            let totalDaysToSell = 0;
            let unsoldItems = 0;
            
            inventory.forEach(item => {
                const purchaseDate = new Date(item.purchaseDate);
                const endDate = item.soldDate ? new Date(item.soldDate) : new Date();
                const daysInStock = Math.floor((endDate - purchaseDate) / (1000 * 60 * 60 * 24));
                
                totalDaysInStock += daysInStock;
                
                if (item.soldDate) {
                    totalDaysToSell += daysInStock;
                } else {
                    unsoldItems++;
                }
            });
            
            const avgDaysInStock = totalItems > 0 ? Math.round(totalDaysInStock / totalItems) : 0;
            const avgDaysToSell = soldItems > 0 ? Math.round(totalDaysToSell / soldItems) : 0;
            
            document.getElementById('avgDaysInStock').textContent = avgDaysInStock;
            document.getElementById('avgDaysToSell').textContent = soldItems > 0 ? avgDaysToSell : '-';

            // Calculate this month's sales
            updateMonthlyStats();
            
            // Draw sales chart
            drawSalesChart();
            
            // Generate monthly breakdown
            generateMonthlyBreakdown();

            // Update details table
            const tableBody = document.getElementById('detailsTableBody');
            if (inventory.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 40px; color: #999;">No transactions yet</td></tr>';
            } else {
                tableBody.innerHTML = inventory.map(item => {
                    const profit = item.soldPrice - item.purchasePrice;
                    const statusClass = item.status === 'sold' ? 'status-sold' : 
                                       item.status === 'ready' ? 'status-ready' : 'status-needs-work';
                    const statusText = item.status === 'sold' ? 'Sold' : 
                                      item.status === 'ready' ? 'Ready to Sell' : 'Needs Work';
                    
                    // Calculate days in stock
                    const purchaseDate = new Date(item.purchaseDate);
                    const endDate = item.soldDate ? new Date(item.soldDate) : new Date();
                    const daysInStock = Math.floor((endDate - purchaseDate) / (1000 * 60 * 60 * 24));
                    
                    return `
                        <tr>
                            <td style="color: #667eea; font-weight: 600;">${item.itemNumber || 'N/A'}</td>
                            <td><strong>${item.name}</strong></td>
                            <td>${new Date(item.purchaseDate).toLocaleDateString()}</td>
                            <td style="font-weight: 600; color: ${daysInStock > 90 ? '#dc3545' : daysInStock > 30 ? '#ffc107' : '#28a745'};">
                                ${daysInStock} days
                            </td>
                            <td>${(item.purchasePrice || 0).toFixed(2)}</td>
                            <td>${item.soldDate ? new Date(item.soldDate).toLocaleDateString() : '-'}</td>
                            <td>${(item.soldPrice || 0) > 0 ? '' + (item.soldPrice || 0).toFixed(2) : '-'}</td>
                            <td style="color: ${profit >= 0 && (item.soldPrice || 0) > 0 ? '#28a745' : profit < 0 ? '#dc3545' : '#666'}; font-weight: 700;">
                                ${(item.soldPrice || 0) > 0 ? '' + (profit || 0).toFixed(2) : '-'}
                            </td>
                            <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        </tr>
                    `;
                }).join('');
            }
        }

        // Update monthly statistics
        function updateMonthlyStats() {
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();

            let monthSold = 0;
            let monthRevenue = 0;
            let monthCost = 0;

            inventory.forEach(item => {
                if (item.soldDate) {
                    const soldDate = new Date(item.soldDate);
                    if (soldDate.getMonth() === currentMonth && soldDate.getFullYear() === currentYear) {
                        monthSold++;
                        monthRevenue += item.soldPrice;
                        monthCost += item.purchasePrice;
                    }
                }
            });

            const monthProfit = monthRevenue - monthCost;

            document.getElementById('monthSoldItems').textContent = monthSold;
            document.getElementById('monthRevenue').textContent = '' + monthRevenue.toFixed(2);
            document.getElementById('monthProfit').textContent = '' + monthProfit.toFixed(2);
        }

        // Get monthly data for chart
        function getMonthlyData() {
            const monthlyData = {};
            
            inventory.forEach(item => {
                if (item.soldDate) {
                    const soldDate = new Date(item.soldDate);
                    const monthKey = soldDate.getFullYear() + '-' + String(soldDate.getMonth() + 1).padStart(2, '0');
                    
                    if (!monthlyData[monthKey]) {
                        monthlyData[monthKey] = {
                            revenue: 0,
                            cost: 0,
                            profit: 0,
                            itemsSold: 0,
                            items: []
                        };
                    }
                    
                    monthlyData[monthKey].revenue += (item.soldPrice || 0);
                    monthlyData[monthKey].cost += (item.purchasePrice || 0);
                    monthlyData[monthKey].profit += ((item.soldPrice || 0) - (item.purchasePrice || 0));
                    monthlyData[monthKey].itemsSold++;
                    monthlyData[monthKey].items.push(item);
                }
            });
            
            return monthlyData;
        }

        // Draw sales chart
        function drawSalesChart() {
            const canvas = document.getElementById('salesChart');
            const ctx = canvas.getContext('2d');
            
            // Set canvas size
            canvas.width = canvas.offsetWidth;
            canvas.height = 400;
            
            const monthlyData = getMonthlyData();
            const months = Object.keys(monthlyData).sort();
            
            if (months.length === 0) {
                ctx.fillStyle = '#999';
                ctx.font = '16px Segoe UI';
                ctx.textAlign = 'center';
                ctx.fillText('No sales data yet', canvas.width / 2, canvas.height / 2);
                return;
            }
            
            // Chart dimensions
            const padding = 60;
            const chartWidth = canvas.width - padding * 2;
            const chartHeight = canvas.height - padding * 2;
            
            // Find max value for scaling
            const maxRevenue = Math.max(...months.map(m => monthlyData[m].revenue));
            const maxValue = Math.max(maxRevenue, 100); // Minimum scale of 100
            
            // Draw axes
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(padding, padding);
            ctx.lineTo(padding, canvas.height - padding);
            ctx.lineTo(canvas.width - padding, canvas.height - padding);
            ctx.stroke();
            
            // Calculate bar width
            const barWidth = chartWidth / months.length * 0.6;
            const spacing = chartWidth / months.length;
            
            // Draw bars
            months.forEach((month, index) => {
                const data = monthlyData[month];
                const barHeight = (data.revenue / maxValue) * chartHeight;
                const x = padding + index * spacing + (spacing - barWidth) / 2;
                const y = canvas.height - padding - barHeight;
                
                // Revenue bar (blue)
                const gradient = ctx.createLinearGradient(x, y, x, canvas.height - padding);
                gradient.addColorStop(0, '#667eea');
                gradient.addColorStop(1, '#764ba2');
                ctx.fillStyle = gradient;
                ctx.fillRect(x, y, barWidth, barHeight);
                
                // Month label
                const [year, monthNum] = month.split('-');
                const date = new Date(year, parseInt(monthNum) - 1);
                const monthName = date.toLocaleDateString('en-US', { month: 'short', year: '2-digit' });
                
                ctx.fillStyle = '#333';
                ctx.font = 'bold 12px Segoe UI';
                ctx.textAlign = 'center';
                ctx.fillText(monthName, x + barWidth / 2, canvas.height - padding + 20);
                
                // Revenue value
                ctx.fillStyle = '#667eea';
                ctx.font = 'bold 14px Segoe UI';
                ctx.fillText('' + data.revenue.toFixed(0), x + barWidth / 2, y - 10);
            });
            
            // Y-axis labels
            ctx.fillStyle = '#666';
            ctx.font = '12px Segoe UI';
            ctx.textAlign = 'right';
            for (let i = 0; i <= 5; i++) {
                const value = (maxValue / 5) * i;
                const y = canvas.height - padding - (chartHeight / 5) * i;
                ctx.fillText('' + value.toFixed(0), padding - 10, y + 5);
                
                // Grid line
                ctx.strokeStyle = '#e0e0e0';
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(padding, y);
                ctx.lineTo(canvas.width - padding, y);
                ctx.stroke();
            }
            
            // Chart title
            ctx.fillStyle = '#333';
            ctx.font = 'bold 16px Segoe UI';
            ctx.textAlign = 'center';
            ctx.fillText('Monthly Revenue', canvas.width / 2, 30);
        }

        // Generate monthly breakdown
        function generateMonthlyBreakdown() {
            const monthlyData = getMonthlyData();
            const months = Object.keys(monthlyData).sort().reverse(); // Most recent first
            
            const breakdownDiv = document.getElementById('monthlyBreakdown');
            
            if (months.length === 0) {
                breakdownDiv.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;">No sales recorded yet</div>';
                return;
            }
            
            breakdownDiv.innerHTML = months.map(month => {
                const data = monthlyData[month];
                const [year, monthNum] = month.split('-');
                const date = new Date(year, parseInt(monthNum) - 1);
                const monthName = date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                
                return `
                    <div class="month-card" onclick="toggleMonth('${month}')">
                        <div class="month-header">
                            <div class="month-title">
                                <span class="expand-icon" id="icon-${month}"></span>
                                ${monthName}
                            </div>
                            <div class="month-stats">
                                <div><strong>${data.itemsSold}</strong> sold</div>
                                <div><strong style="color: #28a745;">${(data.revenue || 0).toFixed(2)}</strong> revenue</div>
                                <div><strong style="color: ${(data.profit || 0) >= 0 ? '#667eea' : '#dc3545'};">${(data.profit || 0).toFixed(2)}</strong> profit</div>
                            </div>
                        </div>
                        <div class="month-details" id="details-${month}">
                            <h4 style="margin-bottom: 15px;">Items Sold This Month:</h4>
                            <div class="month-items-list">
                                ${data.items.map(item => {
                                    const profit = (item.soldPrice || 0) - (item.purchasePrice || 0);
                                    return `
                                        <div class="month-item">
                                            <div>
                                                <strong>${item.name}</strong>
                                                <div style="color: #667eea; font-size: 0.9em;">${item.itemNumber}</div>
                                            </div>
                                            <div style="text-align: right;">
                                                <div>Sold: <strong>${(item.soldPrice || 0).toFixed(2)}</strong></div>
                                                <div style="color: ${profit >= 0 ? '#28a745' : '#dc3545'}; font-weight: 600;">
                                                    Profit: ${(profit || 0).toFixed(2)}
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Toggle month details
        function toggleMonth(monthKey) {
            const details = document.getElementById('details-' + monthKey);
            const icon = document.getElementById('icon-' + monthKey);
            
            if (details.classList.contains('active')) {
                details.classList.remove('active');
                icon.classList.remove('rotated');
            } else {
                details.classList.add('active');
                icon.classList.add('rotated');
            }
        }

        // Open balance modal
        function openBalanceModal() {
            // Set today's date as default
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('transactionDate').value = today;
            
            renderTransactions();
            renderSoldItems();
            document.getElementById('balanceModal').classList.add('active');
        }

        // Close balance modal
        function closeBalanceModal() {
            document.getElementById('balanceModal').classList.remove('active');
            clearTransactionForm();
        }

        // Clear transaction form
        function clearTransactionForm() {
            document.getElementById('transactionDesc').value = '';
            document.getElementById('transactionAmount').value = '';
            document.getElementById('transactionType').value = 'expense';
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('transactionDate').value = today;
        }

        // Add transaction
        function addTransaction() {
            const desc = document.getElementById('transactionDesc').value;
            const amount = parseFloat(document.getElementById('transactionAmount').value);
            const type = document.getElementById('transactionType').value;
            const date = document.getElementById('transactionDate').value;

            if (!desc || isNaN(amount) || amount <= 0 || !date) {
                alert('Please fill in all fields with valid values');
                return;
            }

            const transaction = {
                id: Date.now(),
                description: desc,
                amount: amount,
                type: type,
                date: date
            };

            transactions.push(transaction);
            saveTransactions(); // Keep as non-async for now
            
            // Add to history
            addHistoryEntry('balance_transaction', desc, '', [
                { field: 'Type', oldValue: '', newValue: type === 'income' ? 'Income' : 'Expense' },
                { field: 'Amount', oldValue: '', newValue: `${(amount || 0).toFixed(2)}` },
                { field: 'Date', oldValue: '', newValue: date }
            ]);
            
            renderTransactions();
            updateStatistics();
            clearTransactionForm();
        }

        // Add sold item to balance as income transaction
        function addSoldItemToBalance(itemName, amount, soldDate) {
            const transaction = {
                id: Date.now(),
                description: `Sale: ${itemName}`,
                amount: amount,
                type: 'income',
                date: soldDate
            };

            transactions.push(transaction);
            saveTransactions(); // Keep as non-async for now
            
            // Add to history
            addHistoryEntry('balance_transaction', `Sale: ${itemName}`, '', [
                { field: 'Type', oldValue: '', newValue: 'Income' },
                { field: 'Amount', oldValue: '', newValue: `${(amount || 0).toFixed(2)}` },
                { field: 'Date', oldValue: '', newValue: soldDate },
                { field: 'Item', oldValue: '', newValue: itemName }
            ]);
            
            renderTransactions();
            renderSoldItems(); // Refresh the sold items list
            updateStatistics();
        }

        // Delete transaction
        function deleteTransaction(id) {
            if (confirm('Delete this transaction?')) {
                const transactionToDelete = transactions.find(t => t.id === id);
                transactions = transactions.filter(t => t.id !== id);
                saveTransactions(); // Keep as non-async for now
                
                // Add to history
                if (transactionToDelete) {
                    addHistoryEntry('balance_transaction_delete', transactionToDelete.description, '', [
                        { field: 'Type', oldValue: transactionToDelete.type === 'income' ? 'Income' : 'Expense', newValue: 'Deleted' },
                        { field: 'Amount', oldValue: `${(transactionToDelete.amount || 0).toFixed(2)}`, newValue: 'Deleted' },
                        { field: 'Date', oldValue: transactionToDelete.date, newValue: 'Deleted' }
                    ]);
                }
                
                renderTransactions();
                updateStatistics();
            }
        }

        // Render transactions
        function renderTransactions() {
            const transactionList = document.getElementById('transactionList');
            
            if (transactions.length === 0) {
                transactionList.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;">No additional transactions yet</div>';
                return;
            }

            // Sort by date (most recent first)
            const sortedTransactions = [...transactions].sort((a, b) => new Date(b.date) - new Date(a.date));

            transactionList.innerHTML = sortedTransactions.map(t => {
                const isIncome = t.type === 'income';
                return `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; background: white; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid ${isIncome ? '#28a745' : '#dc3545'};">
                        <div>
                            <div style="font-weight: 600; color: #333;">${t.description}</div>
                            <div style="font-size: 0.9em; color: #666;">${new Date(t.date).toLocaleDateString()}</div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <div style="font-size: 1.2em; font-weight: 700; color: ${isIncome ? '#28a745' : '#dc3545'};">
                                ${isIncome ? '+' : '-'}${(t.amount || 0).toFixed(2)}
                            </div>
                            <button onclick="deleteTransaction(${t.id})" style="padding: 6px 12px; background: #dc3545; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9em;">
                                Delete
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Render sold items that can be added to balance
        function renderSoldItems() {
            const soldItemsList = document.getElementById('soldItemsList');
            
            // Get sold items that haven't been added to balance yet
            const soldItems = inventory.filter(item => 
                item.status === 'sold' && 
                item.soldPrice > 0 && 
                !transactions.some(t => 
                    t.description.includes(item.name) && 
                    t.type === 'income' && 
                    t.amount === item.soldPrice
                )
            );
            
            if (soldItems.length === 0) {
                soldItemsList.innerHTML = '<div style="text-align: center; padding: 20px; color: #999;">No sold items to add to balance</div>';
                return;
            }

            soldItemsList.innerHTML = soldItems.map(item => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: white; border-radius: 6px; margin-bottom: 8px; border: 1px solid #ddd;">
                    <div>
                        <div style="font-weight: 600; color: #333;">${item.name}</div>
                        <div style="font-size: 0.9em; color: #666;">Sold: ${item.soldDate ? new Date(item.soldDate).toLocaleDateString() : 'Unknown'}</div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div style="font-size: 1.1em; font-weight: 700; color: #28a745;">
                            ${(item.soldPrice || 0).toFixed(2)}
                        </div>
                        <button onclick="addSoldItemToBalance('${item.name}', ${item.soldPrice}, '${item.soldDate || new Date().toISOString().split('T')[0]}')" 
                                style="padding: 6px 12px; background: #28a745; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9em;">
                            Add to Balance
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Photo modal functions
        function openPhotoModal(itemIndex, photoIndex) {
            const item = inventory[itemIndex];
            currentItemPhotos = item.photos && item.photos.length > 0 ? item.photos : 
                               (item.photo ? [item.photo] : []);
            
            if (currentItemPhotos.length === 0) return;
            
            currentPhotoIndex = photoIndex;
            displayPhoto();
            document.getElementById('photoModal').classList.add('active');
        }

        function openWorkPhotoModal(itemIndex, photoIndex) {
            const item = inventory[itemIndex];
            currentItemPhotos = item.workPhotos || [];
            
            if (currentItemPhotos.length === 0) return;
            
            currentPhotoIndex = photoIndex;
            displayPhoto();
            document.getElementById('photoModal').classList.add('active');
        }

        function closePhotoModal() {
            document.getElementById('photoModal').classList.remove('active');
            currentItemPhotos = [];
            currentPhotoIndex = 0;
        }

        function displayPhoto() {
            document.getElementById('photoModalImage').src = currentItemPhotos[currentPhotoIndex];
            document.getElementById('photoCounter').textContent = 
                `${currentPhotoIndex + 1} / ${currentItemPhotos.length}`;
            
            // Hide/show nav buttons
            const prevBtn = document.querySelector('.photo-nav.prev');
            const nextBtn = document.querySelector('.photo-nav.next');
            
            if (currentItemPhotos.length <= 1) {
                prevBtn.style.display = 'none';
                nextBtn.style.display = 'none';
            } else {
                prevBtn.style.display = 'block';
                nextBtn.style.display = 'block';
            }
        }

        function nextPhoto() {
            currentPhotoIndex = (currentPhotoIndex + 1) % currentItemPhotos.length;
            displayPhoto();
        }

        function prevPhoto() {
            currentPhotoIndex = (currentPhotoIndex - 1 + currentItemPhotos.length) % currentItemPhotos.length;
            displayPhoto();
        }

        // Close modal when clicking outside
        document.getElementById('editModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeEditModal();
            }
        });

        document.getElementById('fullViewModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeFullViewModal();
            }
        });

        document.getElementById('balanceModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeBalanceModal();
            }
        });

        document.getElementById('photoModal').addEventListener('click', function(e) {
            if (e.target === this || e.target.classList.contains('photo-close')) {
                closePhotoModal();
            }
        });

        // Keyboard navigation for photo modal and hidden history access
        document.addEventListener('keydown', function(e) {
            if (document.getElementById('photoModal').classList.contains('active')) {
                if (e.key === 'ArrowRight') nextPhoto();
                if (e.key === 'ArrowLeft') prevPhoto();
                if (e.key === 'Escape') closePhotoModal();
            }
            
            
            // Close history modal with Escape
            if (e.key === 'Escape') {
                const historyModal = document.getElementById('historyModal');
                if (historyModal && historyModal.style.display !== 'none') {
                    closeHiddenHistory();
                }
            }
        });

        // Note: loadInventory() is now called from showMainApp() after authentication

        // Delivery Form Functions
        function switchToDeliveryForm() {
            // Switch to the delivery form tab
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // Find and activate the delivery form tab button
            const tabs = document.querySelectorAll('.tab');
            for (let i = 0; i < tabs.length; i++) {
                if (tabs[i].textContent.includes('Delivery Form')) {
                    tabs[i].classList.add('active');
                    break;
                }
            }
            
            // Activate the delivery form tab content
            document.getElementById('deliveryform').classList.add('active');
        }

        function resetDeliveryForm() {
            document.getElementById('deliveryForm').reset();
            document.getElementById('deliveryDateDisplay').textContent = '';
            document.getElementById('completedFormView').style.display = 'none';
            document.getElementById('deliveryForm').style.display = 'block';
        }

        // Update delivery date display with day of week
        function updateDeliveryDateDisplay() {
            const dateInput = document.getElementById('deliveryDate');
            const displayDiv = document.getElementById('deliveryDateDisplay');
            
            if (dateInput.value) {
                const date = new Date(dateInput.value + 'T00:00:00');
                const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                const dayOfWeek = days[date.getDay()];
                const formattedDate = date.toLocaleDateString('en-GB', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
                displayDiv.textContent = formattedDate;
            } else {
                displayDiv.textContent = '';
            }
        }

        // Show completed form view
        function showCompletedForm(event) {
            event.preventDefault();
            
            // Get form values
            const jobNumber = document.getElementById('deliveryJobCode').value;
            const deliveryDateInput = document.getElementById('deliveryDate').value;
            const itemName = document.getElementById('deliveryItemName').value;
            const creatorName = currentUser ? currentUser.charAt(0).toUpperCase() + currentUser.slice(1) : 'Unknown';
            const soldOnCheckboxes = document.querySelectorAll('input[name="soldOn"]:checked');
            const soldOn = Array.from(soldOnCheckboxes).map(cb => cb.value).join(', ') || 'Not specified';
            const driverCollectCode = document.getElementById('driverCollectCode').checked ? 'Yes' : 'No';
            const driverPaymentItem = document.querySelector('input[name="driverPaymentItem"]:checked').value;
            const driverPaymentDelivery = document.querySelector('input[name="driverPaymentDelivery"]:checked').value;
            const specialComments = document.getElementById('deliverySpecialComments').value || 'None';
            const address = document.getElementById('deliveryAddress').value;
            
            // Validate required fields
            if (!jobNumber || !deliveryDateInput || !itemName || !address) {
                alert('Please fill in all required fields');
                return;
            }
            
            // Check if at least one "Sold On" checkbox is selected
            if (soldOnCheckboxes.length === 0) {
                alert('Please select at least one option for "Sold On"');
                return;
            }
            
            // Format delivery date with day of week
            const deliveryDate = new Date(deliveryDateInput + 'T00:00:00');
            const formattedDeliveryDate = deliveryDate.toLocaleDateString('en-GB', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            // Populate completed form view - optimized for mobile screenshots
            const completedContent = document.getElementById('completedFormContent');
            completedContent.innerHTML = `
                <div style="max-width: 100%; padding: 20px; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">
                    <h1 style="text-align: center; margin: 0 0 15px 0; font-size: 22px; color: #333; font-weight: bold;">DELIVERY FORM</h1>
                    <hr style="border: none; border-top: 2px solid #333; margin: 0 0 15px 0;">
                    <div style="font-size: 14px; line-height: 1.6;">
                        <div style="margin-bottom: 10px;"><strong>Job:</strong> ${jobNumber}</div>
                        <div style="margin-bottom: 10px;"><strong>Date:</strong> ${formattedDeliveryDate}</div>
                        <div style="margin-bottom: 10px;"><strong>Item Name:</strong> ${itemName}</div>
                        <div style="margin-bottom: 10px;"><strong>Created By:</strong> ${creatorName}</div>
                        <div style="margin-bottom: 10px;"><strong>Sold On:</strong> ${soldOn}</div>
                        <div style="margin-bottom: 10px;"><strong>Courier should get Collect Code:</strong> ${driverCollectCode}</div>
                        <div style="margin-bottom: 10px;"><strong>Courier should take Payment for Item:</strong> ${driverPaymentItem}</div>
                        <div style="margin-bottom: 10px;"><strong>Courier should take Payment for Delivery:</strong> ${driverPaymentDelivery}</div>
                        ${specialComments !== 'None' ? `<div style="margin-bottom: 10px;"><strong>Comments:</strong> ${specialComments.replace(/\n/g, ' ')}</div>` : ''}
                        <div style="margin-bottom: 10px;"><strong>Address:</strong> ${address.replace(/\n/g, ', ')}</div>
                    </div>
                </div>
            `;
            
            // Hide form and show completed view
            document.getElementById('deliveryForm').style.display = 'none';
            document.getElementById('completedFormView').style.display = 'block';
            
            // Scroll to top of completed view
            document.getElementById('completedFormView').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // Edit delivery form (go back to form)
        function editDeliveryForm() {
            document.getElementById('completedFormView').style.display = 'none';
            document.getElementById('deliveryForm').style.display = 'block';
            document.getElementById('deliveryForm').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // Download completed form as PDF (screenshot)
        async function downloadCompletedFormPDF() {
            const completedContent = document.getElementById('completedFormContent');
            
            try {
                const canvas = await html2canvas(completedContent, {
                    backgroundColor: '#ffffff',
                    scale: 2,
                    logging: false,
                    useCORS: true
                });
                
                canvas.toBlob(async function(blob) {
                    const jobNumber = document.getElementById('deliveryJobCode').value;
                    const today = new Date().toLocaleDateString('en-GB');
                    const filename = `photo_Delivery_Form_${jobNumber.replace(/[^a-zA-Z0-9]/g, '_')}_${today.replace(/\//g, '_')}.jpg`;
                    
                    // Try to use File System Access API to let user choose save location
                    if ('showSaveFilePicker' in window) {
                        try {
                            const fileHandle = await window.showSaveFilePicker({
                                suggestedName: filename,
                                types: [{
                                    description: 'JPEG Image',
                                    accept: {
                                        'image/jpeg': ['.jpg']
                                    }
                                }]
                            });
                            
                            const writable = await fileHandle.createWritable();
                            await writable.write(blob);
                            await writable.close();
                            
                            alert('Delivery form saved successfully to Photos!');
                        } catch (err) {
                            if (err.name !== 'AbortError') {
                                console.error('Error saving file:', err);
                                downloadFile(blob, filename);
                            }
                        }
                    } else {
                        downloadFile(blob, filename);
                    }
                }, 'image/jpeg', 0.95);
            } catch (error) {
                console.error('Error generating image:', error);
                alert('Error generating delivery form image. Please try again.');
            }
        }

        // Helper function for fallback download
        function downloadFile(blob, filename) {
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            alert('Delivery form JPEG downloaded successfully!');
        }

        function generateDeliveryPDF(event) {
            event.preventDefault();
            
            // Get form values
            const jobNumber = document.getElementById('deliveryJobCode').value;
            const soldOnCheckboxes = document.querySelectorAll('input[name="soldOn"]:checked');
            const soldOn = Array.from(soldOnCheckboxes).map(cb => cb.value).join(', ') || 'Not specified';
            const driverCollectCode = document.getElementById('driverCollectCode').checked ? 'Yes' : 'No';
            const driverPaymentItem = document.querySelector('input[name="driverPaymentItem"]:checked').value;
            const driverPaymentDelivery = document.querySelector('input[name="driverPaymentDelivery"]:checked').value;
            const specialComments = document.getElementById('deliverySpecialComments').value || 'None';
            const streetName = document.getElementById('deliveryStreetName').value;
            const county = document.getElementById('deliveryCounty').value;
            const postcode = document.getElementById('deliveryPostcode').value;
            
            // Validate required fields
            if (!jobNumber || !streetName || !county || !postcode) {
                alert('Please fill in all required fields (Job Number, Street Name, County, and Postcode)');
                return;
            }
            
            // Check if at least one "Sold On" checkbox is selected
            if (soldOnCheckboxes.length === 0) {
                alert('Please select at least one option for "Sold On"');
                return;
            }
            
            // Create formatted HTML content for the form
            const today = new Date().toLocaleDateString('en-GB');
            const previewDiv = document.getElementById('deliveryFormPreview');
            
            previewDiv.innerHTML = `
                <h1>DELIVERY FORM</h1>
                <hr>
                <div class="preview-field">
                    <span class="preview-label">Job Number:</span>
                    <span class="preview-value">${jobNumber}</span>
                </div>
                <div class="preview-field">
                    <span class="preview-label">Sold On:</span>
                    <span class="preview-value">${soldOn}</span>
                </div>
                <div class="preview-field">
                    <span class="preview-label">Driver to get collect code:</span>
                    <span class="preview-value">${driverCollectCode}</span>
                </div>
                <div class="preview-field">
                    <span class="preview-label">Driver should take payment for item:</span>
                    <span class="preview-value">${driverPaymentItem}</span>
                </div>
                <div class="preview-field">
                    <span class="preview-label">Driver should take payment for delivery:</span>
                    <span class="preview-value">${driverPaymentDelivery}</span>
                </div>
                <div class="preview-field">
                    <span class="preview-label">Special Comments:</span>
                    <span class="preview-value">${specialComments.replace(/\n/g, '<br>')}</span>
                </div>
                <div class="preview-field">
                    <span class="preview-label">Street Name:</span>
                    <span class="preview-value">${streetName}</span>
                </div>
                <div class="preview-field">
                    <span class="preview-label">County:</span>
                    <span class="preview-value">${county}</span>
                </div>
                <div class="preview-field">
                    <span class="preview-label">Postcode:</span>
                    <span class="preview-value">${postcode}</span>
                </div>
                <div class="preview-footer">
                    Generated on: ${today}
                </div>
            `;
            
            // Wait a moment for the DOM to update, then capture the image
            setTimeout(() => {
                html2canvas(previewDiv, {
                    backgroundColor: '#ffffff',
                    scale: 2, // Higher quality
                    logging: false,
                    useCORS: true
                }).then(canvas => {
                    // Convert canvas to JPEG and download
                    canvas.toBlob(async function(blob) {
                        const filename = `photo_Delivery_Form_${jobNumber.replace(/[^a-zA-Z0-9]/g, '_')}_${today.replace(/\//g, '_')}.jpg`;
                        
                        // Try to use File System Access API to let user choose save location
                        if ('showSaveFilePicker' in window) {
                            try {
                                const fileHandle = await window.showSaveFilePicker({
                                    suggestedName: filename,
                                    types: [{
                                        description: 'JPEG Image',
                                        accept: {
                                            'image/jpeg': ['.jpg']
                                        }
                                    }]
                                });
                                
                                const writable = await fileHandle.createWritable();
                                await writable.write(blob);
                                await writable.close();
                                
                                alert('Delivery form JPEG saved successfully!');
                            } catch (err) {
                                if (err.name !== 'AbortError') {
                                    console.error('Error saving file:', err);
                                    // Fallback to regular download
                                    downloadFile(blob, filename);
                                } else {
                                    // User cancelled the save dialog
                                    console.log('Save cancelled by user');
                                }
                            }
                        } else {
                            // Fallback for browsers that don't support File System Access API
                            downloadFile(blob, filename);
                        }
                    }, 'image/jpeg', 0.95); // 0.95 quality (95%)
                }).catch(error => {
                    console.error('Error generating image:', error);
                    alert('Error generating delivery form image. Please try again.');
                });
            }, 100);
        }
    </script>
</body>
</html>

