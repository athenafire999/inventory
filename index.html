<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Furniture Inventory Manager</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            min-height: 100vh;
            padding: 10px;
        }

        /* Mobile responsiveness */
        @media (max-width: 768px) {
            body {
                padding: 5px;
            }
        }

        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .login-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 40px;
            max-width: 400px;
            width: 100%;
            text-align: center;
        }

        @media (max-width: 768px) {
            .login-card {
                padding: 30px 20px;
                margin: 10px;
                border-radius: 15px;
            }
        }

        @media (max-width: 480px) {
            .login-card {
                padding: 20px 15px;
                margin: 5px;
            }
        }

        .login-header {
            margin-bottom: 30px;
        }

        .login-header h1 {
            font-size: 2.2em;
            color: #333;
            margin-bottom: 10px;
        }

        .login-header p {
            color: #666;
            font-size: 1.1em;
        }

        .user-selection {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 30px;
        }

        .user-option {
            padding: 20px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            background: #f8f9fa;
        }

        .user-option:hover {
            border-color: #3498db;
            background: #e8f4fd;
            transform: translateY(-2px);
        }

        .user-option.selected {
            border-color: #3498db;
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
        }

        .user-option h3 {
            font-size: 1.3em;
            margin-bottom: 5px;
        }

        .user-option p {
            font-size: 0.9em;
            opacity: 0.8;
        }

        .login-actions {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        .btn-login {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-login-primary {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
        }

        .btn-login-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }

        .btn-login-primary:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }


        .logout-btn-header:hover {
            background: rgba(255, 255, 255, 0.3) !important;
            border-color: rgba(255, 255, 255, 0.5) !important;
            transform: translateY(-1px);
        }

        .btn-delivery {
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            font-size: 1em;
        }

        .btn-delivery:hover {
            background: linear-gradient(135deg, #229954 0%, #1e8449 100%);
            transform: translateY(-1px);
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.4);
        }

        .delivery-modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            overflow-y: auto;
        }

        .delivery-modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .delivery-modal-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .delivery-form-group {
            margin-bottom: 20px;
        }

        .delivery-form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .delivery-form-group input[type="text"],
        .delivery-form-group input[type="date"],
        .delivery-form-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 1em;
            font-family: inherit;
        }

        .delivery-form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .delivery-checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 10px;
        }

        .delivery-checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .delivery-checkbox-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .delivery-radio-group {
            display: flex;
            gap: 20px;
            margin-top: 10px;
        }

        .delivery-radio-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .delivery-radio-item input[type="radio"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        @media (max-width: 768px) {
            .delivery-modal-content {
                padding: 20px;
                width: 95%;
            }

            .delivery-radio-group {
                flex-direction: column;
                gap: 10px;
            }
        }

        /* Hidden div for generating delivery form image */
        #deliveryFormPreview {
            position: absolute;
            left: -9999px;
            top: 0;
            width: 800px;
            background: white;
            padding: 40px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: #333;
            box-sizing: border-box;
        }

        #deliveryFormPreview h1 {
            font-size: 28px;
            font-weight: bold;
            text-align: center;
            margin-bottom: 10px;
            color: #333;
        }

        #deliveryFormPreview hr {
            border: none;
            border-top: 2px solid #333;
            margin-bottom: 30px;
        }

        #deliveryFormPreview .preview-field {
            margin-bottom: 20px;
            line-height: 1.6;
        }

        #deliveryFormPreview .preview-label {
            font-weight: bold;
            display: inline-block;
            min-width: 200px;
            margin-right: 10px;
            vertical-align: top;
        }

        #deliveryFormPreview .preview-value {
            display: inline-block;
            max-width: 500px;
            word-wrap: break-word;
        }

        #deliveryFormPreview .preview-footer {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #ddd;
            font-size: 12px;
            font-style: italic;
            color: #666;
        }


        .hidden {
            display: none !important;
        }

        .history-entry {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid #3498db;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            transition: all 0.3s;
        }

        .history-entry:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
        }

        .history-entry.add {
            border-left-color: #27ae60;
        }

        .history-entry.edit {
            border-left-color: #f39c12;
        }

        .history-entry.delete {
            border-left-color: #e74c3c;
        }

        .history-entry.status {
            border-left-color: #3498db;
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .history-action {
            font-weight: 700;
            font-size: 1.1em;
            color: #333;
        }

        .history-timestamp {
            font-size: 0.85em;
            color: #666;
            font-weight: 600;
        }

        .history-user {
            font-size: 0.9em;
            color: #3498db;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .history-details {
            color: #555;
            font-size: 0.95em;
            line-height: 1.4;
        }

        .history-item-name {
            font-weight: 600;
            color: #333;
        }

        .history-changes {
            margin-top: 8px;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 4px;
            font-size: 0.9em;
        }

        .change-item {
            margin: 3px 0;
        }

        .change-old {
            color: #dc3545;
            text-decoration: line-through;
        }

        .change-new {
            color: #28a745;
            font-weight: 600;
        }

        .empty-history {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-history h3 {
            font-size: 1.5em;
            margin-bottom: 10px;
        }

        /* Mobile-specific improvements */
        @media (max-width: 768px) {
            .add-item-section {
                padding: 20px;
                margin-bottom: 20px;
            }
            
            .btn {
                padding: 10px 20px;
                font-size: 0.9em;
            }
            
            .stat-value {
                font-size: 2em;
            }
            
            .stat-label {
                font-size: 1em;
            }
        }

        @media (max-width: 480px) {
            .add-item-section {
                padding: 15px;
                margin-bottom: 15px;
            }
            
            .btn {
                padding: 8px 16px;
                font-size: 0.85em;
            }
            
            .stat-value {
                font-size: 1.8em;
            }
            
            .stat-label {
                font-size: 0.9em;
            }
            
            .item-actions {
                flex-direction: column;
                gap: 8px;
            }
            
            .item-actions button {
                flex: none;
                width: 100%;
            }
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        @media (max-width: 768px) {
            .container {
                border-radius: 15px;
                margin: 0 5px;
            }
        }

        .header {
            background: linear-gradient(135deg, #1a252f 0%, #2c3e50 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
            border-bottom: 3px solid #3498db;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        @media (max-width: 768px) {
            .header {
                padding: 20px 15px;
            }
            
            .header h1 {
                font-size: 1.8em;
                margin-bottom: 8px;
            }
            
            .header p {
                font-size: 1em;
            }
            
            .header > div {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start !important;
            }
            
            .header > div > div:last-child {
                align-self: flex-end;
                gap: 10px;
                flex-wrap: wrap;
            }
            
            .btn-delivery {
                padding: 8px 16px !important;
                font-size: 0.9em !important;
            }
            
            .logout-btn-header {
                padding: 8px 16px !important;
                font-size: 0.9em !important;
            }
        }

        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.5em;
            }
            
            .header p {
                font-size: 0.9em;
            }
            
            .header > div > div:last-child {
                flex-direction: column;
                align-items: flex-end !important;
                gap: 8px;
                width: 100%;
            }
            
            .btn-delivery {
                width: 100%;
                padding: 10px 16px !important;
                font-size: 0.85em !important;
            }
            
            .logout-btn-header {
                padding: 6px 12px !important;
                font-size: 0.8em !important;
            }
        }

        .tabs {
            display: flex;
            background: #ecf0f1;
            border-bottom: 2px solid #bdc3c7;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: thin;
            scrollbar-color: #bdc3c7 transparent;
        }

        .tabs::-webkit-scrollbar {
            height: 4px;
        }

        .tabs::-webkit-scrollbar-track {
            background: transparent;
        }

        .tabs::-webkit-scrollbar-thumb {
            background: #bdc3c7;
            border-radius: 2px;
        }

        .tab {
            flex: 1;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 600;
            transition: all 0.3s;
            border: none;
            background: transparent;
            white-space: nowrap;
            min-width: 120px;
            flex-shrink: 0;
        }

        @media (max-width: 768px) {
            .tab {
                padding: 15px 8px;
                font-size: 0.9em;
                min-width: 120px;
                flex-shrink: 0;
            }
        }

        @media (max-width: 480px) {
            .tab {
                padding: 12px 6px;
                font-size: 0.75em;
                min-width: 90px;
                flex-shrink: 0;
            }
        }

        @media (max-width: 360px) {
            .tab {
                padding: 10px 4px;
                font-size: 0.7em;
                min-width: 80px;
                flex-shrink: 0;
            }
        }

        .tab:hover {
            background: #d5dbdb;
        }

        .tab.active {
            background: white;
            color: #2c3e50;
            border-bottom: 3px solid #3498db;
        }

        .tab-content {
            display: none;
            padding: 30px;
        }

        .tab-content.active {
            display: block;
        }

        @media (max-width: 768px) {
            .tab-content {
                padding: 20px 15px;
            }
        }

        @media (max-width: 480px) {
            .tab-content {
                padding: 15px 10px;
            }
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background: #229954;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.4);
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.4);
        }

        .btn-warning {
            background: #f39c12;
            color: white;
        }

        .btn-warning:hover {
            background: #e67e22;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(243, 156, 18, 0.4);
        }

        .add-item-section {
            background: #ecf0f1;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 30px;
            border-left: 4px solid #3498db;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
                gap: 15px;
                margin-bottom: 15px;
            }
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: border 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .inventory-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 25px;
        }

        @media (max-width: 768px) {
            .inventory-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }
        }

        @media (max-width: 480px) {
            .inventory-grid {
                gap: 15px;
            }
        }

        .inventory-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.3s;
        }

        .inventory-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        .item-image {
            width: 100%;
            height: 220px;
            object-fit: cover;
            background: #f0f0f0;
        }

        .item-details {
            padding: 20px;
        }

        .item-name {
            font-size: 1.3em;
            font-weight: 700;
            color: #333;
            margin-bottom: 10px;
        }

        .item-info {
            margin-bottom: 8px;
            color: #666;
        }

        .item-info strong {
            color: #333;
        }

        .status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            margin: 10px 0;
        }

        .status-ready {
            background: #d5f4e6;
            color: #27ae60;
            border: 1px solid #27ae60;
        }

        .status-needs-work {
            background: #fef5e7;
            color: #f39c12;
            border: 1px solid #f39c12;
        }

        .status-sold {
            background: #e8f4fd;
            color: #3498db;
            border: 1px solid #3498db;
        }

        .item-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .item-actions button {
            flex: 1;
            padding: 8px;
            font-size: 0.9em;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 20px;
                margin-bottom: 20px;
            }
        }

        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
                gap: 15px;
                margin-bottom: 15px;
            }
        }

        .stat-card {
            background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%);
            color: white;
            padding: 30px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid #34495e;
        }

        .stat-card.green {
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
            border-color: #27ae60;
        }

        .stat-card.red {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            border-color: #e74c3c;
        }

        .stat-card.blue {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            border-color: #3498db;
        }

        .stat-card.orange {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
            border-color: #f39c12;
        }

        .stat-value {
            font-size: 2.5em;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .stat-label {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .details-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 12px;
            overflow: hidden;
        }

        @media (max-width: 768px) {
            .details-table {
                font-size: 0.9em;
            }
        }

        @media (max-width: 480px) {
            .details-table {
                font-size: 0.8em;
            }
        }

        .details-table thead {
            background: #2c3e50;
            color: white;
        }

        .details-table th,
        .details-table td {
            padding: 15px;
            text-align: left;
        }

        .details-table tbody tr {
            border-bottom: 1px solid #e0e0e0;
        }

        .details-table tbody tr:hover {
            background: #f8f9fa;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        @media (max-width: 768px) {
            .modal-content {
                padding: 20px;
                width: 95%;
                max-height: 85vh;
            }
        }

        @media (max-width: 480px) {
            .modal-content {
                padding: 15px;
                width: 98%;
                max-height: 80vh;
            }
        }

        .modal-header {
            font-size: 1.5em;
            font-weight: 700;
            margin-bottom: 20px;
            color: #333;
        }

        .image-preview {
            width: 100%;
            max-height: 200px;
            object-fit: contain;
            margin-top: 10px;
            border-radius: 8px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state h3 {
            font-size: 1.5em;
            margin-bottom: 10px;
        }

        .month-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid #e0e0e0;
        }

        .month-card:hover {
            border-color: #667eea;
            transform: translateX(5px);
        }

        .month-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .month-title {
            font-size: 1.2em;
            font-weight: 700;
            color: #333;
        }

        .month-stats {
            display: flex;
            gap: 30px;
            font-size: 0.95em;
        }

        .month-details {
            display: none;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #f0f0f0;
        }

        .month-details.active {
            display: block;
        }

        .month-items-list {
            display: grid;
            gap: 10px;
        }

        .month-item {
            display: flex;
            justify-content: space-between;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 6px;
        }

        .expand-icon {
            transition: transform 0.3s;
        }

        .expand-icon.rotated {
            transform: rotate(180deg);
        }

        .photo-gallery {
            position: relative;
            width: 100%;
            height: 220px;
            overflow: hidden;
        }

        .photo-gallery img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            cursor: pointer;
        }

        .photo-counter {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .work-notes-box {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 12px;
            margin: 10px 0;
            border-radius: 4px;
        }

        .work-notes-box strong {
            color: #856404;
            display: block;
            margin-bottom: 5px;
        }

        .work-notes-box p {
            color: #856404;
            margin: 0;
            white-space: pre-wrap;
        }

        /* Reorder Button Styles */
        .reorderable-item {
            position: relative;
        }
        
        .reorder-buttons {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            flex-direction: column;
            gap: 2px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .reorderable-item:hover .reorder-buttons {
            opacity: 1;
        }
        
        /* Always show arrows on mobile */
        @media (max-width: 768px) {
            .reorder-buttons {
                opacity: 1;
            }
        }
        
        .reorder-btn {
            background: rgba(102, 126, 234, 0.9);
            color: white;
            border: none;
            border-radius: 4px;
            width: 24px;
            height: 20px;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        
        /* Larger buttons on mobile for easier tapping */
        @media (max-width: 768px) {
            .reorder-btn {
                width: 28px;
                height: 24px;
                font-size: 14px;
            }
        }
        
        .reorder-btn:hover {
            background: rgba(102, 126, 234, 1);
            transform: scale(1.1);
        }
        
        .reorder-btn:active {
            transform: scale(0.95);
        }
        
        .priority-indicator {
            position: absolute;
            top: 10px;
            left: 10px;
            background: #667eea;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8em;
            font-weight: 700;
        }

        .photo-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .photo-modal.active {
            display: flex;
        }

        .photo-modal-content {
            max-width: 90%;
            max-height: 90%;
            position: relative;
        }

        .photo-modal-content img {
            max-width: 100%;
            max-height: 90vh;
            object-fit: contain;
        }

        .photo-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.9);
            border: none;
            font-size: 2em;
            padding: 10px 20px;
            cursor: pointer;
            border-radius: 5px;
            color: #333;
        }

        .photo-nav:hover {
            background: white;
        }

        .photo-nav.prev {
            left: 20px;
        }

        .photo-nav.next {
            right: 20px;
        }

        .photo-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: white;
            border: none;
            font-size: 2em;
            padding: 10px 20px;
            cursor: pointer;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-container">
        <div class="login-card">
            <div class="login-header">
                <h1>Furniture Inventory System</h1>
                <p>Please select your user account to continue</p>
        </div>

            <div class="user-selection">
                <div class="user-option" onclick="selectUser('mike')" id="mike-option">
                    <h3>Mike</h3>
                    <p>Administrator Access</p>
        </div>
                <div class="user-option" onclick="selectUser('dee')" id="dee-option">
                    <h3>Dee</h3>
                    <p>Administrator Access</p>
        </div>
        </div>

            <div class="pin-section" style="margin-top: 20px;">
                <label for="pinInput" style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">Enter PIN Code:</label>
                <input type="password" id="pinInput" placeholder="Enter PIN" maxlength="4" style="
                    width: 100%;
                    padding: 12px;
                    border: 2px solid #ddd;
                    border-radius: 8px;
                    font-size: 18px;
                    text-align: center;
                    letter-spacing: 2px;
                    font-weight: 600;
                    transition: border-color 0.3s;
                " oninput="checkPinAndEnableLogin()">
        </div>

            <div class="login-actions">
                <button class="btn-login btn-login-primary" id="loginBtn" onclick="login()" disabled>
                    Access Inventory
                </button>
        </div>
                    </div>
                    </div>

    <!-- Main Application -->
    <div id="mainApp" class="hidden">
        
        <div class="container">
        <div class="header">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h1><span onclick="showHiddenHistory()" style="cursor: pointer; user-select: none; font-weight: 300;">INV</span> Furniture Inventory Manager</h1>
                    <p>Professional Inventory & Sales Management System</p>
                </div>
                <div style="display: flex; align-items: center; gap: 15px;">
                    <button onclick="switchToDeliveryForm()" class="btn-delivery">
                        Create Delivery Form
                    </button>
                    <div style="background: rgba(255, 255, 255, 0.1); padding: 8px 15px; border-radius: 6px; font-weight: 600;">
                        User: <span id="currentUserHeader"></span>
                    </div>
                    <button onclick="logout()" class="logout-btn-header" style="
                        background: rgba(255, 255, 255, 0.2);
                        border: 1px solid rgba(255, 255, 255, 0.3);
                        color: white;
                        padding: 10px 20px;
                        border-radius: 6px;
                        cursor: pointer;
                        font-weight: 600;
                        transition: all 0.3s;
                    ">
                        Logout
                    </button>
                </div>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('statistics')">Statistics</button>
            <button class="tab" onclick="switchTab('additem')">New Items</button>
            <button class="tab" onclick="switchTab('inventory')">Inventory (<span id="inventoryCount">0</span>)</button>
            <button class="tab" onclick="switchTab('needswork')">Not Ready (<span id="needsworkCount">0</span>)</button>
            <button class="tab" onclick="switchTab('sold')">Sold (<span id="soldCount">0</span>)</button>
            <button class="tab" onclick="switchTab('deliveryform')">Delivery Form</button>
        </div>

        <!-- Statistics Tab -->
        <div id="statistics" class="tab-content active">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
                <h3 style="margin: 0;">Overall Statistics</h3>
                <button onclick="exportToExcel()" class="btn btn-success" style="padding: 10px 20px; font-size: 0.95em;">
                    Export to Excel
                </button>
            </div>
            <div class="stats-grid">
                <div class="stat-card blue">
                    <div class="stat-value" id="totalBalance">£0.00</div>
                    <div class="stat-label">Current Balance</div>
                    <button onclick="openBalanceModal()" style="margin-top: 15px; padding: 8px 16px; background: white; color: #667eea; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                        Edit Balance
                    </button>
                </div>
                <div class="stat-card green">
                    <div class="stat-value" id="moneyIn">£0.00</div>
                    <div class="stat-label">Money In (Sales)</div>
                </div>
                <div class="stat-card red">
                    <div class="stat-value" id="moneyOut">£0.00</div>
                    <div class="stat-label">Money Out (Purchases)</div>
                </div>
                <div class="stat-card orange">
                    <div class="stat-value" id="totalProfit">£0.00</div>
                    <div class="stat-label">Total Profit</div>
                </div>
            </div>

            <div style="background: #f8f9fa; padding: 25px; border-radius: 12px; margin-top: 30px;">
                <h3 style="margin-bottom: 15px;">Balance Breakdown</h3>
                <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <div style="display: grid; gap: 12px;">
                        <div style="display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #e0e0e0;">
                            <span style="color: #666;">Sales Revenue:</span>
                            <span style="font-weight: 600; color: #28a745;" id="balanceMoneyIn">£0.00</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #e0e0e0;">
                            <span style="color: #666;">Inventory Purchases:</span>
                            <span style="font-weight: 600; color: #dc3545;" id="balanceMoneyOut">-£0.00</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #e0e0e0;">
                            <span style="color: #666;">Additional Income:</span>
                            <span style="font-weight: 600; color: #28a745;" id="balanceAdditionalIncome">£0.00</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 10px; border-bottom: 2px solid #667eea;">
                            <span style="color: #666;">Additional Expenses:</span>
                            <span style="font-weight: 600; color: #dc3545;" id="balanceAdditionalExpenses">-£0.00</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 12px; background: #f8f9fa; border-radius: 6px;">
                            <span style="font-weight: 700; font-size: 1.1em;">Total Balance:</span>
                            <span style="font-weight: 700; font-size: 1.1em; color: #667eea;" id="balanceTotal">£0.00</span>
                        </div>
                    </div>
                </div>
            </div>

            <div style="background: #f8f9fa; padding: 25px; border-radius: 12px; margin-top: 30px;">
                <h3 style="margin-bottom: 15px;">This Month's Sales</h3>
                <div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
                    <div style="background: white; padding: 20px; border-radius: 8px;">
                        <div style="font-size: 2em; font-weight: 700; color: #28a745;" id="monthSoldItems">0</div>
                        <div style="color: #666;">Items Sold</div>
                    </div>
                    <div style="background: white; padding: 20px; border-radius: 8px;">
                        <div style="font-size: 2em; font-weight: 700; color: #667eea;" id="monthRevenue">£0.00</div>
                        <div style="color: #666;">Revenue</div>
                    </div>
                    <div style="background: white; padding: 20px; border-radius: 8px;">
                        <div style="font-size: 2em; font-weight: 700; color: #ffc107;" id="monthProfit">£0.00</div>
                        <div style="color: #666;">Profit</div>
                    </div>
                </div>
            </div>

            <div style="background: white; padding: 25px; border-radius: 12px; margin-top: 30px; border: 2px solid #e0e0e0;">
                <h3 style="margin-bottom: 20px;">Monthly Sales Chart</h3>
                <canvas id="salesChart" style="max-height: 400px;"></canvas>
            </div>

            <div style="background: #f8f9fa; padding: 25px; border-radius: 12px; margin-top: 30px;">
                <h3 style="margin-bottom: 15px;">Month by Month Breakdown</h3>
                <div id="monthlyBreakdown"></div>
            </div>

            <div style="background: #f8f9fa; padding: 25px; border-radius: 12px; margin-bottom: 20px;">
                <h3 style="margin-bottom: 15px;">Inventory Summary</h3>
                <div class="stats-grid">
                    <div style="background: white; padding: 20px; border-radius: 8px;">
                        <div style="font-size: 2em; font-weight: 700; color: #667eea;" id="totalItems">0</div>
                        <div style="color: #666;">Total Items</div>
                    </div>
                    <div style="background: white; padding: 20px; border-radius: 8px;">
                        <div style="font-size: 2em; font-weight: 700; color: #28a745;" id="readyItems">0</div>
                        <div style="color: #666;">Ready to Sell</div>
                    </div>
                    <div style="background: white; padding: 20px; border-radius: 8px;">
                        <div style="font-size: 2em; font-weight: 700; color: #ffc107;" id="needsWorkItems">0</div>
                        <div style="color: #666;">Needs Work</div>
                    </div>
                    <div style="background: white; padding: 20px; border-radius: 8px;">
                        <div style="font-size: 2em; font-weight: 700; color: #17a2b8;" id="soldItems">0</div>
                        <div style="color: #666;">Sold</div>
                    </div>
                    <div style="background: white; padding: 20px; border-radius: 8px;">
                        <div style="font-size: 2em; font-weight: 700; color: #764ba2;" id="avgDaysInStock">0</div>
                        <div style="color: #666;">Avg Days in Stock</div>
                    </div>
                    <div style="background: white; padding: 20px; border-radius: 8px;">
                        <div style="font-size: 2em; font-weight: 700; color: #e83e8c;" id="avgDaysToSell">0</div>
                        <div style="color: #666;">Avg Days to Sell</div>
                    </div>
                </div>
            </div>

            <h3 style="margin-bottom: 15px;">Transaction Details</h3>
            <table class="details-table">
                <thead>
                    <tr>
                        <th>Item Number</th>
                        <th>Item</th>
                        <th>Purchase Date</th>
                        <th>Days in Stock</th>
                        <th>Purchase Price</th>
                        <th>Sold Date</th>
                        <th>Sold Price</th>
                        <th>Profit</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="detailsTableBody"></tbody>
            </table>
        </div>

        <!-- Inventory Tab -->
        <div id="inventory" class="tab-content">
            <div id="inventoryList" style="padding: 20px 0;"></div>
        </div>

        <!-- Add New Item Tab -->
        <div id="additem" class="tab-content">
            <div class="add-item-section">
                <h2 style="margin-bottom: 20px;">Add New Item to Inventory</h2>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Item Name</label>
                        <input type="text" id="itemName" placeholder="e.g., Oak Dining Table">
                    </div>
                    <div class="form-group">
                        <label>Purchase Date</label>
                        <input type="date" id="purchaseDate">
                    </div>
                    <div class="form-group">
                        <label>Purchase Price (£)</label>
                        <input type="number" id="purchasePrice" step="0.01" placeholder="0.00">
                    </div>
                    <div class="form-group">
                        <label>Affect Balance</label>
                        <select id="affectBalance">
                            <option value="yes">Yes - Deduct from balance</option>
                            <option value="no">No - Don't affect balance</option>
                        </select>
                        <small style="color: #666; font-size: 0.85em;">Choose "No" for donated/found/free items</small>
                    </div>
                    <div class="form-group">
                        <label>Status</label>
                        <select id="itemStatus">
                            <option value="ready">Ready to Sell</option>
                            <option value="needs-work">Needs Work</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Item Photos</label>
                        <input type="file" id="itemPhoto" accept="image/*" multiple>
                        <small style="color: #666; font-size: 0.85em;">You can select multiple photos</small>
                    </div>
                    <div class="form-group">
                        <label>Work Required Photos</label>
                        <input type="file" id="workPhotos" accept="image/*" multiple>
                        <small style="color: #666; font-size: 0.85em;">Photos of damage/work needed</small>
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="itemDescription" rows="1" placeholder="Optional details"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Work Notes (Optional)</label>
                        <textarea id="itemWorkNotes" rows="1" placeholder="Optional text notes"></textarea>
                    </div>
                </div>
                <div style="margin-top: 20px;">
                    <button class="btn btn-primary" onclick="addItem()">Add Item to Inventory</button>
                </div>
            </div>
        </div>

        <!-- Needs Work Tab -->
        <div id="needswork" class="tab-content">
            <div id="needsWorkList" style="padding: 20px 0;"></div>
        </div>

        <!-- Sold Tab -->
        <div id="sold" class="tab-content">
            <div id="soldList" style="padding: 20px 0;"></div>
        </div>

        <!-- Delivery Form Tab -->
        <div id="deliveryform" class="tab-content">
            <div style="max-width: 800px; margin: 0 auto;">
                <h2 style="margin-bottom: 25px; color: #333;">Delivery Form</h2>
                
                <form id="deliveryForm" onsubmit="showCompletedForm(event)">
                    <div class="delivery-form-group">
                        <label for="deliveryJobCode">Job Number *</label>
                        <input type="text" id="deliveryJobCode" placeholder="e.g., 1-1, 1-2, 2-1" required style="max-width: 200px;">
                    </div>

                    <div class="delivery-form-group">
                        <label for="deliveryItemName">Item Name *</label>
                        <input type="text" id="deliveryItemName" placeholder="Enter item name..." required>
                    </div>

                    <div class="delivery-form-group">
                        <label for="deliveryDate">Delivery Date *</label>
                        <input type="date" id="deliveryDate" required onchange="updateDeliveryDateDisplay()">
                        <div id="deliveryDateDisplay" style="margin-top: 5px; font-weight: 600; color: #3498db;"></div>
                    </div>

                    <div class="delivery-form-group">
                        <label>Sold On *</label>
                        <div class="delivery-checkbox-group">
                            <div class="delivery-checkbox-item">
                                <input type="checkbox" id="soldFacebook" name="soldOn" value="Facebook">
                                <label for="soldFacebook" style="margin: 0; font-weight: normal;">Facebook</label>
                            </div>
                            <div class="delivery-checkbox-item">
                                <input type="checkbox" id="soldEbay" name="soldOn" value="eBay">
                                <label for="soldEbay" style="margin: 0; font-weight: normal;">eBay</label>
                            </div>
                            <div class="delivery-checkbox-item">
                                <input type="checkbox" id="soldOther" name="soldOn" value="Other">
                                <label for="soldOther" style="margin: 0; font-weight: normal;">Other</label>
                            </div>
                        </div>
                    </div>

                    <div class="delivery-form-group">
                        <label>Driver to get collect code</label>
                        <div class="delivery-checkbox-item">
                            <input type="checkbox" id="driverCollectCode" checked>
                            <label for="driverCollectCode" style="margin: 0; font-weight: normal;">Driver should get collect code</label>
                        </div>
                    </div>

                    <div class="delivery-form-group">
                        <label>Driver should take payment for item *</label>
                        <div class="delivery-radio-group">
                            <div class="delivery-radio-item">
                                <input type="radio" id="paymentYes" name="driverPaymentItem" value="Yes">
                                <label for="paymentYes" style="margin: 0; font-weight: normal;">Yes</label>
                            </div>
                            <div class="delivery-radio-item">
                                <input type="radio" id="paymentNo" name="driverPaymentItem" value="No" checked>
                                <label for="paymentNo" style="margin: 0; font-weight: normal;">No</label>
                            </div>
                        </div>
                    </div>

                    <div class="delivery-form-group">
                        <label>Driver should take payment for delivery *</label>
                        <div class="delivery-radio-group">
                            <div class="delivery-radio-item">
                                <input type="radio" id="deliveryPaymentYes" name="driverPaymentDelivery" value="Yes">
                                <label for="deliveryPaymentYes" style="margin: 0; font-weight: normal;">Yes</label>
                            </div>
                            <div class="delivery-radio-item">
                                <input type="radio" id="deliveryPaymentNo" name="driverPaymentDelivery" value="No" checked>
                                <label for="deliveryPaymentNo" style="margin: 0; font-weight: normal;">No</label>
                            </div>
                        </div>
                    </div>

                    <div class="delivery-form-group">
                        <label for="deliverySpecialComments">Special Comments</label>
                        <textarea id="deliverySpecialComments" rows="4" placeholder="Any special instructions or comments..."></textarea>
                    </div>

                    <div class="delivery-form-group">
                        <label for="deliveryAddress">Address *</label>
                        <textarea id="deliveryAddress" rows="3" placeholder="Enter full address (street, county, postcode)..." required></textarea>
                    </div>

                    <div style="display: flex; gap: 10px; margin-top: 25px;">
                        <button type="button" class="btn btn-danger" onclick="resetDeliveryForm()" style="flex: 1;">Reset Form</button>
                        <button type="submit" class="btn btn-success" style="flex: 1;">Done</button>
                    </div>
                </form>

                <!-- Completed Form View -->
                <div id="completedFormView" style="display: none; max-width: 800px; margin: 0 auto;">
                    <div id="completedFormContent" style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); max-width: 100%; box-sizing: border-box;">
                        <!-- Content will be populated by JavaScript -->
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 25px;">
                        <button type="button" class="btn btn-primary" onclick="editDeliveryForm()" style="flex: 1;">Edit</button>
                        <button type="button" class="btn btn-success" onclick="downloadCompletedFormPDF()" style="flex: 1;">Download PDF</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- History Tab -->
        <div id="history" class="tab-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3>Edit History</h3>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <select id="historyFilter" onchange="filterHistory()" style="padding: 8px 12px; border: 2px solid #e0e0e0; border-radius: 6px;">
                        <option value="all">All Changes</option>
                        <option value="add">Items Added</option>
                        <option value="edit">Items Edited</option>
                        <option value="delete">Items Deleted</option>
                        <option value="status">Status Changes</option>
                        <option value="balance_transaction">Balance Transactions</option>
                        <option value="balance_transaction_delete">Balance Deletions</option>
                    </select>
                    <button class="btn btn-danger" onclick="clearHistory()" style="padding: 8px 16px; font-size: 0.9em;">
                        Clear History
                    </button>
                </div>
            </div>
            
            <div id="historyList" style="max-height: 600px; overflow-y: auto;">
                <!-- History entries will be displayed here -->
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">Edit Item</div>
            <div class="form-group" style="margin-bottom: 15px;">
                <label>Item Number</label>
                <input type="text" id="editItemNumber" readonly style="background: #f0f0f0; cursor: not-allowed; font-weight: 600; color: #667eea;">
            </div>
            <div class="form-grid">
                <div class="form-group">
                    <label>Item Name</label>
                    <input type="text" id="editItemName">
                </div>
                <div class="form-group">
                    <label>Purchase Date</label>
                    <input type="date" id="editPurchaseDate">
                </div>
                    <div class="form-group">
                        <label>Purchase Price (£)</label>
                        <input type="number" id="editPurchasePrice" step="0.01">
                    </div>
                    <div class="form-group">
                        <label>Affect Balance</label>
                        <select id="editAffectBalance">
                            <option value="yes">Yes - Deduct from balance</option>
                            <option value="no">No - Don't affect balance</option>
                        </select>
                        <small style="color: #666; font-size: 0.85em;">Choose "No" for donated/found/free items</small>
                    </div>
                <div class="form-group">
                    <label>Sold Date</label>
                    <input type="date" id="editSoldDate">
                </div>
                <div class="form-group">
                    <label>Sold Price (£)</label>
                    <input type="number" id="editSoldPrice" step="0.01">
                </div>
                <div class="form-group">
                    <label>Add to Balance</label>
                    <select id="editAddToBalance">
                        <option value="yes">Yes - Add to balance</option>
                        <option value="no">No - Don't add to balance</option>
                    </select>
                    <small style="color: #666; font-size: 0.85em;">Choose "No" if you want to manually add the money later</small>
                </div>
                <div class="form-group">
                    <label>Status</label>
                    <select id="editItemStatus">
                        <option value="ready">Ready to Sell</option>
                        <option value="needs-work">Needs Work</option>
                        <option value="sold">Sold</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="editItemDescription" rows="2"></textarea>
                </div>
                <div class="form-group" style="grid-column: 1 / -1;">
                    <label>Main Item Photos</label>
                    <div id="editMainPhotosPreview" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; margin-bottom: 10px;"></div>
                    <input type="file" id="editMainPhotos" accept="image/*" multiple>
                    <small style="color: #666; font-size: 0.85em;">Add or replace main photos of the item</small>
                </div>
                <div class="form-group" style="grid-column: 1 / -1;">
                    <label>Work Required Photos</label>
                    <div id="editWorkPhotosPreview" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; margin-bottom: 10px;"></div>
                    <input type="file" id="editWorkPhotos" accept="image/*" multiple>
                    <small style="color: #666; font-size: 0.85em;">Add photos showing areas that need work</small>
                </div>
                <div class="form-group" style="grid-column: 1 / -1;">
                    <label>Work Notes (Optional)</label>
                    <textarea id="editItemWorkNotes" rows="2" placeholder="Optional: Add text notes about the work needed"></textarea>
                </div>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn btn-success" onclick="saveEdit()">Save Changes</button>
                <button class="btn btn-danger" onclick="closeEditModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Photo Modal -->
    <div id="photoModal" class="photo-modal">
        <button class="photo-close" onclick="closePhotoModal()">✕</button>
        <div class="photo-modal-content">
            <button class="photo-nav prev" onclick="prevPhoto()">‹</button>
            <img id="photoModalImage" src="" alt="">
            <button class="photo-nav next" onclick="nextPhoto()">›</button>
            <div style="text-align: center; margin-top: 15px; color: white;">
                <span id="photoCounter"></span>
            </div>
        </div>
    </div>

    <!-- Full View Modal -->
    <div id="fullViewModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <span id="fullViewItemName">Item Details</span>
                <button onclick="closeFullViewModal()" style="background: none; border: none; font-size: 1.5em; cursor: pointer; color: #666;">✕</button>
            </div>
            
            <div id="fullViewContent" style="padding: 20px;">
                <!-- Content will be populated by JavaScript -->
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px; justify-content: flex-end;">
                <button class="btn btn-danger" onclick="deleteFromFullView()">Delete Item</button>
                <button class="btn btn-primary" onclick="editFromFullView()">Edit Item</button>
                <button class="btn btn-secondary" onclick="closeFullViewModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Balance Modal -->
    <div id="balanceModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">Manage Balance & Transactions</div>
            
            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                <h4 style="margin-bottom: 15px;">Add Transaction</h4>
                <div class="form-grid" style="grid-template-columns: 2fr 1fr 1fr 1fr;">
                    <div class="form-group">
                        <label>Description</label>
                        <input type="text" id="transactionDesc" placeholder="e.g., Rent, Tools, Cash deposit">
                    </div>
                    <div class="form-group">
                        <label>Amount (£)</label>
                        <input type="number" id="transactionAmount" step="0.01" placeholder="0.00">
                    </div>
                    <div class="form-group">
                        <label>Type</label>
                        <select id="transactionType">
                            <option value="expense">Expense (-)</option>
                            <option value="income">Income (+)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Date</label>
                        <input type="date" id="transactionDate">
                    </div>
                </div>
                <button class="btn btn-primary" onclick="addTransaction()" style="margin-top: 10px;">Add Transaction</button>
            </div>

            <div style="background: #e8f5e8; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                <h4 style="margin-bottom: 15px;">Sold Items - Add to Balance</h4>
                <p style="color: #666; margin-bottom: 15px;">These sold items haven't been added to your balance yet. Click to add them as income transactions.</p>
                <div id="soldItemsList" style="max-height: 200px; overflow-y: auto;">
                    <!-- Sold items will be listed here -->
                </div>
            </div>

            <div>
                <h4 style="margin-bottom: 15px;">Transaction History</h4>
                <div id="transactionList" style="max-height: 300px; overflow-y: auto;">
                    <!-- Transactions will be listed here -->
                </div>
            </div>

            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn btn-success" onclick="closeBalanceModal()">Done</button>
            </div>
        </div>
    </div>

    <!-- Hidden div for delivery form preview (used for image generation) -->
    <div id="deliveryFormPreview"></div>

    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script>
        // Supabase configuration
        const supabaseUrl = 'https://ipygreexokruwqjqvuuk.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlweWdyZWV4b2tydXdxanF2dXVrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3Mjg0NjcsImV4cCI6MjA3NjMwNDQ2N30.1itsG_KGK4_wqA7y1La9neJ9AkH4hDe0ouEwM1xvYwA';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        // Test Supabase connection
        console.log('Supabase client initialized:', supabase);
        console.log('Supabase URL:', supabaseUrl);
        console.log('Supabase Key (first 20 chars):', supabaseKey.substring(0, 20) + '...');

        // Test Supabase connection
        async function testSupabaseConnection() {
            try {
                console.log('Testing Supabase connection...');
                const { data, error } = await supabase
                    .from('inventory')
                    .select('count')
                    .limit(1);
                
                if (error) {
                    console.error('Supabase connection test failed:', error);
                } else {
                    console.log('Supabase connection test successful:', data);
                }
                
                // Test inventory table specifically
                console.log('Testing inventory table access...');
                const { data: testData, error: testError } = await supabase
                    .from('inventory')
                    .select('*')
                    .limit(1);
                
                if (testError) {
                    console.error('❌ Inventory table access failed:', testError);
                    console.error('❌ Error details:', {
                        message: testError.message,
                        details: testError.details,
                        hint: testError.hint,
                        code: testError.code
                    });
                } else {
                    console.log('✅ Inventory table access successful:', testData);
                }
                
                // Test specific columns
                console.log('Testing inventory table columns...');
                const { data: colData, error: colError } = await supabase
                    .from('inventory')
                    .select('id, item_number, name, purchase_date, purchase_price, status')
                    .limit(1);
                
                if (colError) {
                    console.error('❌ Inventory column test failed:', colError);
                } else {
                    console.log('✅ Inventory column test successful:', colData);
                }
                
                // Test transactions table for comparison
                console.log('Testing transactions table access...');
                const { data: transData, error: transError } = await supabase
                    .from('transactions')
                    .select('*')
                    .limit(1);
                
                if (transError) {
                    console.error('❌ Transactions table access failed:', transError);
                } else {
                    console.log('✅ Transactions table access successful:', transData);
                }
                
            } catch (err) {
                console.error('Supabase connection test error:', err);
            }
        }

        // Test inserting a simple item
        async function testInventoryInsert() {
            try {
                console.log('🧪 Testing inventory insert...');
                const testItem = {
                    item_number: 'TEST-001',
                    name: 'Test Item',
                    purchase_date: '2024-01-01',
                    purchase_price: 10.00,
                    sold_date: null,
                    sold_price: null,
                    status: 'ready',
                    description: 'Test item for debugging',
                    work_notes: '',
                    affect_balance: true,
                    add_to_balance: true,
                    photos: [],
                    work_photos: []
                };
                
                const { data, error } = await supabase
                    .from('inventory')
                    .insert([testItem])
                    .select();
                
                if (error) {
                    console.error('❌ Test insert failed:', error);
                    console.error('❌ Insert error details:', {
                        message: error.message,
                        details: error.details,
                        hint: error.hint,
                        code: error.code
                    });
                } else {
                    console.log('✅ Test insert successful:', data);
                    
                    // Clean up test item
                    if (data && data.length > 0) {
                        const { error: deleteError } = await supabase
                            .from('inventory')
                            .delete()
                            .eq('id', data[0].id);
                        
                        if (deleteError) {
                            console.error('❌ Test cleanup failed:', deleteError);
                        } else {
                            console.log('✅ Test cleanup successful');
                        }
                    }
                }
            } catch (err) {
                console.error('❌ Test insert error:', err);
            }
        }

        // Run connection test after page loads
        window.addEventListener('load', () => {
            setTimeout(async () => {
                await testSupabaseConnection();
                await testInventoryInsert();
            }, 1000); // Wait 1 second for everything to load
        });

        // Authentication variables
        let currentUser = null;
        let selectedUser = null;

        // Check if user is already logged in
        function checkAuth() {
            const savedUser = localStorage.getItem('furnitureUser');
            if (savedUser) {
                currentUser = savedUser;
                showMainApp();
            } else {
                showLoginScreen();
            }
        }

        // Show login screen
        function showLoginScreen() {
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
        }

        // Show main application
        async function showMainApp() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            document.getElementById('currentUserHeader').textContent = currentUser.charAt(0).toUpperCase() + currentUser.slice(1);
            
            // Load inventory data
            await loadInventory();
        }

        // Select user for login
        function selectUser(user) {
            selectedUser = user;
            
            // Update UI
            document.querySelectorAll('.user-option').forEach(option => {
                option.classList.remove('selected');
            });
            document.getElementById(user + '-option').classList.add('selected');
            
            // Check if PIN is correct to enable login button
            checkPinAndEnableLogin();
        }

        // Check PIN and enable login button if correct
        function checkPinAndEnableLogin() {
            const pinInput = document.getElementById('pinInput');
            const loginBtn = document.getElementById('loginBtn');
            const correctPin = '1990';
            
            if (selectedUser && pinInput.value === correctPin) {
                loginBtn.disabled = false;
                pinInput.style.borderColor = '#28a745';
            } else {
                loginBtn.disabled = true;
                pinInput.style.borderColor = pinInput.value.length > 0 ? '#dc3545' : '#ddd';
            }
        }

        // Login function
        async function login() {
            if (!selectedUser) return;
            
            const pinInput = document.getElementById('pinInput');
            const correctPin = '1990';
            
            if (pinInput.value !== correctPin) {
                alert('Invalid PIN code. Please enter the correct PIN.');
                pinInput.focus();
                return;
            }
            
            currentUser = selectedUser;
            localStorage.setItem('furnitureUser', currentUser);
            await showMainApp();
        }

        // Logout function
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                currentUser = null;
                selectedUser = null;
                localStorage.removeItem('furnitureUser');
                showLoginScreen();
                
                // Clear any selections and PIN
                document.querySelectorAll('.user-option').forEach(option => {
                    option.classList.remove('selected');
                });
                document.getElementById('loginBtn').disabled = true;
                document.getElementById('pinInput').value = '';
                document.getElementById('pinInput').style.borderColor = '#ddd';
            }
        }


        // Show history in a modal overlay
        function showHiddenHistory() {
            // Create modal if it doesn't exist
            let modal = document.getElementById('historyModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'historyModal';
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.8);
                    z-index: 3000;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    padding: 20px;
                `;
                
                modal.innerHTML = `
                    <div style="
                        background: white;
                        border-radius: 12px;
                        max-width: 900px;
                        width: 100%;
                        max-height: 80vh;
                        overflow: hidden;
                        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
                    ">
                        <div style="
                            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
                            color: white;
                            padding: 20px;
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                        ">
                            <h2 style="margin: 0; font-size: 1.5em;">Edit History</h2>
                            <button onclick="closeHiddenHistory()" style="
                                background: rgba(255, 255, 255, 0.2);
                                border: none;
                                color: white;
                                font-size: 1.5em;
                                padding: 8px 12px;
                                border-radius: 6px;
                                cursor: pointer;
                                font-weight: bold;
                            ">✕</button>
                        </div>
                        <div style="padding: 20px;">
                            <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 20px;">
                                <select id="modalHistoryFilter" onchange="filterModalHistory()" style="padding: 8px 12px; border: 2px solid #e0e0e0; border-radius: 6px;">
                                    <option value="all">All Changes</option>
                                    <option value="add">Items Added</option>
                                    <option value="edit">Items Edited</option>
                                    <option value="delete">Items Deleted</option>
                                    <option value="status">Status Changes</option>
                                    <option value="balance_transaction">Balance Transactions</option>
                                    <option value="balance_transaction_delete">Balance Deletions</option>
                                </select>
                                <button onclick="clearHistory()" style="padding: 8px 16px; background: #dc3545; color: white; border: none; border-radius: 6px; cursor: pointer;">
                                    Clear History
                                </button>
                            </div>
                            <div id="modalHistoryList" style="max-height: 400px; overflow-y: auto;">
                                <!-- History entries will be displayed here -->
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
            }
            
            // Show modal and render history
            modal.style.display = 'flex';
            renderModalHistory();
        }

        // Close hidden history modal
        function closeHiddenHistory() {
            const modal = document.getElementById('historyModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // Render history in modal
        function renderModalHistory(filter = 'all') {
            const historyList = document.getElementById('modalHistoryList');
            
            if (editHistory.length === 0) {
                historyList.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #999;">
                        <h3>No edit history yet</h3>
                        <p>Changes to inventory items will be tracked here</p>
                    </div>
                `;
                return;
            }

            let filteredHistory = editHistory;
            if (filter !== 'all') {
                filteredHistory = editHistory.filter(entry => entry.action === filter);
            }

            historyList.innerHTML = filteredHistory.map(entry => {
                const date = new Date(entry.timestamp);
                const timeString = date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
                
                let actionText = '';
                let actionIcon = '';
                
                switch (entry.action) {
                    case 'add':
                        actionText = 'Item Added';
                        actionIcon = '[+]';
                        break;
                    case 'edit':
                        actionText = 'Item Edited';
                        actionIcon = '[Edit]';
                        break;
                    case 'delete':
                        actionText = 'Item Deleted';
                        actionIcon = '[Delete]';
                        break;
                    case 'status':
                        actionText = 'Status Changed';
                        actionIcon = '[Status]';
                        break;
                    case 'balance_transaction':
                        actionText = 'Balance Transaction Added';
                        actionIcon = '[Balance+]';
                        break;
                    case 'balance_transaction_delete':
                        actionText = 'Balance Transaction Deleted';
                        actionIcon = '[Balance-]';
                        break;
                }

                let changesHtml = '';
                if (entry.changes && entry.changes.length > 0) {
                    changesHtml = `
                        <div style="margin-top: 8px; padding: 8px; background: #f8f9fa; border-radius: 4px; font-size: 0.9em;">
                            <strong>Changes made:</strong>
                            ${entry.changes.map(change => `
                                <div style="margin: 3px 0;">
                                    <strong>${change.field}:</strong>
                                    ${change.oldValue ? `<span style="color: #dc3545; text-decoration: line-through;">${change.oldValue}</span>` : ''}
                                    ${change.oldValue && change.newValue ? ' → ' : ''}
                                    ${change.newValue ? `<span style="color: #28a745; font-weight: 600;">${change.newValue}</span>` : ''}
                                </div>
                            `).join('')}
                        </div>
                    `;
                }

                return `
                    <div style="background: white; border-radius: 8px; padding: 15px; margin-bottom: 10px; border-left: 4px solid #667eea; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <div style="font-weight: 700; font-size: 1.1em; color: #333;">${actionIcon} ${actionText}</div>
                            <div style="font-size: 0.85em; color: #666; font-weight: 600;">${timeString}</div>
                        </div>
                        <div style="font-size: 0.9em; color: #3498db; font-weight: 600; margin-bottom: 5px;">User: ${entry.user ? entry.user.charAt(0).toUpperCase() + entry.user.slice(1) : 'Unknown'}</div>
                        <div style="color: #555; font-size: 0.95em; line-height: 1.4;">
                            <span style="font-weight: 600; color: #333;">${entry.itemName}</span>
                            ${entry.itemNumber ? `<span style="color: #3498db; margin-left: 10px;">(${entry.itemNumber})</span>` : ''}
                        </div>
                        ${changesHtml}
                    </div>
                `;
            }).join('');
        }

        // Filter modal history
        function filterModalHistory() {
            const filter = document.getElementById('modalHistoryFilter').value;
            renderModalHistory(filter);
        }

        // Export to Excel function
        function exportToExcel() {
            try {
                // Create a new workbook
                const workbook = XLSX.utils.book_new();
                
                // Prepare inventory data
                const inventoryData = inventory.map((item, index) => {
                    const purchaseDate = new Date(item.purchaseDate);
                    const soldDate = item.soldDate ? new Date(item.soldDate) : '';
                    const daysInStock = Math.floor((soldDate ? soldDate : new Date() - purchaseDate) / (1000 * 60 * 60 * 24));
                    const profit = item.soldPrice - item.purchasePrice;
                    
                    return {
                        'Item Number': item.itemNumber || 'N/A',
                        'Item Name': item.name,
                        'Purchase Date': purchaseDate.toLocaleDateString(),
                        'Purchase Price': `£${(item.purchasePrice || 0).toFixed(2)}`,
                        'Status': item.status === 'ready' ? 'Ready to Sell' : 
                                item.status === 'needs-work' ? 'Needs Work' : 'Sold',
                        'Sold Date': soldDate ? soldDate.toLocaleDateString() : 'Not Sold',
                        'Sold Price': (item.soldPrice || 0) > 0 ? `£${(item.soldPrice || 0).toFixed(2)}` : 'Not Sold',
                        'Profit': (item.soldPrice || 0) > 0 ? `£${((item.soldPrice || 0) - (item.purchasePrice || 0)).toFixed(2)}` : 'N/A',
                        'Days in Stock': daysInStock,
                        'Description': item.description || '',
                        'Work Notes': item.workNotes || '',
                        'Photos Count': (item.photos ? item.photos.length : 0),
                        'Work Photos Count': (item.workPhotos ? item.workPhotos.length : 0)
                    };
                });
                
                // Create inventory worksheet
                const inventorySheet = XLSX.utils.json_to_sheet(inventoryData);
                XLSX.utils.book_append_sheet(workbook, inventorySheet, 'Inventory');
                
                // Prepare transaction data
                const transactionData = transactions.map(t => ({
                    'Date': new Date(t.date).toLocaleDateString(),
                    'Description': t.description,
                    'Type': t.type === 'income' ? 'Income' : 'Expense',
                    'Amount': `£${(t.amount || 0).toFixed(2)}`,
                    'Added By': currentUser ? currentUser.charAt(0).toUpperCase() + currentUser.slice(1) : 'Unknown'
                }));
                
                // Create transactions worksheet
                if (transactionData.length > 0) {
                    const transactionSheet = XLSX.utils.json_to_sheet(transactionData);
                    XLSX.utils.book_append_sheet(workbook, transactionSheet, 'Transactions');
                }
                
                // Prepare edit history data
                const historyData = editHistory.map(entry => ({
                    'Date': new Date(entry.timestamp).toLocaleDateString(),
                    'Time': new Date(entry.timestamp).toLocaleTimeString(),
                    'User': entry.user ? entry.user.charAt(0).toUpperCase() + entry.user.slice(1) : 'Unknown',
                    'Action': entry.action === 'add' ? 'Item Added' :
                             entry.action === 'edit' ? 'Item Edited' :
                             entry.action === 'delete' ? 'Item Deleted' :
                             entry.action === 'status' ? 'Status Changed' : entry.action,
                    'Item Name': entry.itemName,
                    'Item Number': entry.itemNumber || 'N/A',
                    'Changes': entry.changes ? entry.changes.map(c => `${c.field}: ${c.oldValue || 'N/A'} → ${c.newValue || 'N/A'}`).join('; ') : 'N/A'
                }));
                
                // Create history worksheet
                if (historyData.length > 0) {
                    const historySheet = XLSX.utils.json_to_sheet(historyData);
                    XLSX.utils.book_append_sheet(workbook, historySheet, 'Edit History');
                }
                
                // Prepare summary statistics
                let moneyIn = 0, moneyOut = 0, totalItems = inventory.length;
                let readyItems = 0, needsWorkItems = 0, soldItems = 0;
                
                inventory.forEach(item => {
                    // Include purchase price in balance if affectBalance is true or undefined (existing items default to true)
                    if (item.affectBalance === true || item.affectBalance === undefined) {
                        moneyOut += item.purchasePrice;
                    }
                    // Sold items are NOT automatically added to balance - they must be manually added through transactions
                    
                    if (item.status === 'sold') soldItems++;
                    else if (item.status === 'ready') readyItems++;
                    else if (item.status === 'needs-work') needsWorkItems++;
                });
                
                let additionalIncome = 0, additionalExpenses = 0;
                transactions.forEach(t => {
                    if (t.type === 'income') additionalIncome += t.amount;
                    else additionalExpenses += t.amount;
                });
                
                // Calculate profit only from sold items
                let soldItemsCost = 0;
                let soldItemsRevenue = 0;
                inventory.forEach(item => {
                    if (item.status === 'sold' && item.soldPrice > 0) {
                        // Always include revenue and cost for sold items in profit calculation
                            soldItemsRevenue += item.soldPrice;
                            soldItemsCost += item.purchasePrice;
                    }
                });
                const totalProfit = soldItemsRevenue - soldItemsCost;
                const totalBalance = moneyIn - moneyOut + additionalIncome - additionalExpenses;
                
                const summaryData = [
                    { 'Metric': 'Total Items', 'Value': totalItems },
                    { 'Metric': 'Ready to Sell', 'Value': readyItems },
                    { 'Metric': 'Needs Work', 'Value': needsWorkItems },
                    { 'Metric': 'Sold Items', 'Value': soldItems },
                    { 'Metric': 'Total Money In (Sales)', 'Value': `£${(moneyIn || 0).toFixed(2)}` },
                    { 'Metric': 'Total Money Out (Purchases)', 'Value': `£${(moneyOut || 0).toFixed(2)}` },
                    { 'Metric': 'Additional Income', 'Value': `£${(additionalIncome || 0).toFixed(2)}` },
                    { 'Metric': 'Additional Expenses', 'Value': `£${(additionalExpenses || 0).toFixed(2)}` },
                    { 'Metric': 'Total Profit', 'Value': `£${(totalProfit || 0).toFixed(2)}` },
                    { 'Metric': 'Current Balance', 'Value': `£${(totalBalance || 0).toFixed(2)}` },
                    { 'Metric': 'Export Date', 'Value': new Date().toLocaleString() },
                    { 'Metric': 'Exported By', 'Value': currentUser ? currentUser.charAt(0).toUpperCase() + currentUser.slice(1) : 'Unknown' }
                ];
                
                // Create summary worksheet
                const summarySheet = XLSX.utils.json_to_sheet(summaryData);
                XLSX.utils.book_append_sheet(workbook, summarySheet, 'Summary');
                
                // Generate filename with current date
                const currentDate = new Date().toISOString().split('T')[0];
                const filename = `Furniture_Inventory_${currentDate}.xlsx`;
                
                // Save the file
                XLSX.writeFile(workbook, filename);
                
                // Show success message
                alert(`Excel file "${filename}" has been downloaded successfully!`);
                
            } catch (error) {
                console.error('Error exporting to Excel:', error);
                alert('Error exporting to Excel. Please try again.');
            }
        }

        // Initialize variables first
        let inventory = [];
        let editingIndex = -1;
        let currentFullViewItemNumber = null;
        let transactions = [];
        let currentPhotoIndex = 0;
        let currentItemPhotos = [];
        let editHistory = [];

        // Initialize authentication on page load
        checkAuth();

        // Generate random item number
        function generateItemNumber() {
            const prefix = 'FUR';
            const randomNum = Math.floor(100000 + Math.random() * 900000);
            return `${prefix}-${randomNum}`;
        }

        // History management functions
        function addHistoryEntry(action, itemName, itemNumber, changes = null, oldItem = null) {
            // Ensure we have valid values
            const safeItemName = itemName || 'Unknown Item';
            const safeItemNumber = itemNumber || 'N/A';
            const safeUser = currentUser || 'Unknown User';
            
            const historyEntry = {
                id: Date.now(),
                timestamp: new Date().toISOString(),
                user: safeUser,
                action: action,
                itemName: safeItemName,
                itemNumber: safeItemNumber,
                changes: changes,
                oldItem: oldItem
            };
            
            editHistory.unshift(historyEntry); // Add to beginning
            saveHistory(); // Keep as non-async for now to avoid breaking other calls
            
            // Update history display if we're on the history tab
            if (document.getElementById('history').classList.contains('active')) {
                renderHistory();
            }
        }

        // Save history to Supabase
        async function saveHistory() {
            try {
                // Convert history to database format with validation
                const historyToSave = editHistory.map(entry => ({
                    action: entry.action || 'unknown',
                    item_name: entry.itemName || 'Unknown Item',
                    item_number: entry.itemNumber || 'N/A',
                    changes: entry.changes ? JSON.stringify(entry.changes) : null,
                    old_values: entry.oldValues ? JSON.stringify(entry.oldValues) : null,
                    user_name: entry.user || currentUser || 'Unknown User'
                })).filter(entry => entry.item_name !== 'Unknown Item' || entry.action !== 'unknown');

                // Clear existing data and insert new data
                const { error: deleteError } = await supabase
                    .from('edit_history')
                    .delete()
                    .neq('id', 0); // Delete all records

                if (deleteError) {
                    console.error('Error clearing history:', deleteError);
                }

                if (historyToSave.length > 0) {
                    const { error: insertError } = await supabase
                        .from('edit_history')
                        .insert(historyToSave);

                    if (insertError) {
                        console.error('Error saving history:', insertError);
                        console.error('History data that failed:', historyToSave);
                        console.error('Error details:', {
                            message: insertError.message,
                            details: insertError.details,
                            hint: insertError.hint,
                            code: insertError.code
                        });
                    } else {
                        console.log('✅ History saved successfully');
                    }
                }
            } catch (error) {
                console.error('Error saving history:', error);
            }
        }

        // Load history from Supabase
        async function loadHistory() {
            try {
                const { data: historyData, error: historyError } = await supabase
                    .from('edit_history')
                    .select('*')
                    .order('timestamp', { ascending: false });

                if (historyError) {
                    console.error('Error loading history:', historyError);
                    editHistory = [];
                } else {
                    editHistory = historyData || [];
                }
            } catch (error) {
                console.error('Error loading history:', error);
                editHistory = [];
            }
        }

        function clearHistory() {
            if (confirm('Are you sure you want to clear all edit history? This cannot be undone.')) {
                editHistory = [];
                saveHistory(); // Keep as non-async for now
                renderHistory();
            }
        }

        function filterHistory() {
            const filter = document.getElementById('historyFilter').value;
            renderHistory(filter);
        }

        function renderHistory(filter = 'all') {
            const historyList = document.getElementById('historyList');
            
            if (editHistory.length === 0) {
                historyList.innerHTML = `
                    <div class="empty-history">
                        <h3>No edit history yet</h3>
                        <p>Changes to inventory items will be tracked here</p>
                    </div>
                `;
                return;
            }

            let filteredHistory = editHistory;
            if (filter !== 'all') {
                filteredHistory = editHistory.filter(entry => entry.action === filter);
            }

            historyList.innerHTML = filteredHistory.map(entry => {
                const date = new Date(entry.timestamp);
                const timeString = date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
                
                let actionText = '';
                let actionIcon = '';
                
                switch (entry.action) {
                    case 'add':
                        actionText = 'Item Added';
                        actionIcon = '[+]';
                        break;
                    case 'edit':
                        actionText = 'Item Edited';
                        actionIcon = '[Edit]';
                        break;
                    case 'delete':
                        actionText = 'Item Deleted';
                        actionIcon = '[Delete]';
                        break;
                    case 'status':
                        actionText = 'Status Changed';
                        actionIcon = '[Status]';
                        break;
                    case 'balance_transaction':
                        actionText = 'Balance Transaction Added';
                        actionIcon = '[Balance+]';
                        break;
                    case 'balance_transaction_delete':
                        actionText = 'Balance Transaction Deleted';
                        actionIcon = '[Balance-]';
                        break;
                }

                let changesHtml = '';
                if (entry.changes && entry.changes.length > 0) {
                    changesHtml = `
                        <div class="history-changes">
                            <strong>Changes made:</strong>
                            ${entry.changes.map(change => `
                                <div class="change-item">
                                    <strong>${change.field}:</strong>
                                    ${change.oldValue ? `<span class="change-old">${change.oldValue}</span>` : ''}
                                    ${change.oldValue && change.newValue ? ' → ' : ''}
                                    ${change.newValue ? `<span class="change-new">${change.newValue}</span>` : ''}
                                </div>
                            `).join('')}
                        </div>
                    `;
                }

                return `
                    <div class="history-entry ${entry.action}">
                        <div class="history-header">
                            <div class="history-action">${actionIcon} ${actionText}</div>
                            <div class="history-timestamp">${timeString}</div>
                        </div>
                        <div class="history-user">👤 ${entry.user ? entry.user.charAt(0).toUpperCase() + entry.user.slice(1) : 'Unknown'}</div>
                        <div class="history-details">
                            <span class="history-item-name">${entry.itemName}</span>
                            ${entry.itemNumber ? `<span style="color: #3498db; margin-left: 10px;">(${entry.itemNumber})</span>` : ''}
                        </div>
                        ${changesHtml}
                    </div>
                `;
            }).join('');
        }

        function detectChanges(oldItem, newItem) {
            const changes = [];
            
            const fields = ['name', 'purchaseDate', 'purchasePrice', 'soldDate', 'soldPrice', 'status', 'description', 'workNotes'];
            
            fields.forEach(field => {
                const oldValue = oldItem[field];
                const newValue = newItem[field];
                
                if (oldValue !== newValue) {
                    let displayOldValue = oldValue;
                    let displayNewValue = newValue;
                    
                    // Format values for display
                    if (field === 'purchaseDate' || field === 'soldDate') {
                        displayOldValue = oldValue ? new Date(oldValue).toLocaleDateString() : 'Not set';
                        displayNewValue = newValue ? new Date(newValue).toLocaleDateString() : 'Not set';
                    } else if (field === 'purchasePrice' || field === 'soldPrice') {
                        displayOldValue = oldValue ? `£${parseFloat(oldValue).toFixed(2)}` : 'Not set';
                        displayNewValue = newValue ? `£${parseFloat(newValue).toFixed(2)}` : 'Not set';
                    } else if (field === 'status') {
                        const statusMap = {
                            'ready': 'Ready to Sell',
                            'needs-work': 'Needs Work',
                            'sold': 'Sold'
                        };
                        displayOldValue = statusMap[oldValue] || oldValue;
                        displayNewValue = statusMap[newValue] || newValue;
                    }
                    
                    changes.push({
                        field: field.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase()),
                        oldValue: displayOldValue,
                        newValue: displayNewValue
                    });
                }
            });
            
            return changes;
        }

        // Load inventory from localStorage
        // Load inventory from Supabase
        async function loadInventory() {
            try {
                console.log('🔄 Loading inventory from Supabase...');
                
                // Load inventory items
                const { data: inventoryData, error: inventoryError } = await supabase
                    .from('inventory')
                    .select('*')
                    .order('created_at', { ascending: false });

                console.log('📦 Supabase inventory response:', { data: inventoryData, error: inventoryError });

                if (inventoryError) {
                    console.error('❌ Error loading inventory:', inventoryError);
                    console.error('❌ Inventory error details:', {
                        message: inventoryError.message,
                        details: inventoryError.details,
                        hint: inventoryError.hint,
                        code: inventoryError.code
                    });
                    
                    // Check if it's a table doesn't exist error
                    if (inventoryError.code === 'PGRST116' || inventoryError.message.includes('relation "inventory" does not exist')) {
                        console.log('🔧 Inventory table does not exist. Creating fallback...');
                        inventory = [];
                        // Try to create a simple test item to see if we can insert
                        await testInventoryInsert();
                    } else {
                        inventory = [];
                    }
                } else {
                    inventory = inventoryData || [];
                    console.log('✅ Loaded inventory items:', inventory.length);
                    
                    // Convert database field names to app field names
                    inventory.forEach(item => {
                        // Convert item_number to itemNumber
                        if (item.item_number && !item.itemNumber) {
                            item.itemNumber = item.item_number;
                        }
                        // Convert other database fields if needed
                        if (item.purchase_date && !item.purchaseDate) {
                            item.purchaseDate = item.purchase_date;
                        }
                        if (item.purchase_price !== undefined && item.purchasePrice === undefined) {
                            item.purchasePrice = item.purchase_price;
                        }
                        if (item.sold_date && !item.soldDate) {
                            item.soldDate = item.sold_date;
                        }
                        if (item.sold_price !== undefined && item.soldPrice === undefined) {
                            item.soldPrice = item.sold_price;
                        }
                        if (item.work_notes && !item.workNotes) {
                            item.workNotes = item.work_notes;
                        }
                        if (item.work_photos && !item.workPhotos) {
                            item.workPhotos = item.work_photos;
                        }
                        if (item.affect_balance !== undefined && item.affectBalance === undefined) {
                            item.affectBalance = item.affect_balance;
                        }
                        if (item.add_to_balance !== undefined && item.addToBalance === undefined) {
                            item.addToBalance = item.add_to_balance;
                        }
                    });
                    
                    // Assign item numbers to existing items that don't have one
                    let needsSave = false;
                    inventory.forEach(item => {
                        if (!item.itemNumber) {
                            item.itemNumber = generateItemNumber();
                            needsSave = true;
                        }
                    });
                    if (needsSave) {
                        console.log('💾 Saving inventory with new item numbers...');
                        await saveInventory();
                    }
                }
                
                // Load transactions
                console.log('💰 Loading transactions from Supabase...');
                const { data: transactionsData, error: transactionsError } = await supabase
                    .from('transactions')
                    .select('*')
                    .order('created_at', { ascending: false });

                console.log('💳 Supabase transactions response:', { data: transactionsData, error: transactionsError });

                if (transactionsError) {
                    console.error('❌ Error loading transactions:', transactionsError);
                    transactions = [];
                } else {
                    transactions = transactionsData || [];
                    console.log('✅ Loaded transactions:', transactions.length);
                }
                
                // Load history
                console.log('📚 Loading history from Supabase...');
                await loadHistory();
                
                // Update UI
                renderInventory();
                updateStatistics();
                console.log('🎨 UI updated with loaded data');
                
            } catch (error) {
                console.error('❌ Error loading data:', error);
                inventory = [];
                transactions = [];
                renderInventory();
                updateStatistics();
            }
        }

        // Save inventory to Supabase
        async function saveInventory() {
            try {
                console.log('🔄 Saving inventory to Supabase...', inventory.length, 'items');
                console.log('📊 Inventory data:', inventory);
                
                // Check for any invalid items
                inventory.forEach((item, index) => {
                    if (!item || !item.name || !item.purchaseDate || isNaN(item.purchasePrice)) {
                        console.error(`❌ Invalid item at index ${index}:`, item);
                        console.error(`❌ This item will be skipped during save`);
                    }
                });
                
                // Filter out any undefined/null items before saving
                const validInventory = inventory.filter(item => 
                    item && item.name && item.purchaseDate && !isNaN(item.purchasePrice)
                );
                
                if (validInventory.length !== inventory.length) {
                    console.log(`⚠️ Filtered out ${inventory.length - validInventory.length} invalid items`);
                    inventory = validInventory; // Update the main array
                }
                
                // Convert inventory to database format
                const inventoryToSave = inventory.map(item => ({
                    item_number: item.itemNumber,
                    name: item.name,
                    purchase_date: item.purchaseDate,
                    purchase_price: item.purchasePrice,
                    sold_date: item.soldDate || null,
                    sold_price: item.soldPrice || null,
                    status: item.status,
                    description: item.description || '',
                    work_notes: item.workNotes || '',
                    affect_balance: item.affectBalance !== false,
                    add_to_balance: item.addToBalance !== false,
                    photos: item.photos || [],
                    work_photos: item.workPhotos || []
                }));

                console.log('💾 Inventory to save:', inventoryToSave);

                // Clear existing data and insert new data
                const { error: deleteError } = await supabase
                    .from('inventory')
                    .delete()
                    .neq('id', 0); // Delete all records

                console.log('🗑️ Delete result:', deleteError);

                if (deleteError) {
                    console.error('❌ Error clearing inventory:', deleteError);
                    return; // Don't try to insert if delete failed
                }

                if (inventoryToSave.length > 0) {
                    const { data: insertData, error: insertError } = await supabase
                        .from('inventory')
                        .insert(inventoryToSave)
                        .select();

                    console.log('💾 Insert result:', { data: insertData, error: insertError });

                    if (insertError) {
                        console.error('❌ Error saving inventory:', insertError);
                        console.error('❌ Insert error details:', {
                            message: insertError.message,
                            details: insertError.details,
                            hint: insertError.hint,
                            code: insertError.code
                        });
                    } else {
                        console.log('✅ Successfully saved inventory to Supabase');
                        console.log('✅ Inserted items:', insertData?.length || 0);
                    }
                } else {
                    console.log('ℹ️ No inventory items to save');
                }
            } catch (error) {
                console.error('❌ Error saving inventory:', error);
            }
        }

        // Save transactions to Supabase
        async function saveTransactions() {
            try {
                // Convert transactions to database format
                const transactionsToSave = transactions.map(transaction => ({
                    description: transaction.description,
                    amount: transaction.amount,
                    type: transaction.type,
                    date: transaction.date
                }));

                // Clear existing data and insert new data
                const { error: deleteError } = await supabase
                    .from('transactions')
                    .delete()
                    .neq('id', 0); // Delete all records

                if (deleteError) {
                    console.error('Error clearing transactions:', deleteError);
                }

                if (transactionsToSave.length > 0) {
                    const { error: insertError } = await supabase
                        .from('transactions')
                        .insert(transactionsToSave);

                    if (insertError) {
                        console.error('Error saving transactions:', insertError);
                    }
                }
            } catch (error) {
                console.error('Error saving transactions:', error);
            }
        }

        // Switch between tabs
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
            
            if (tabName === 'statistics') {
                updateStatistics();
            } else if (tabName === 'history') {
                renderHistory();
            }
        }

        // Add new item
        function addItem() {
            const name = document.getElementById('itemName').value;
            const purchaseDate = document.getElementById('purchaseDate').value;
            const purchasePrice = parseFloat(document.getElementById('purchasePrice').value);
            const affectBalance = document.getElementById('affectBalance').value;
            const status = document.getElementById('itemStatus').value;
            const description = document.getElementById('itemDescription').value;
            const workNotes = document.getElementById('itemWorkNotes').value;
            const photoInput = document.getElementById('itemPhoto');
            const workPhotoInput = document.getElementById('workPhotos');

            if (!name || !purchaseDate || isNaN(purchasePrice)) {
                alert('Please fill in all required fields (Name, Purchase Date, Purchase Price)');
                return;
            }

            const item = {
                id: Date.now(),
                itemNumber: generateItemNumber(),
                name,
                purchaseDate,
                purchasePrice,
                affectBalance: affectBalance === 'yes',
                status,
                description,
                workNotes: workNotes || '',
                soldDate: '',
                soldPrice: 0,
                photos: [],
                workPhotos: []
            };

            let photosLoaded = false;
            let workPhotosLoaded = false;

            // Function to check if all photos are loaded
            const checkAllLoaded = () => {
                if (photosLoaded && workPhotosLoaded) {
                    inventory.push(item);
                    saveInventory(); // Keep as non-async for now
                    
                    // Add to history
                    addHistoryEntry('add', item.name, item.itemNumber);
                    
                    renderInventory();
                    clearForm();
                }
            };

            // Handle main image uploads
            if (photoInput.files && photoInput.files.length > 0) {
                let loadedCount = 0;
                const totalFiles = photoInput.files.length;
                
                for (let i = 0; i < totalFiles; i++) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        item.photos.push(e.target.result);
                        loadedCount++;
                        
                        if (loadedCount === totalFiles) {
                            photosLoaded = true;
                            checkAllLoaded();
                        }
                    };
                    reader.readAsDataURL(photoInput.files[i]);
                }
            } else {
                photosLoaded = true;
            }

            // Handle work photo uploads
            if (workPhotoInput.files && workPhotoInput.files.length > 0) {
                let loadedCount = 0;
                const totalFiles = workPhotoInput.files.length;
                
                for (let i = 0; i < totalFiles; i++) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        item.workPhotos.push(e.target.result);
                        loadedCount++;
                        
                        if (loadedCount === totalFiles) {
                            workPhotosLoaded = true;
                            checkAllLoaded();
                        }
                    };
                    reader.readAsDataURL(workPhotoInput.files[i]);
                }
            } else {
                workPhotosLoaded = true;
            }

            // Check if we can proceed immediately
            checkAllLoaded();
        }

        // Clear form
        function clearForm() {
            document.getElementById('itemName').value = '';
            document.getElementById('purchaseDate').value = '';
            document.getElementById('purchasePrice').value = '';
            document.getElementById('affectBalance').value = 'yes';
            document.getElementById('itemStatus').value = 'ready';
            document.getElementById('itemDescription').value = '';
            document.getElementById('itemWorkNotes').value = '';
            document.getElementById('itemPhoto').value = '';
            document.getElementById('workPhotos').value = '';
            
            // Switch to inventory tab to show the new item
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.querySelector('.tab[onclick*="inventory"]').classList.add('active');
            document.getElementById('inventory').classList.add('active');
        }

        // Render inventory
        function renderInventory() {
            const inventoryList = document.getElementById('inventoryList');
            const needsWorkList = document.getElementById('needsWorkList');
            const soldList = document.getElementById('soldList');
            
            // Separate items by status
            const readyItems = inventory.filter(item => item.status === 'ready');
            const needsWorkItems = inventory.filter(item => item.status === 'needs-work');
            const soldItems = inventory.filter(item => item.status === 'sold');
            
            // Render ready to sell inventory
            if (readyItems.length === 0) {
                inventoryList.innerHTML = `
                    <div class="empty-state">
                        <h3>No items ready to sell</h3>
                        <p>Items marked as "Ready to Sell" will appear here!</p>
                    </div>
                `;
            } else {
                inventoryList.innerHTML = '<div class="inventory-list">' +
                    readyItems.map((item, idx) => {
                        const index = inventory.indexOf(item);
                        return renderItemList(item, index);
                    }).join('') +
                    '</div>';
            }
            
            // Render needs work items
            if (needsWorkItems.length === 0) {
                needsWorkList.innerHTML = `
                    <div class="empty-state">
                        <h3>No items need work</h3>
                        <p>Items marked as "Needs Work" will appear here!</p>
                    </div>
                `;
            } else {
                needsWorkList.innerHTML = `
                    <div style="background: #e8f4fd; border: 1px solid #b3d9ff; border-radius: 8px; padding: 15px; margin-bottom: 20px; text-align: center;">
                        <div style="color: #0066cc; font-weight: 600; margin-bottom: 5px;">📋 Job Queue</div>
                        <div style="color: #666; font-size: 0.9em;">Hover over items to see ↑↓ buttons for reordering (1 = highest priority)</div>
                    </div>
                    <div class="inventory-list">` +
                    needsWorkItems.map((item, idx) => {
                        const index = inventory.indexOf(item);
                        return renderItemList(item, index, true); // Make reorderable
                    }).join('') +
                    '</div>';
            }
            
            // Render sold items
            if (soldItems.length === 0) {
                soldList.innerHTML = `
                    <div class="empty-state">
                        <h3>No sold items yet</h3>
                        <p>Items marked as sold will appear here!</p>
                    </div>
                `;
            } else {
                soldList.innerHTML = '<div class="inventory-list">' +
                    soldItems.map((item, idx) => {
                        const index = inventory.indexOf(item);
                        return renderItemList(item, index);
                    }).join('') +
                    '</div>';
            }
        }

        // Render individual item card
        // Render item in list view (compact)
        function renderItemList(item, index, isDraggable = false) {
            const photos = item.photos && item.photos.length > 0 ? item.photos : 
                          (item.photo ? [item.photo] : []);
            
            const statusClass = item.status === 'sold' ? 'status-sold' : 
                               item.status === 'ready' ? 'status-ready' : 'status-needs-work';
            const statusText = item.status === 'sold' ? 'Sold' : 
                              item.status === 'ready' ? 'Ready' : 'Needs Work';
            
            const currentPrice = item.soldPrice > 0 ? item.soldPrice : item.purchasePrice;
            const priceLabel = item.soldPrice > 0 ? 'Sold for' : 'Purchase Price';
            
            // Add reorder buttons for "Not Ready" items
            const reorderButtons = isDraggable ? `
                <div class="reorder-buttons">
                    <button onclick="moveItemUp(${index}); event.stopPropagation();" class="reorder-btn up-btn" title="Move Up">↑</button>
                    <button onclick="moveItemDown(${index}); event.stopPropagation();" class="reorder-btn down-btn" title="Move Down">↓</button>
                </div>
            ` : '';
            
            const itemClass = isDraggable ? 'inventory-list-item reorderable-item' : 'inventory-list-item';
            
            return `
                <div class="${itemClass}" style="
                    display: flex;
                    align-items: center;
                    padding: 15px;
                    background: white;
                    border-radius: 8px;
                    margin-bottom: 10px;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                    cursor: pointer;
                    transition: all 0.3s ease;
                    border-left: 4px solid ${item.status === 'ready' ? '#28a745' : item.status === 'sold' ? '#6c757d' : '#ffc107'};
                    position: relative;
                " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.15)'" 
                   onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)'">
                    
                    <!-- Priority Indicator (for reorderable items) -->
                    ${isDraggable ? `<div class="priority-indicator">${index + 1}</div>` : ''}
                    
                    <!-- Reorder Buttons (for reorderable items) -->
                    ${reorderButtons}
                    
                    <!-- Photo (Clickable) -->
                    <div onclick="openFullViewModal(${index}); event.stopPropagation();" style="width: 80px; height: 80px; margin-right: 15px; flex-shrink: 0; cursor: pointer;">
                        ${photos.length > 0 ? `
                            <img src="${photos[0]}" alt="${item.name}" style="
                                width: 100%;
                                height: 100%;
                                object-fit: cover;
                                border-radius: 6px;
                                border: 2px solid #e9ecef;
                            ">
                        ` : `
                            <div style="
                                width: 100%;
                                height: 100%;
                                background: #f8f9fa;
                                border-radius: 6px;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                color: #6c757d;
                                font-size: 1.5em;
                                border: 2px solid #e9ecef;
                            ">📷</div>
                        `}
                    </div>
                    
                    <!-- Item Details -->
                    <div style="flex: 1; min-width: 0;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 5px;">
                            <h3 style="margin: 0; font-size: 1.2em; color: #333; font-weight: 600;">${item.name}</h3>
                            <span class="status-badge ${statusClass}" style="
                                padding: 4px 8px;
                                border-radius: 12px;
                                font-size: 0.8em;
                                font-weight: 600;
                                text-transform: uppercase;
                            ">${statusText}</span>
                        </div>
                        
                        <div style="color: #666; font-size: 0.9em; margin-bottom: 5px;">
                            <strong>Item #:</strong> ${item.itemNumber || 'N/A'}
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div style="color: #666; font-size: 0.9em;">
                                <strong>${priceLabel}:</strong> £${(currentPrice || 0).toFixed(2)}
                            </div>
                            <div style="color: #666; font-size: 0.8em;">
                                ${new Date(item.purchaseDate).toLocaleDateString()}
                            </div>
                        </div>
                        
                        ${item.description ? `
                            <div style="color: #666; font-size: 0.85em; margin-top: 5px; 
                                        overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                ${item.description}
                            </div>
                        ` : ''}
                    </div>
                    
                    <!-- Click indicator -->
                    <div style="margin-left: 10px; color: #6c757d; font-size: 1.2em;">
                        →
                    </div>
                </div>
            `;
        }

        function renderItemCard(item, index) {
            const statusClass = item.status === 'sold' ? 'status-sold' : 
                               item.status === 'ready' ? 'status-ready' : 'status-needs-work';
            const statusText = item.status === 'sold' ? 'Sold' : 
                              item.status === 'ready' ? 'Ready to Sell' : 'Needs Work';
            
            const profit = item.soldPrice - item.purchasePrice;
            
            // Calculate days in stock
            const purchaseDate = new Date(item.purchaseDate);
            const endDate = item.soldDate ? new Date(item.soldDate) : new Date();
            const daysInStock = Math.floor((endDate - purchaseDate) / (1000 * 60 * 60 * 24));
            
            // Handle both old single photo format and new photos array
            const photos = item.photos && item.photos.length > 0 ? item.photos : 
                          (item.photo ? [item.photo] : []);
            
            return `
                <div class="inventory-card">
                            ${photos.length > 0 ? `
                                <div class="photo-gallery" onclick="openPhotoModal(${index}, 0)">
                                    <img src="${photos[0]}" alt="${item.name}">
                                    ${photos.length > 1 ? `<div class="photo-counter">${photos.length} Photos</div>` : ''}
                                </div>
                            ` : `<div class="item-image" style="display: flex; align-items: center; justify-content: center; font-size: 3em; color: #bdc3c7;">No Image</div>`}
                            <div class="item-details">
                                <div class="item-name">${item.name}</div>
                                <div class="item-info" style="color: #3498db; font-weight: 600; margin-bottom: 10px;">Item: ${item.itemNumber || 'N/A'}</div>
                                <div class="item-info"><strong>Purchased:</strong> ${new Date(item.purchaseDate).toLocaleDateString()} - £${(item.purchasePrice || 0).toFixed(2)}</div>
                                <div class="item-info" style="background: ${item.soldDate ? '#f0f0f0' : '#fff3cd'}; padding: 8px; border-radius: 6px; margin: 8px 0;">
                                    <strong>Days in Stock:</strong> <span style="font-weight: 700; color: ${daysInStock > 90 ? '#e74c3c' : daysInStock > 30 ? '#f39c12' : '#27ae60'};">${daysInStock} days</span>
                                </div>
                                ${item.soldDate ? `
                                    <div class="item-info"><strong>Sold:</strong> ${new Date(item.soldDate).toLocaleDateString()} - £${(item.soldPrice || 0).toFixed(2)}</div>
                                    <div style="background: ${profit >= 0 ? '#d4edda' : '#f8d7da'}; padding: 12px; border-radius: 8px; margin: 10px 0; border-left: 4px solid ${profit >= 0 ? '#28a745' : '#dc3545'};">
                                        <div style="font-size: 0.9em; color: #666; margin-bottom: 4px;">Total Profit</div>
                                        <div style="font-size: 1.5em; font-weight: 700; color: ${profit >= 0 ? '#28a745' : '#dc3545'};">£${(profit || 0).toFixed(2)}</div>
                                    </div>
                                ` : ''}
                                ${item.description ? `<div class="item-info" style="margin-top: 10px;">${item.description}</div>` : ''}
                                ${(item.workPhotos && item.workPhotos.length > 0) || item.workNotes ? `
                                    <div class="work-notes-box">
                                        <strong>Work Required:</strong>
                                        ${item.workPhotos && item.workPhotos.length > 0 ? `
                                            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 8px; margin-top: 10px;">
                                                ${item.workPhotos.map((photo, photoIdx) => `
                                                    <div style="position: relative; cursor: pointer;" onclick="openWorkPhotoModal(${index}, ${photoIdx})">
                                                        <img src="${photo}" style="width: 100%; height: 80px; object-fit: cover; border-radius: 6px; border: 2px solid #ffc107;">
                                                    </div>
                                                `).join('')}
                                            </div>
                                            <div style="font-size: 0.85em; color: #856404; margin-top: 8px;">
                                                ${item.workPhotos.length} photo${item.workPhotos.length > 1 ? 's' : ''} showing work needed
                                            </div>
                                        ` : ''}
                                        ${item.workNotes ? `<p style="margin-top: 8px;">${item.workNotes}</p>` : ''}
                                    </div>
                                ` : ''}
                                <div class="status-badge ${statusClass}">${statusText}</div>
                                <div class="item-actions">
                                    <button class="btn btn-warning" onclick="editItem(${index})">Edit</button>
                                    <button class="btn btn-danger" onclick="deleteItem(${index})">Delete</button>
                                </div>
                            </div>
                        </div>
            `;
        }

        // Edit item
        function editItem(index) {
            console.log('editItem called with index:', index);
            editingIndex = index;
            const item = inventory[index];
            
            console.log('Editing item:', item.name);
            
            document.getElementById('editItemNumber').value = item.itemNumber || 'N/A';
            document.getElementById('editItemName').value = item.name;
            document.getElementById('editPurchaseDate').value = item.purchaseDate;
            document.getElementById('editPurchasePrice').value = item.purchasePrice;
            document.getElementById('editAffectBalance').value = (item.affectBalance === true || item.affectBalance === undefined) ? 'yes' : 'no';
            document.getElementById('editSoldDate').value = item.soldDate || '';
            document.getElementById('editSoldPrice').value = item.soldPrice || '';
            document.getElementById('editAddToBalance').value = (item.addToBalance === true || item.addToBalance === undefined) ? 'yes' : 'no';
            document.getElementById('editItemStatus').value = item.status;
            document.getElementById('editItemDescription').value = item.description || '';
            document.getElementById('editItemWorkNotes').value = item.workNotes || '';
            
            // Display existing main photos
            displayEditMainPhotos();
            
            // Display existing work photos
            displayEditWorkPhotos();
            
            document.getElementById('editModal').classList.add('active');
        }

        // Display main photos in edit modal
        function displayEditMainPhotos() {
            if (editingIndex === -1) return;
            
            const item = inventory[editingIndex];
            const previewDiv = document.getElementById('editMainPhotosPreview');
            
            if (!item.photos || item.photos.length === 0) {
                previewDiv.innerHTML = '';
                return;
            }
            
            previewDiv.innerHTML = item.photos.map((photo, index) => `
                <div style="position: relative;">
                    <img src="${photo}" style="width: 100%; height: 100px; object-fit: cover; border-radius: 6px; border: 2px solid #667eea;">
                    <button onclick="removeEditMainPhoto(${index})" style="position: absolute; top: 5px; right: 5px; background: #dc3545; color: white; border: none; border-radius: 50%; width: 20px; height: 20px; font-size: 12px; cursor: pointer;">×</button>
                </div>
            `).join('');
        }

        // Remove main photo from edit
        function removeEditMainPhoto(index) {
            if (editingIndex === -1) return;
            
            const item = inventory[editingIndex];
            item.photos.splice(index, 1);
            displayEditMainPhotos();
        }

        // Display work photos in edit modal
        function displayEditWorkPhotos() {
            const item = inventory[editingIndex];
            const previewDiv = document.getElementById('editWorkPhotosPreview');
            
            if (!item.workPhotos || item.workPhotos.length === 0) {
                previewDiv.innerHTML = '';
                return;
            }
            
            previewDiv.innerHTML = item.workPhotos.map((photo, idx) => `
                <div style="position: relative;">
                    <img src="${photo}" style="width: 100%; height: 100px; object-fit: cover; border-radius: 6px; border: 2px solid #ffc107;">
                    <button onclick="deleteWorkPhoto(${idx}); event.stopPropagation();" 
                            style="position: absolute; top: 5px; right: 5px; background: #dc3545; color: white; border: none; border-radius: 50%; width: 25px; height: 25px; cursor: pointer; font-size: 14px; line-height: 1;">
                        ×
                    </button>
                </div>
            `).join('');
        }

        // Delete work photo
        function deleteWorkPhoto(photoIndex) {
            if (confirm('Delete this work photo?')) {
                const item = inventory[editingIndex];
                item.workPhotos.splice(photoIndex, 1);
                displayEditWorkPhotos();
                saveInventory(); // Keep as non-async for now
            }
        }

        // Save edit
        function saveEdit() {
            console.log('💾 saveEdit called, editingIndex:', editingIndex);
            alert('💾 saveEdit called, editingIndex: ' + editingIndex); // Mobile debug
            if (editingIndex === -1) {
                console.log('❌ No item being edited');
                alert('❌ No item being edited'); // Mobile debug
                return;
            }
            
            const oldItem = {...inventory[editingIndex]}; // Create a copy of the old item
            const item = inventory[editingIndex];
            
            console.log('📝 Original item:', oldItem);
            console.log('📝 Inventory before edit:', inventory.length, 'items');
            alert('📝 Inventory before edit: ' + inventory.length + ' items'); // Mobile debug
            
            // Get form values with mobile-safe parsing
            const nameEl = document.getElementById('editItemName');
            const purchaseDateEl = document.getElementById('editPurchaseDate');
            const purchasePriceEl = document.getElementById('editPurchasePrice');
            const affectBalanceEl = document.getElementById('editAffectBalance');
            const soldDateEl = document.getElementById('editSoldDate');
            const soldPriceEl = document.getElementById('editSoldPrice');
            const addToBalanceEl = document.getElementById('editAddToBalance');
            const statusEl = document.getElementById('editItemStatus');
            const descriptionEl = document.getElementById('editItemDescription');
            const workNotesEl = document.getElementById('editItemWorkNotes');
            
            console.log('📱 Form elements found:', {
                name: !!nameEl,
                purchaseDate: !!purchaseDateEl,
                purchasePrice: !!purchasePriceEl,
                affectBalance: !!affectBalanceEl,
                soldDate: !!soldDateEl,
                soldPrice: !!soldPriceEl,
                addToBalance: !!addToBalanceEl,
                status: !!statusEl,
                description: !!descriptionEl,
                workNotes: !!workNotesEl
            });
            
            const formData = {
                name: nameEl?.value || '',
                purchaseDate: purchaseDateEl?.value || '',
                purchasePrice: parseFloat(purchasePriceEl?.value || '0'),
                affectBalance: affectBalanceEl?.value === 'yes',
                soldDate: soldDateEl?.value || '',
                soldPrice: parseFloat(soldPriceEl?.value || '0') || 0,
                addToBalance: addToBalanceEl?.value === 'yes',
                status: statusEl?.value || 'ready',
                description: descriptionEl?.value || '',
                workNotes: workNotesEl?.value || ''
            };
            
            console.log('📋 Form data:', formData);
            
            // Update item with form data
            item.name = formData.name;
            item.purchaseDate = formData.purchaseDate;
            item.purchasePrice = formData.purchasePrice;
            item.affectBalance = formData.affectBalance;
            item.soldDate = formData.soldDate;
            item.soldPrice = formData.soldPrice;
            item.addToBalance = formData.addToBalance;
            item.status = formData.status;
            item.description = formData.description;
            item.workNotes = formData.workNotes;
            
            // Auto-set status to sold if sold date and price are provided
            if (item.soldDate && item.soldPrice > 0) {
                item.status = 'sold';
                console.log('🔄 Auto-set status to sold');
            }
            
            console.log('📝 Updated item:', item);
            
            // Detect changes and add to history
            const changes = detectChanges(oldItem, item);
            if (changes.length > 0) {
                console.log('📊 Changes detected:', changes);
                const action = changes.some(c => c.field === 'Status') ? 'status' : 'edit';
                addHistoryEntry(action, item.name, item.itemNumber, changes, oldItem);
            } else {
                console.log('ℹ️ No changes detected');
            }
            
            // Handle new main photos
            const mainPhotoInput = document.getElementById('editMainPhotos');
            console.log('📸 Main photos input:', mainPhotoInput.files?.length || 0, 'files');
            
            let mainPhotosLoaded = false;
            let workPhotosLoaded = false;
            
            // Function to check if all photos are loaded
            const checkAllPhotosLoaded = () => {
                if (mainPhotosLoaded && workPhotosLoaded) {
                    console.log('💾 All photos loaded, saving inventory...');
                    console.log('📝 Final inventory before save:', inventory.length, 'items');
                    alert('💾 Saving inventory with ' + inventory.length + ' items'); // Mobile debug
                    saveInventory(); // Keep as non-async for now
                    renderInventory();
                    closeEditModal();
                }
            };
            
            // Handle main photos
            if (mainPhotoInput.files && mainPhotoInput.files.length > 0) {
                console.log('📸 Processing main photos...');
                let loadedCount = 0;
                const totalFiles = mainPhotoInput.files.length;
                
                // Initialize photos array if it doesn't exist
                if (!item.photos) {
                    item.photos = [];
                }
                
                for (let i = 0; i < totalFiles; i++) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        item.photos.push(e.target.result);
                        loadedCount++;
                        
                        console.log(`📸 Main photo ${loadedCount}/${totalFiles} loaded`);
                        
                        if (loadedCount === totalFiles) {
                            mainPhotosLoaded = true;
                            checkAllPhotosLoaded();
                        }
                    };
                    reader.readAsDataURL(mainPhotoInput.files[i]);
                }
            } else {
                mainPhotosLoaded = true;
                checkAllPhotosLoaded();
            }
            
            // Handle new work photos
            const workPhotoInput = document.getElementById('editWorkPhotos');
            console.log('📸 Work photos input:', workPhotoInput.files?.length || 0, 'files');
            
            if (workPhotoInput.files && workPhotoInput.files.length > 0) {
                console.log('📸 Processing work photos...');
                let loadedCount = 0;
                const totalFiles = workPhotoInput.files.length;
                
                // Initialize workPhotos array if it doesn't exist
                if (!item.workPhotos) {
                    item.workPhotos = [];
                }
                
                for (let i = 0; i < totalFiles; i++) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        item.workPhotos.push(e.target.result);
                        loadedCount++;
                        
                        console.log(`📸 Photo ${loadedCount}/${totalFiles} loaded`);
                        
                        if (loadedCount === totalFiles) {
                            workPhotosLoaded = true;
                            checkAllPhotosLoaded();
                        }
                    };
                    reader.readAsDataURL(workPhotoInput.files[i]);
                }
            } else {
                workPhotosLoaded = true;
                checkAllPhotosLoaded();
            }
        }

        // Reorder Functions
        function moveItemUp(index) {
            console.log('⬆️ Moving item up:', index);
            console.log('⬆️ Current inventory length:', inventory.length);
            console.log('⬆️ Item at index:', inventory[index]);
            
            // Validate the item exists and is needs-work
            if (!inventory[index] || inventory[index].status !== 'needs-work') {
                console.log('❌ Invalid item for move up:', inventory[index]);
                return;
            }
            
            // Get all needs-work items and their indices
            const needsWorkIndices = [];
            inventory.forEach((item, idx) => {
                if (item && item.status === 'needs-work') {
                    needsWorkIndices.push(idx);
                }
            });
            
            console.log('⬆️ Needs-work indices:', needsWorkIndices);
            
            // Find current position in needs-work array
            const currentPosition = needsWorkIndices.indexOf(index);
            console.log('⬆️ Current position:', currentPosition);
            
            if (currentPosition > 0) {
                // Swap with item above
                const targetIndex = needsWorkIndices[currentPosition - 1];
                console.log('⬆️ Swapping with target index:', targetIndex);
                console.log('⬆️ Target item:', inventory[targetIndex]);
                
                // Perform the swap
                const temp = inventory[index];
                inventory[index] = inventory[targetIndex];
                inventory[targetIndex] = temp;
                
                console.log('⬆️ Swap completed. New items:');
                console.log('⬆️ Item at', index, ':', inventory[index]);
                console.log('⬆️ Item at', targetIndex, ':', inventory[targetIndex]);
                
                // Update UI immediately for better user experience
                renderInventory();
                
                // Save to database in background (non-blocking)
                setTimeout(() => {
                    saveInventory();
                }, 100);
                
                console.log('✅ Item moved up successfully');
            } else {
                console.log('ℹ️ Item is already at the top');
            }
        }
        
        function moveItemDown(index) {
            console.log('⬇️ Moving item down:', index);
            console.log('⬇️ Current inventory length:', inventory.length);
            console.log('⬇️ Item at index:', inventory[index]);
            
            // Validate the item exists and is needs-work
            if (!inventory[index] || inventory[index].status !== 'needs-work') {
                console.log('❌ Invalid item for move down:', inventory[index]);
                return;
            }
            
            // Get all needs-work items and their indices
            const needsWorkIndices = [];
            inventory.forEach((item, idx) => {
                if (item && item.status === 'needs-work') {
                    needsWorkIndices.push(idx);
                }
            });
            
            console.log('⬇️ Needs-work indices:', needsWorkIndices);
            
            // Find current position in needs-work array
            const currentPosition = needsWorkIndices.indexOf(index);
            console.log('⬇️ Current position:', currentPosition);
            
            if (currentPosition < needsWorkIndices.length - 1) {
                // Swap with item below
                const targetIndex = needsWorkIndices[currentPosition + 1];
                console.log('⬇️ Swapping with target index:', targetIndex);
                console.log('⬇️ Target item:', inventory[targetIndex]);
                
                // Perform the swap
                const temp = inventory[index];
                inventory[index] = inventory[targetIndex];
                inventory[targetIndex] = temp;
                
                console.log('⬇️ Swap completed. New items:');
                console.log('⬇️ Item at', index, ':', inventory[index]);
                console.log('⬇️ Item at', targetIndex, ':', inventory[targetIndex]);
                
                // Update UI immediately for better user experience
                renderInventory();
                
                // Save to database in background (non-blocking)
                setTimeout(() => {
                    saveInventory();
                }, 100);
                
                console.log('✅ Item moved down successfully');
            } else {
                console.log('ℹ️ Item is already at the bottom');
            }
        }

        // Open full view modal
        function openFullViewModal(index) {
            console.log('openFullViewModal called with index:', index);
            const item = inventory[index];
            currentFullViewItemNumber = item.itemNumber;
            
            console.log('Setting currentFullViewItemNumber to:', item.itemNumber);
            console.log('Item details:', { name: item.name, itemNumber: item.itemNumber, status: item.status });
            
            // Update modal header
            document.getElementById('fullViewItemName').textContent = item.name;
            
            // Calculate days in stock
            const purchaseDate = new Date(item.purchaseDate);
            const endDate = item.soldDate ? new Date(item.soldDate) : new Date();
            const daysInStock = Math.floor((endDate - purchaseDate) / (1000 * 60 * 60 * 24));
            
            // Handle photos
            const photos = item.photos && item.photos.length > 0 ? item.photos : 
                          (item.photo ? [item.photo] : []);
            
            const statusClass = item.status === 'sold' ? 'status-sold' : 
                               item.status === 'ready' ? 'status-ready' : 'status-needs-work';
            const statusText = item.status === 'sold' ? 'Sold' : 
                              item.status === 'ready' ? 'Ready to Sell' : 'Needs Work';
            
            const profit = item.soldPrice - item.purchasePrice;
            
            // Create full view content
            const content = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                    <!-- Left Column - Photos -->
                    <div>
                        <h3 style="margin-bottom: 15px;">Photos</h3>
                        ${photos.length > 0 ? `
                            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px;">
                                ${photos.map((photo, photoIdx) => `
                                    <div style="position: relative; cursor: pointer;" onclick="openPhotoModal(${index}, ${photoIdx})">
                                        <img src="${photo}" style="width: 100%; height: 120px; object-fit: cover; border-radius: 8px; border: 2px solid #e9ecef;">
                                        ${photos.length > 1 ? `<div style="position: absolute; top: 5px; right: 5px; background: rgba(0,0,0,0.7); color: white; padding: 2px 6px; border-radius: 10px; font-size: 0.8em;">${photoIdx + 1}</div>` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        ` : `
                            <div style="text-align: center; padding: 40px; background: #f8f9fa; border-radius: 8px; color: #6c757d;">
                                <div style="font-size: 3em; margin-bottom: 10px;">📷</div>
                                <div>No photos available</div>
                            </div>
                        `}
                        
                        ${item.workPhotos && item.workPhotos.length > 0 ? `
                            <h4 style="margin: 20px 0 10px 0;">Work Photos</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 8px;">
                                ${item.workPhotos.map((photo, photoIdx) => `
                                    <div style="position: relative; cursor: pointer;" onclick="openWorkPhotoModal(${index}, ${photoIdx})">
                                        <img src="${photo}" style="width: 100%; height: 100px; object-fit: cover; border-radius: 6px; border: 2px solid #ffc107;">
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                    
                    <!-- Right Column - Details -->
                    <div>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 style="margin: 0;">Item Information</h3>
                            <span class="status-badge ${statusClass}" style="
                                padding: 6px 12px;
                                border-radius: 15px;
                                font-size: 0.9em;
                                font-weight: 600;
                                text-transform: uppercase;
                            ">${statusText}</span>
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div>
                                    <strong>Item Number:</strong><br>
                                    <span style="color: #3498db; font-weight: 600;">${item.itemNumber || 'N/A'}</span>
                                </div>
                                <div>
                                    <strong>Purchase Date:</strong><br>
                                    ${new Date(item.purchaseDate).toLocaleDateString()}
                                </div>
                                <div>
                                    <strong>Purchase Price:</strong><br>
                                    <span style="font-weight: 600;">£${(item.purchasePrice || 0).toFixed(2)}</span>
                                </div>
                                <div>
                                    <strong>Days in Stock:</strong><br>
                                    <span style="font-weight: 700; color: ${daysInStock > 90 ? '#e74c3c' : daysInStock > 30 ? '#f39c12' : '#27ae60'};">${daysInStock} days</span>
                                </div>
                            </div>
                        </div>
                        
                        ${item.soldDate ? `
                            <div style="background: #e8f5e8; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                                <h4 style="margin-top: 0; color: #28a745;">Sale Information</h4>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                    <div>
                                        <strong>Sold Date:</strong><br>
                                        ${new Date(item.soldDate).toLocaleDateString()}
                                    </div>
                                    <div>
                                        <strong>Sold Price:</strong><br>
                                        <span style="font-weight: 600;">£${(item.soldPrice || 0).toFixed(2)}</span>
                                    </div>
                                </div>
                                <div style="background: ${profit >= 0 ? '#d4edda' : '#f8d7da'}; padding: 15px; border-radius: 6px; margin-top: 15px; border-left: 4px solid ${profit >= 0 ? '#28a745' : '#dc3545'};">
                                    <div style="font-size: 0.9em; color: #666; margin-bottom: 5px;">Total Profit</div>
                                    <div style="font-size: 1.8em; font-weight: 700; color: ${profit >= 0 ? '#28a745' : '#dc3545'};">£${(profit || 0).toFixed(2)}</div>
                                </div>
                            </div>
                        ` : ''}
                        
                        ${item.description ? `
                            <div style="margin-bottom: 20px;">
                                <h4>Description</h4>
                                <div style="background: white; padding: 15px; border-radius: 6px; border: 1px solid #e9ecef;">
                                    ${item.description}
                                </div>
                            </div>
                        ` : ''}
                        
                        ${item.workNotes ? `
                            <div style="margin-bottom: 20px;">
                                <h4>Work Notes</h4>
                                <div style="background: #fff3cd; padding: 15px; border-radius: 6px; border: 1px solid #ffeaa7;">
                                    ${item.workNotes}
                                </div>
                            </div>
                        ` : ''}
                        
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; font-size: 0.9em; color: #666;">
                            <div><strong>Affects Balance:</strong> ${item.affectBalance !== false ? 'Yes' : 'No'}</div>
                            <div><strong>Add to Balance:</strong> ${item.addToBalance !== false ? 'Yes' : 'No'}</div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('fullViewContent').innerHTML = content;
            document.getElementById('fullViewModal').classList.add('active');
        }

        // Close full view modal
        function closeEditModal() {
            document.getElementById('editModal').classList.remove('active');
            document.getElementById('editMainPhotos').value = '';
            document.getElementById('editWorkPhotos').value = '';
            editingIndex = -1;
        }

        function closeFullViewModal() {
            document.getElementById('fullViewModal').classList.remove('active');
            currentFullViewItemNumber = null; // Reset the itemNumber reference
        }

        // Edit item from full view
        function editFromFullView() {
            console.log('editFromFullView called, currentFullViewItemNumber:', currentFullViewItemNumber);
            if (currentFullViewItemNumber) {
                console.log('Finding index for itemNumber:', currentFullViewItemNumber);
                
                // Store the itemNumber before closing modal
                const itemNumberToFind = currentFullViewItemNumber;
                
                // Close modal but don't reset the itemNumber yet
                document.getElementById('fullViewModal').classList.remove('active');
                
                // Find the actual index in the inventory array using itemNumber
                const actualIndex = inventory.findIndex(item => item.itemNumber === itemNumberToFind);
                console.log('Actual inventory index:', actualIndex);
                
                if (actualIndex !== -1) {
                    editItem(actualIndex);
                } else {
                    console.error('Could not find item in inventory array');
                    console.log('Available items:', inventory.map(item => ({ name: item.name, itemNumber: item.itemNumber })));
                    console.log('Looking for itemNumber:', itemNumberToFind);
                    console.log('Full inventory:', inventory);
                    console.log('First item details:', inventory[0]);
                    console.log('First item itemNumber:', inventory[0]?.itemNumber);
                    console.log('First item item_number:', inventory[0]?.item_number);
                    
                    // Try alternative search methods
                    const altIndex1 = inventory.findIndex(item => item.itemNumber === itemNumberToFind);
                    const altIndex2 = inventory.findIndex(item => item.itemNumber == itemNumberToFind);
                    const altIndex3 = inventory.findIndex(item => String(item.itemNumber) === String(itemNumberToFind));
                    
                    console.log('Alternative searches:', { altIndex1, altIndex2, altIndex3 });
                    
                    if (altIndex1 !== -1) {
                        editItem(altIndex1);
                    } else if (altIndex2 !== -1) {
                        editItem(altIndex2);
                    } else if (altIndex3 !== -1) {
                        editItem(altIndex3);
                    } else {
                        alert('Error: Could not find item to edit');
                    }
                }
                
                // Reset after we're done
                currentFullViewItemNumber = null;
            } else {
                console.log('No item selected for editing');
            }
        }

        // Delete item from full view
        function deleteFromFullView() {
            console.log('deleteFromFullView called, currentFullViewItemNumber:', currentFullViewItemNumber);
            if (currentFullViewItemNumber) {
                // Store the itemNumber before closing modal
                const itemNumberToFind = currentFullViewItemNumber;
                
                // Close modal but don't reset the itemNumber yet
                document.getElementById('fullViewModal').classList.remove('active');
                
                // Find the actual index in the inventory array using itemNumber
                const actualIndex = inventory.findIndex(item => item.itemNumber === itemNumberToFind);
                console.log('Actual inventory index for deletion:', actualIndex);
                
                if (actualIndex !== -1) {
                    // Use the existing deleteItem function
                    deleteItem(actualIndex);
                } else {
                    console.error('Could not find item in inventory array for deletion');
                    console.log('Looking for itemNumber:', itemNumberToFind);
                    console.log('Available items:', inventory.map(item => ({ name: item.name, itemNumber: item.itemNumber })));
                    
                    // Try alternative search methods
                    const altIndex1 = inventory.findIndex(item => item.itemNumber === itemNumberToFind);
                    const altIndex2 = inventory.findIndex(item => item.itemNumber == itemNumberToFind);
                    const altIndex3 = inventory.findIndex(item => String(item.itemNumber) === String(itemNumberToFind));
                    
                    console.log('Alternative searches for deletion:', { altIndex1, altIndex2, altIndex3 });
                    
                    if (altIndex1 !== -1) {
                        deleteItem(altIndex1);
                    } else if (altIndex2 !== -1) {
                        deleteItem(altIndex2);
                    } else if (altIndex3 !== -1) {
                        deleteItem(altIndex3);
                    } else {
                        alert('Error: Could not find item to delete');
                    }
                }
                
                // Reset after we're done
                currentFullViewItemNumber = null;
            } else {
                console.log('No item selected for deletion');
            }
        }

        // Delete item
        function deleteItem(index) {
            if (confirm('Are you sure you want to delete this item?')) {
                const deletedItem = inventory[index];
                
                // Add to history before deleting
                addHistoryEntry('delete', deletedItem.name, deletedItem.itemNumber, null, deletedItem);
                
                inventory.splice(index, 1);
                console.log('Calling saveInventory after deletion...');
                saveInventory(); // Keep as non-async for now
                renderInventory();
                updateStatistics();
            }
        }

        // Update statistics
        function updateStatistics() {
            let moneyIn = 0;
            let moneyOut = 0;
            let totalItems = inventory.length;
            let readyItems = 0;
            let needsWorkItems = 0;
            let soldItems = 0;

            inventory.forEach(item => {
                if (item.affectBalance !== false) { // Default to true for existing items
                    moneyOut += (item.purchasePrice || 0);
                }
                // Sold items are NOT automatically added to balance - they must be manually added through transactions
                
                if (item.status === 'sold') soldItems++;
                else if (item.status === 'ready') readyItems++;
                else if (item.status === 'needs-work') needsWorkItems++;
            });

            // Calculate profit only from sold items
            let soldItemsCost = 0;
            let soldItemsRevenue = 0;
            inventory.forEach(item => {
                if (item.status === 'sold' && (item.soldPrice || 0) > 0) {
                    // Always include revenue and cost for sold items in profit calculation
                    soldItemsRevenue += (item.soldPrice || 0);
                    soldItemsCost += (item.purchasePrice || 0);
                }
            });
            const totalProfit = soldItemsRevenue - soldItemsCost;
            
            // Calculate balance including additional transactions
            let additionalIncome = 0;
            let additionalExpenses = 0;
            transactions.forEach(t => {
                if (t.type === 'income') {
                    additionalIncome += (t.amount || 0);
                } else {
                    additionalExpenses += (t.amount || 0);
                }
            });
            
            const totalBalance = moneyIn - moneyOut + additionalIncome - additionalExpenses;

            document.getElementById('totalBalance').textContent = '£' + totalBalance.toFixed(2);
            document.getElementById('moneyIn').textContent = '£' + moneyIn.toFixed(2);
            document.getElementById('moneyOut').textContent = '£' + moneyOut.toFixed(2);
            document.getElementById('totalProfit').textContent = '£' + totalProfit.toFixed(2);
            
            // Update balance breakdown
            document.getElementById('balanceMoneyIn').textContent = '£' + moneyIn.toFixed(2);
            document.getElementById('balanceMoneyOut').textContent = '-£' + moneyOut.toFixed(2);
            document.getElementById('balanceAdditionalIncome').textContent = '£' + additionalIncome.toFixed(2);
            document.getElementById('balanceAdditionalExpenses').textContent = '-£' + additionalExpenses.toFixed(2);
            document.getElementById('balanceTotal').textContent = '£' + totalBalance.toFixed(2);
            
            document.getElementById('totalItems').textContent = totalItems;
            document.getElementById('readyItems').textContent = readyItems;
            document.getElementById('needsWorkItems').textContent = needsWorkItems;
            document.getElementById('soldItems').textContent = soldItems;

            // Update tab counts
            document.getElementById('inventoryCount').textContent = readyItems;
            document.getElementById('needsworkCount').textContent = needsWorkItems;
            document.getElementById('soldCount').textContent = soldItems;

            // Calculate average days in stock and days to sell
            let totalDaysInStock = 0;
            let totalDaysToSell = 0;
            let unsoldItems = 0;
            
            inventory.forEach(item => {
                const purchaseDate = new Date(item.purchaseDate);
                const endDate = item.soldDate ? new Date(item.soldDate) : new Date();
                const daysInStock = Math.floor((endDate - purchaseDate) / (1000 * 60 * 60 * 24));
                
                totalDaysInStock += daysInStock;
                
                if (item.soldDate) {
                    totalDaysToSell += daysInStock;
                } else {
                    unsoldItems++;
                }
            });
            
            const avgDaysInStock = totalItems > 0 ? Math.round(totalDaysInStock / totalItems) : 0;
            const avgDaysToSell = soldItems > 0 ? Math.round(totalDaysToSell / soldItems) : 0;
            
            document.getElementById('avgDaysInStock').textContent = avgDaysInStock;
            document.getElementById('avgDaysToSell').textContent = soldItems > 0 ? avgDaysToSell : '-';

            // Calculate this month's sales
            updateMonthlyStats();
            
            // Draw sales chart
            drawSalesChart();
            
            // Generate monthly breakdown
            generateMonthlyBreakdown();

            // Update details table
            const tableBody = document.getElementById('detailsTableBody');
            if (inventory.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 40px; color: #999;">No transactions yet</td></tr>';
            } else {
                tableBody.innerHTML = inventory.map(item => {
                    const profit = item.soldPrice - item.purchasePrice;
                    const statusClass = item.status === 'sold' ? 'status-sold' : 
                                       item.status === 'ready' ? 'status-ready' : 'status-needs-work';
                    const statusText = item.status === 'sold' ? 'Sold' : 
                                      item.status === 'ready' ? 'Ready to Sell' : 'Needs Work';
                    
                    // Calculate days in stock
                    const purchaseDate = new Date(item.purchaseDate);
                    const endDate = item.soldDate ? new Date(item.soldDate) : new Date();
                    const daysInStock = Math.floor((endDate - purchaseDate) / (1000 * 60 * 60 * 24));
                    
                    return `
                        <tr>
                            <td style="color: #667eea; font-weight: 600;">${item.itemNumber || 'N/A'}</td>
                            <td><strong>${item.name}</strong></td>
                            <td>${new Date(item.purchaseDate).toLocaleDateString()}</td>
                            <td style="font-weight: 600; color: ${daysInStock > 90 ? '#dc3545' : daysInStock > 30 ? '#ffc107' : '#28a745'};">
                                ${daysInStock} days
                            </td>
                            <td>£${(item.purchasePrice || 0).toFixed(2)}</td>
                            <td>${item.soldDate ? new Date(item.soldDate).toLocaleDateString() : '-'}</td>
                            <td>${(item.soldPrice || 0) > 0 ? '£' + (item.soldPrice || 0).toFixed(2) : '-'}</td>
                            <td style="color: ${profit >= 0 && (item.soldPrice || 0) > 0 ? '#28a745' : profit < 0 ? '#dc3545' : '#666'}; font-weight: 700;">
                                ${(item.soldPrice || 0) > 0 ? '£' + (profit || 0).toFixed(2) : '-'}
                            </td>
                            <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        </tr>
                    `;
                }).join('');
            }
        }

        // Update monthly statistics
        function updateMonthlyStats() {
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();

            let monthSold = 0;
            let monthRevenue = 0;
            let monthCost = 0;

            inventory.forEach(item => {
                if (item.soldDate) {
                    const soldDate = new Date(item.soldDate);
                    if (soldDate.getMonth() === currentMonth && soldDate.getFullYear() === currentYear) {
                        monthSold++;
                        monthRevenue += item.soldPrice;
                        monthCost += item.purchasePrice;
                    }
                }
            });

            const monthProfit = monthRevenue - monthCost;

            document.getElementById('monthSoldItems').textContent = monthSold;
            document.getElementById('monthRevenue').textContent = '£' + monthRevenue.toFixed(2);
            document.getElementById('monthProfit').textContent = '£' + monthProfit.toFixed(2);
        }

        // Get monthly data for chart
        function getMonthlyData() {
            const monthlyData = {};
            
            inventory.forEach(item => {
                if (item.soldDate) {
                    const soldDate = new Date(item.soldDate);
                    const monthKey = soldDate.getFullYear() + '-' + String(soldDate.getMonth() + 1).padStart(2, '0');
                    
                    if (!monthlyData[monthKey]) {
                        monthlyData[monthKey] = {
                            revenue: 0,
                            cost: 0,
                            profit: 0,
                            itemsSold: 0,
                            items: []
                        };
                    }
                    
                    monthlyData[monthKey].revenue += (item.soldPrice || 0);
                    monthlyData[monthKey].cost += (item.purchasePrice || 0);
                    monthlyData[monthKey].profit += ((item.soldPrice || 0) - (item.purchasePrice || 0));
                    monthlyData[monthKey].itemsSold++;
                    monthlyData[monthKey].items.push(item);
                }
            });
            
            return monthlyData;
        }

        // Draw sales chart
        function drawSalesChart() {
            const canvas = document.getElementById('salesChart');
            const ctx = canvas.getContext('2d');
            
            // Set canvas size
            canvas.width = canvas.offsetWidth;
            canvas.height = 400;
            
            const monthlyData = getMonthlyData();
            const months = Object.keys(monthlyData).sort();
            
            if (months.length === 0) {
                ctx.fillStyle = '#999';
                ctx.font = '16px Segoe UI';
                ctx.textAlign = 'center';
                ctx.fillText('No sales data yet', canvas.width / 2, canvas.height / 2);
                return;
            }
            
            // Chart dimensions
            const padding = 60;
            const chartWidth = canvas.width - padding * 2;
            const chartHeight = canvas.height - padding * 2;
            
            // Find max value for scaling
            const maxRevenue = Math.max(...months.map(m => monthlyData[m].revenue));
            const maxValue = Math.max(maxRevenue, 100); // Minimum scale of 100
            
            // Draw axes
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(padding, padding);
            ctx.lineTo(padding, canvas.height - padding);
            ctx.lineTo(canvas.width - padding, canvas.height - padding);
            ctx.stroke();
            
            // Calculate bar width
            const barWidth = chartWidth / months.length * 0.6;
            const spacing = chartWidth / months.length;
            
            // Draw bars
            months.forEach((month, index) => {
                const data = monthlyData[month];
                const barHeight = (data.revenue / maxValue) * chartHeight;
                const x = padding + index * spacing + (spacing - barWidth) / 2;
                const y = canvas.height - padding - barHeight;
                
                // Revenue bar (blue)
                const gradient = ctx.createLinearGradient(x, y, x, canvas.height - padding);
                gradient.addColorStop(0, '#667eea');
                gradient.addColorStop(1, '#764ba2');
                ctx.fillStyle = gradient;
                ctx.fillRect(x, y, barWidth, barHeight);
                
                // Month label
                const [year, monthNum] = month.split('-');
                const date = new Date(year, parseInt(monthNum) - 1);
                const monthName = date.toLocaleDateString('en-US', { month: 'short', year: '2-digit' });
                
                ctx.fillStyle = '#333';
                ctx.font = 'bold 12px Segoe UI';
                ctx.textAlign = 'center';
                ctx.fillText(monthName, x + barWidth / 2, canvas.height - padding + 20);
                
                // Revenue value
                ctx.fillStyle = '#667eea';
                ctx.font = 'bold 14px Segoe UI';
                ctx.fillText('£' + data.revenue.toFixed(0), x + barWidth / 2, y - 10);
            });
            
            // Y-axis labels
            ctx.fillStyle = '#666';
            ctx.font = '12px Segoe UI';
            ctx.textAlign = 'right';
            for (let i = 0; i <= 5; i++) {
                const value = (maxValue / 5) * i;
                const y = canvas.height - padding - (chartHeight / 5) * i;
                ctx.fillText('£' + value.toFixed(0), padding - 10, y + 5);
                
                // Grid line
                ctx.strokeStyle = '#e0e0e0';
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(padding, y);
                ctx.lineTo(canvas.width - padding, y);
                ctx.stroke();
            }
            
            // Chart title
            ctx.fillStyle = '#333';
            ctx.font = 'bold 16px Segoe UI';
            ctx.textAlign = 'center';
            ctx.fillText('Monthly Revenue', canvas.width / 2, 30);
        }

        // Generate monthly breakdown
        function generateMonthlyBreakdown() {
            const monthlyData = getMonthlyData();
            const months = Object.keys(monthlyData).sort().reverse(); // Most recent first
            
            const breakdownDiv = document.getElementById('monthlyBreakdown');
            
            if (months.length === 0) {
                breakdownDiv.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;">No sales recorded yet</div>';
                return;
            }
            
            breakdownDiv.innerHTML = months.map(month => {
                const data = monthlyData[month];
                const [year, monthNum] = month.split('-');
                const date = new Date(year, parseInt(monthNum) - 1);
                const monthName = date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                
                return `
                    <div class="month-card" onclick="toggleMonth('${month}')">
                        <div class="month-header">
                            <div class="month-title">
                                <span class="expand-icon" id="icon-${month}">▼</span>
                                ${monthName}
                            </div>
                            <div class="month-stats">
                                <div><strong>${data.itemsSold}</strong> sold</div>
                                <div><strong style="color: #28a745;">£${(data.revenue || 0).toFixed(2)}</strong> revenue</div>
                                <div><strong style="color: ${(data.profit || 0) >= 0 ? '#667eea' : '#dc3545'};">£${(data.profit || 0).toFixed(2)}</strong> profit</div>
                            </div>
                        </div>
                        <div class="month-details" id="details-${month}">
                            <h4 style="margin-bottom: 15px;">Items Sold This Month:</h4>
                            <div class="month-items-list">
                                ${data.items.map(item => {
                                    const profit = (item.soldPrice || 0) - (item.purchasePrice || 0);
                                    return `
                                        <div class="month-item">
                                            <div>
                                                <strong>${item.name}</strong>
                                                <div style="color: #667eea; font-size: 0.9em;">${item.itemNumber}</div>
                                            </div>
                                            <div style="text-align: right;">
                                                <div>Sold: <strong>£${(item.soldPrice || 0).toFixed(2)}</strong></div>
                                                <div style="color: ${profit >= 0 ? '#28a745' : '#dc3545'}; font-weight: 600;">
                                                    Profit: £${(profit || 0).toFixed(2)}
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Toggle month details
        function toggleMonth(monthKey) {
            const details = document.getElementById('details-' + monthKey);
            const icon = document.getElementById('icon-' + monthKey);
            
            if (details.classList.contains('active')) {
                details.classList.remove('active');
                icon.classList.remove('rotated');
            } else {
                details.classList.add('active');
                icon.classList.add('rotated');
            }
        }

        // Open balance modal
        function openBalanceModal() {
            // Set today's date as default
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('transactionDate').value = today;
            
            renderTransactions();
            renderSoldItems();
            document.getElementById('balanceModal').classList.add('active');
        }

        // Close balance modal
        function closeBalanceModal() {
            document.getElementById('balanceModal').classList.remove('active');
            clearTransactionForm();
        }

        // Clear transaction form
        function clearTransactionForm() {
            document.getElementById('transactionDesc').value = '';
            document.getElementById('transactionAmount').value = '';
            document.getElementById('transactionType').value = 'expense';
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('transactionDate').value = today;
        }

        // Add transaction
        function addTransaction() {
            const desc = document.getElementById('transactionDesc').value;
            const amount = parseFloat(document.getElementById('transactionAmount').value);
            const type = document.getElementById('transactionType').value;
            const date = document.getElementById('transactionDate').value;

            if (!desc || isNaN(amount) || amount <= 0 || !date) {
                alert('Please fill in all fields with valid values');
                return;
            }

            const transaction = {
                id: Date.now(),
                description: desc,
                amount: amount,
                type: type,
                date: date
            };

            transactions.push(transaction);
            saveTransactions(); // Keep as non-async for now
            
            // Add to history
            addHistoryEntry('balance_transaction', desc, '', [
                { field: 'Type', oldValue: '', newValue: type === 'income' ? 'Income' : 'Expense' },
                { field: 'Amount', oldValue: '', newValue: `£${(amount || 0).toFixed(2)}` },
                { field: 'Date', oldValue: '', newValue: date }
            ]);
            
            renderTransactions();
            updateStatistics();
            clearTransactionForm();
        }

        // Add sold item to balance as income transaction
        function addSoldItemToBalance(itemName, amount, soldDate) {
            const transaction = {
                id: Date.now(),
                description: `Sale: ${itemName}`,
                amount: amount,
                type: 'income',
                date: soldDate
            };

            transactions.push(transaction);
            saveTransactions(); // Keep as non-async for now
            
            // Add to history
            addHistoryEntry('balance_transaction', `Sale: ${itemName}`, '', [
                { field: 'Type', oldValue: '', newValue: 'Income' },
                { field: 'Amount', oldValue: '', newValue: `£${(amount || 0).toFixed(2)}` },
                { field: 'Date', oldValue: '', newValue: soldDate },
                { field: 'Item', oldValue: '', newValue: itemName }
            ]);
            
            renderTransactions();
            renderSoldItems(); // Refresh the sold items list
            updateStatistics();
        }

        // Delete transaction
        function deleteTransaction(id) {
            if (confirm('Delete this transaction?')) {
                const transactionToDelete = transactions.find(t => t.id === id);
                transactions = transactions.filter(t => t.id !== id);
                saveTransactions(); // Keep as non-async for now
                
                // Add to history
                if (transactionToDelete) {
                    addHistoryEntry('balance_transaction_delete', transactionToDelete.description, '', [
                        { field: 'Type', oldValue: transactionToDelete.type === 'income' ? 'Income' : 'Expense', newValue: 'Deleted' },
                        { field: 'Amount', oldValue: `£${(transactionToDelete.amount || 0).toFixed(2)}`, newValue: 'Deleted' },
                        { field: 'Date', oldValue: transactionToDelete.date, newValue: 'Deleted' }
                    ]);
                }
                
                renderTransactions();
                updateStatistics();
            }
        }

        // Render transactions
        function renderTransactions() {
            const transactionList = document.getElementById('transactionList');
            
            if (transactions.length === 0) {
                transactionList.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;">No additional transactions yet</div>';
                return;
            }

            // Sort by date (most recent first)
            const sortedTransactions = [...transactions].sort((a, b) => new Date(b.date) - new Date(a.date));

            transactionList.innerHTML = sortedTransactions.map(t => {
                const isIncome = t.type === 'income';
                return `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; background: white; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid ${isIncome ? '#28a745' : '#dc3545'};">
                        <div>
                            <div style="font-weight: 600; color: #333;">${t.description}</div>
                            <div style="font-size: 0.9em; color: #666;">${new Date(t.date).toLocaleDateString()}</div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <div style="font-size: 1.2em; font-weight: 700; color: ${isIncome ? '#28a745' : '#dc3545'};">
                                ${isIncome ? '+' : '-'}£${(t.amount || 0).toFixed(2)}
                            </div>
                            <button onclick="deleteTransaction(${t.id})" style="padding: 6px 12px; background: #dc3545; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9em;">
                                Delete
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Render sold items that can be added to balance
        function renderSoldItems() {
            const soldItemsList = document.getElementById('soldItemsList');
            
            // Get sold items that haven't been added to balance yet
            const soldItems = inventory.filter(item => 
                item.status === 'sold' && 
                item.soldPrice > 0 && 
                !transactions.some(t => 
                    t.description.includes(item.name) && 
                    t.type === 'income' && 
                    t.amount === item.soldPrice
                )
            );
            
            if (soldItems.length === 0) {
                soldItemsList.innerHTML = '<div style="text-align: center; padding: 20px; color: #999;">No sold items to add to balance</div>';
                return;
            }

            soldItemsList.innerHTML = soldItems.map(item => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: white; border-radius: 6px; margin-bottom: 8px; border: 1px solid #ddd;">
                    <div>
                        <div style="font-weight: 600; color: #333;">${item.name}</div>
                        <div style="font-size: 0.9em; color: #666;">Sold: ${item.soldDate ? new Date(item.soldDate).toLocaleDateString() : 'Unknown'}</div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div style="font-size: 1.1em; font-weight: 700; color: #28a745;">
                            £${(item.soldPrice || 0).toFixed(2)}
                        </div>
                        <button onclick="addSoldItemToBalance('${item.name}', ${item.soldPrice}, '${item.soldDate || new Date().toISOString().split('T')[0]}')" 
                                style="padding: 6px 12px; background: #28a745; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9em;">
                            Add to Balance
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Photo modal functions
        function openPhotoModal(itemIndex, photoIndex) {
            const item = inventory[itemIndex];
            currentItemPhotos = item.photos && item.photos.length > 0 ? item.photos : 
                               (item.photo ? [item.photo] : []);
            
            if (currentItemPhotos.length === 0) return;
            
            currentPhotoIndex = photoIndex;
            displayPhoto();
            document.getElementById('photoModal').classList.add('active');
        }

        function openWorkPhotoModal(itemIndex, photoIndex) {
            const item = inventory[itemIndex];
            currentItemPhotos = item.workPhotos || [];
            
            if (currentItemPhotos.length === 0) return;
            
            currentPhotoIndex = photoIndex;
            displayPhoto();
            document.getElementById('photoModal').classList.add('active');
        }

        function closePhotoModal() {
            document.getElementById('photoModal').classList.remove('active');
            currentItemPhotos = [];
            currentPhotoIndex = 0;
        }

        function displayPhoto() {
            document.getElementById('photoModalImage').src = currentItemPhotos[currentPhotoIndex];
            document.getElementById('photoCounter').textContent = 
                `${currentPhotoIndex + 1} / ${currentItemPhotos.length}`;
            
            // Hide/show nav buttons
            const prevBtn = document.querySelector('.photo-nav.prev');
            const nextBtn = document.querySelector('.photo-nav.next');
            
            if (currentItemPhotos.length <= 1) {
                prevBtn.style.display = 'none';
                nextBtn.style.display = 'none';
            } else {
                prevBtn.style.display = 'block';
                nextBtn.style.display = 'block';
            }
        }

        function nextPhoto() {
            currentPhotoIndex = (currentPhotoIndex + 1) % currentItemPhotos.length;
            displayPhoto();
        }

        function prevPhoto() {
            currentPhotoIndex = (currentPhotoIndex - 1 + currentItemPhotos.length) % currentItemPhotos.length;
            displayPhoto();
        }

        // Close modal when clicking outside
        document.getElementById('editModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeEditModal();
            }
        });

        document.getElementById('fullViewModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeFullViewModal();
            }
        });

        document.getElementById('balanceModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeBalanceModal();
            }
        });

        document.getElementById('photoModal').addEventListener('click', function(e) {
            if (e.target === this || e.target.classList.contains('photo-close')) {
                closePhotoModal();
            }
        });

        // Keyboard navigation for photo modal and hidden history access
        document.addEventListener('keydown', function(e) {
            if (document.getElementById('photoModal').classList.contains('active')) {
                if (e.key === 'ArrowRight') nextPhoto();
                if (e.key === 'ArrowLeft') prevPhoto();
                if (e.key === 'Escape') closePhotoModal();
            }
            
            
            // Close history modal with Escape
            if (e.key === 'Escape') {
                const historyModal = document.getElementById('historyModal');
                if (historyModal && historyModal.style.display !== 'none') {
                    closeHiddenHistory();
                }
            }
        });

        // Note: loadInventory() is now called from showMainApp() after authentication

        // Delivery Form Functions
        function switchToDeliveryForm() {
            // Switch to the delivery form tab
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // Find and activate the delivery form tab button
            const tabs = document.querySelectorAll('.tab');
            for (let i = 0; i < tabs.length; i++) {
                if (tabs[i].textContent.includes('Delivery Form')) {
                    tabs[i].classList.add('active');
                    break;
                }
            }
            
            // Activate the delivery form tab content
            document.getElementById('deliveryform').classList.add('active');
        }

        function resetDeliveryForm() {
            document.getElementById('deliveryForm').reset();
            document.getElementById('deliveryDateDisplay').textContent = '';
            document.getElementById('completedFormView').style.display = 'none';
            document.getElementById('deliveryForm').style.display = 'block';
        }

        // Update delivery date display with day of week
        function updateDeliveryDateDisplay() {
            const dateInput = document.getElementById('deliveryDate');
            const displayDiv = document.getElementById('deliveryDateDisplay');
            
            if (dateInput.value) {
                const date = new Date(dateInput.value + 'T00:00:00');
                const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                const dayOfWeek = days[date.getDay()];
                const formattedDate = date.toLocaleDateString('en-GB', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
                displayDiv.textContent = formattedDate;
            } else {
                displayDiv.textContent = '';
            }
        }

        // Show completed form view
        function showCompletedForm(event) {
            event.preventDefault();
            
            // Get form values
            const jobNumber = document.getElementById('deliveryJobCode').value;
            const deliveryDateInput = document.getElementById('deliveryDate').value;
            const itemName = document.getElementById('deliveryItemName').value;
            const creatorName = currentUser ? currentUser.charAt(0).toUpperCase() + currentUser.slice(1) : 'Unknown';
            const soldOnCheckboxes = document.querySelectorAll('input[name="soldOn"]:checked');
            const soldOn = Array.from(soldOnCheckboxes).map(cb => cb.value).join(', ') || 'Not specified';
            const driverCollectCode = document.getElementById('driverCollectCode').checked ? 'Yes' : 'No';
            const driverPaymentItem = document.querySelector('input[name="driverPaymentItem"]:checked').value;
            const driverPaymentDelivery = document.querySelector('input[name="driverPaymentDelivery"]:checked').value;
            const specialComments = document.getElementById('deliverySpecialComments').value || 'None';
            const address = document.getElementById('deliveryAddress').value;
            
            // Validate required fields
            if (!jobNumber || !deliveryDateInput || !itemName || !address) {
                alert('Please fill in all required fields');
                return;
            }
            
            // Check if at least one "Sold On" checkbox is selected
            if (soldOnCheckboxes.length === 0) {
                alert('Please select at least one option for "Sold On"');
                return;
            }
            
            // Format delivery date with day of week
            const deliveryDate = new Date(deliveryDateInput + 'T00:00:00');
            const formattedDeliveryDate = deliveryDate.toLocaleDateString('en-GB', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            // Populate completed form view - optimized for mobile screenshots
            const completedContent = document.getElementById('completedFormContent');
            completedContent.innerHTML = `
                <div style="max-width: 100%; padding: 20px; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">
                    <h1 style="text-align: center; margin: 0 0 15px 0; font-size: 22px; color: #333; font-weight: bold;">DELIVERY FORM</h1>
                    <hr style="border: none; border-top: 2px solid #333; margin: 0 0 15px 0;">
                    <div style="font-size: 14px; line-height: 1.6;">
                        <div style="margin-bottom: 10px;"><strong>Job:</strong> ${jobNumber}</div>
                        <div style="margin-bottom: 10px;"><strong>Date:</strong> ${formattedDeliveryDate}</div>
                        <div style="margin-bottom: 10px;"><strong>Item Name:</strong> ${itemName}</div>
                        <div style="margin-bottom: 10px;"><strong>Created By:</strong> ${creatorName}</div>
                        <div style="margin-bottom: 10px;"><strong>Sold On:</strong> ${soldOn}</div>
                        <div style="margin-bottom: 10px;"><strong>Courier should get Collect Code:</strong> ${driverCollectCode}</div>
                        <div style="margin-bottom: 10px;"><strong>Courier should take Payment for Item:</strong> ${driverPaymentItem}</div>
                        <div style="margin-bottom: 10px;"><strong>Courier should take Payment for Delivery:</strong> ${driverPaymentDelivery}</div>
                        ${specialComments !== 'None' ? `<div style="margin-bottom: 10px;"><strong>Comments:</strong> ${specialComments.replace(/\n/g, ' ')}</div>` : ''}
                        <div style="margin-bottom: 10px;"><strong>Address:</strong> ${address.replace(/\n/g, ', ')}</div>
                    </div>
                </div>
            `;
            
            // Hide form and show completed view
            document.getElementById('deliveryForm').style.display = 'none';
            document.getElementById('completedFormView').style.display = 'block';
            
            // Scroll to top of completed view
            document.getElementById('completedFormView').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // Edit delivery form (go back to form)
        function editDeliveryForm() {
            document.getElementById('completedFormView').style.display = 'none';
            document.getElementById('deliveryForm').style.display = 'block';
            document.getElementById('deliveryForm').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // Download completed form as PDF (screenshot)
        async function downloadCompletedFormPDF() {
            const completedContent = document.getElementById('completedFormContent');
            
            try {
                const canvas = await html2canvas(completedContent, {
                    backgroundColor: '#ffffff',
                    scale: 2,
                    logging: false,
                    useCORS: true
                });
                
                canvas.toBlob(async function(blob) {
                    const jobNumber = document.getElementById('deliveryJobCode').value;
                    const today = new Date().toLocaleDateString('en-GB');
                    const filename = `photo_Delivery_Form_${jobNumber.replace(/[^a-zA-Z0-9]/g, '_')}_${today.replace(/\//g, '_')}.jpg`;
                    
                    // Try to use File System Access API to let user choose save location
                    if ('showSaveFilePicker' in window) {
                        try {
                            const fileHandle = await window.showSaveFilePicker({
                                suggestedName: filename,
                                types: [{
                                    description: 'JPEG Image',
                                    accept: {
                                        'image/jpeg': ['.jpg']
                                    }
                                }]
                            });
                            
                            const writable = await fileHandle.createWritable();
                            await writable.write(blob);
                            await writable.close();
                            
                            alert('Delivery form saved successfully to Photos!');
                        } catch (err) {
                            if (err.name !== 'AbortError') {
                                console.error('Error saving file:', err);
                                downloadFile(blob, filename);
                            }
                        }
                    } else {
                        downloadFile(blob, filename);
                    }
                }, 'image/jpeg', 0.95);
            } catch (error) {
                console.error('Error generating image:', error);
                alert('Error generating delivery form image. Please try again.');
            }
        }

        // Helper function for fallback download
        function downloadFile(blob, filename) {
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            alert('Delivery form JPEG downloaded successfully!');
        }

        function generateDeliveryPDF(event) {
            event.preventDefault();
            
            // Get form values
            const jobNumber = document.getElementById('deliveryJobCode').value;
            const soldOnCheckboxes = document.querySelectorAll('input[name="soldOn"]:checked');
            const soldOn = Array.from(soldOnCheckboxes).map(cb => cb.value).join(', ') || 'Not specified';
            const driverCollectCode = document.getElementById('driverCollectCode').checked ? 'Yes' : 'No';
            const driverPaymentItem = document.querySelector('input[name="driverPaymentItem"]:checked').value;
            const driverPaymentDelivery = document.querySelector('input[name="driverPaymentDelivery"]:checked').value;
            const specialComments = document.getElementById('deliverySpecialComments').value || 'None';
            const streetName = document.getElementById('deliveryStreetName').value;
            const county = document.getElementById('deliveryCounty').value;
            const postcode = document.getElementById('deliveryPostcode').value;
            
            // Validate required fields
            if (!jobNumber || !streetName || !county || !postcode) {
                alert('Please fill in all required fields (Job Number, Street Name, County, and Postcode)');
                return;
            }
            
            // Check if at least one "Sold On" checkbox is selected
            if (soldOnCheckboxes.length === 0) {
                alert('Please select at least one option for "Sold On"');
                return;
            }
            
            // Create formatted HTML content for the form
            const today = new Date().toLocaleDateString('en-GB');
            const previewDiv = document.getElementById('deliveryFormPreview');
            
            previewDiv.innerHTML = `
                <h1>DELIVERY FORM</h1>
                <hr>
                <div class="preview-field">
                    <span class="preview-label">Job Number:</span>
                    <span class="preview-value">${jobNumber}</span>
                </div>
                <div class="preview-field">
                    <span class="preview-label">Sold On:</span>
                    <span class="preview-value">${soldOn}</span>
                </div>
                <div class="preview-field">
                    <span class="preview-label">Driver to get collect code:</span>
                    <span class="preview-value">${driverCollectCode}</span>
                </div>
                <div class="preview-field">
                    <span class="preview-label">Driver should take payment for item:</span>
                    <span class="preview-value">${driverPaymentItem}</span>
                </div>
                <div class="preview-field">
                    <span class="preview-label">Driver should take payment for delivery:</span>
                    <span class="preview-value">${driverPaymentDelivery}</span>
                </div>
                <div class="preview-field">
                    <span class="preview-label">Special Comments:</span>
                    <span class="preview-value">${specialComments.replace(/\n/g, '<br>')}</span>
                </div>
                <div class="preview-field">
                    <span class="preview-label">Street Name:</span>
                    <span class="preview-value">${streetName}</span>
                </div>
                <div class="preview-field">
                    <span class="preview-label">County:</span>
                    <span class="preview-value">${county}</span>
                </div>
                <div class="preview-field">
                    <span class="preview-label">Postcode:</span>
                    <span class="preview-value">${postcode}</span>
                </div>
                <div class="preview-footer">
                    Generated on: ${today}
                </div>
            `;
            
            // Wait a moment for the DOM to update, then capture the image
            setTimeout(() => {
                html2canvas(previewDiv, {
                    backgroundColor: '#ffffff',
                    scale: 2, // Higher quality
                    logging: false,
                    useCORS: true
                }).then(canvas => {
                    // Convert canvas to JPEG and download
                    canvas.toBlob(async function(blob) {
                        const filename = `photo_Delivery_Form_${jobNumber.replace(/[^a-zA-Z0-9]/g, '_')}_${today.replace(/\//g, '_')}.jpg`;
                        
                        // Try to use File System Access API to let user choose save location
                        if ('showSaveFilePicker' in window) {
                            try {
                                const fileHandle = await window.showSaveFilePicker({
                                    suggestedName: filename,
                                    types: [{
                                        description: 'JPEG Image',
                                        accept: {
                                            'image/jpeg': ['.jpg']
                                        }
                                    }]
                                });
                                
                                const writable = await fileHandle.createWritable();
                                await writable.write(blob);
                                await writable.close();
                                
                                alert('Delivery form JPEG saved successfully!');
                            } catch (err) {
                                if (err.name !== 'AbortError') {
                                    console.error('Error saving file:', err);
                                    // Fallback to regular download
                                    downloadFile(blob, filename);
                                } else {
                                    // User cancelled the save dialog
                                    console.log('Save cancelled by user');
                                }
                            }
                        } else {
                            // Fallback for browsers that don't support File System Access API
                            downloadFile(blob, filename);
                        }
                    }, 'image/jpeg', 0.95); // 0.95 quality (95%)
                }).catch(error => {
                    console.error('Error generating image:', error);
                    alert('Error generating delivery form image. Please try again.');
                });
            }, 100);
        }
    </script>
</body>
</html>

